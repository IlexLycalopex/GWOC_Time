<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GWOC Timesheet System</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --ink:#0f1923; --deep:#1b2b3a; --mid:#2c4a63; --accent:#3d8bcd; --accent2:#e8a020;
  --cream:#f0f4f8; --milk:#f8fafc; --steam:#dde4ec; --chalk:#eaf0f6;
  --flag-red:#c0392b; --flag-green:#1a9a5a; --flag-amber:#d4820a;
  --text-dark:#0f1923; --text-mid:#3a5068; --text-light:#7a95aa;
  --border:rgba(44,74,99,0.15); --shadow:0 2px 14px rgba(15,25,35,0.09);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--milk);color:var(--text-dark);min-height:100vh;
  background-image:radial-gradient(ellipse at 8% 0%,rgba(61,139,205,0.07) 0%,transparent 55%),radial-gradient(ellipse at 92% 100%,rgba(232,160,32,0.05) 0%,transparent 55%)}

/* AUTH SCREEN */
#authScreen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.auth-box{background:white;border-radius:16px;box-shadow:0 4px 40px rgba(15,25,35,0.14);border:1px solid var(--border);padding:36px 40px;width:100%;max-width:420px}
.auth-logo{display:flex;align-items:center;gap:12px;margin-bottom:28px;justify-content:center}
.auth-logo h1{font-family:'Playfair Display',serif;font-size:1.4rem;color:var(--deep)}
.auth-logo span{font-size:0.65rem;color:var(--text-light);display:block;text-transform:uppercase;letter-spacing:0.1em}
.auth-box h2{font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--deep);margin-bottom:6px;text-align:center}
.auth-box p{font-size:0.83rem;color:var(--text-mid);margin-bottom:22px;text-align:center}
.auth-field{display:flex;flex-direction:column;gap:4px;margin-bottom:14px}
.auth-field label{font-size:0.7rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.07em}
.auth-field input{padding:10px 13px;border:1.5px solid var(--steam);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.9rem;color:var(--text-dark);background:var(--milk);transition:border-color 0.15s}
.auth-field input:focus{outline:none;border-color:var(--accent);background:white}
.auth-err{color:var(--flag-red);font-size:0.8rem;margin-bottom:10px;padding:8px 12px;background:rgba(192,57,43,0.07);border-radius:6px;display:none}
.auth-info{color:var(--flag-green);font-size:0.8rem;margin-bottom:10px;padding:8px 12px;background:rgba(26,154,90,0.07);border-radius:6px;display:none}

/* HEADER */
header{background:var(--ink);color:var(--cream);padding:0 28px;display:flex;align-items:stretch;box-shadow:0 2px 18px rgba(0,0,0,0.35);position:sticky;top:0;z-index:200}
.logo{display:flex;align-items:center;gap:12px;padding:13px 0;flex-shrink:0;text-decoration:none;color:inherit}
.swallow-icon{width:38px;height:38px;flex-shrink:0}
.logo-text h1{font-family:'Playfair Display',serif;font-size:1.25rem;letter-spacing:0.03em;color:var(--cream)}
.logo-text span{font-size:0.65rem;color:rgba(240,244,248,0.5);display:block;font-weight:400;letter-spacing:0.1em;text-transform:uppercase;margin-top:-1px}
nav{display:flex;align-items:stretch;margin-left:24px;flex:1;overflow-x:auto}
.nav-tab{display:flex;align-items:center;gap:6px;padding:0 16px;color:rgba(240,244,248,0.45);font-size:0.83rem;font-weight:500;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.15s;user-select:none;white-space:nowrap}
.nav-tab:hover{color:var(--cream);background:rgba(255,255,255,0.04)}
.nav-tab.active{color:var(--cream);border-bottom-color:var(--accent);background:rgba(255,255,255,0.04)}
.nav-tab.hidden{display:none}
.nav-badge{background:var(--accent);color:white;font-size:0.63rem;font-weight:700;padding:1px 6px;border-radius:20px;min-width:18px;text-align:center}
.header-user{display:flex;align-items:center;gap:10px;padding:0 4px;margin-left:auto;color:rgba(240,244,248,0.5);font-size:0.78rem}
.user-pill{display:flex;align-items:center;gap:7px}
.user-role-badge{font-size:0.6rem;font-weight:700;padding:2px 7px;border-radius:10px;text-transform:uppercase;letter-spacing:0.05em}
.role-admin{background:rgba(232,160,32,0.25);color:var(--accent2)}
.role-manager{background:rgba(61,139,205,0.25);color:#7ec8f5}
.role-staff{background:rgba(26,154,90,0.2);color:#4dcb8a}
.logout-btn{padding:5px 10px;font-size:0.75rem;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);border-radius:6px;color:rgba(240,244,248,0.55);cursor:pointer;transition:all 0.15s;font-family:'DM Sans',sans-serif}
.logout-btn:hover{background:rgba(255,255,255,0.12);color:var(--cream)}

/* LAYOUT */
main{max-width:1100px;margin:0 auto;padding:26px 20px}
.page{display:none}.page.active{display:block}

/* BUTTONS */
.btn{padding:8px 18px;border:none;border-radius:7px;font-family:'DM Sans',sans-serif;font-weight:500;font-size:0.84rem;cursor:pointer;transition:all 0.15s}
.btn-primary{background:var(--accent);color:white}.btn-primary:hover{background:#2d7ab8;transform:translateY(-1px)}
.btn-secondary{background:var(--accent2);color:white}.btn-secondary:hover{background:#c27010;transform:translateY(-1px)}
.btn-outline{background:transparent;color:var(--text-mid);border:1.5px solid var(--steam)}.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-danger-outline{background:transparent;color:var(--flag-red);border:1px solid rgba(192,57,43,0.35);padding:5px 11px;font-size:0.8rem}.btn-danger-outline:hover{background:rgba(192,57,43,0.07)}
.btn-red{background:var(--flag-red);color:white}.btn-red:hover{background:#a93226}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}

/* CARDS */
.card{background:white;border-radius:13px;box-shadow:var(--shadow);border:1px solid var(--border);overflow:hidden;margin-bottom:24px}
.card-header{background:var(--deep);color:var(--cream);padding:13px 22px;display:flex;align-items:center;gap:10px}
.card-header h2{font-family:'Playfair Display',serif;font-size:1rem;font-weight:600}
.card-body{padding:22px}

/* FORM */
.field-group{display:flex;flex-direction:column;gap:4px}
.field-group label{font-size:0.7rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.07em}
.field-group input,.field-group select,.field-group textarea{padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.88rem;color:var(--text-dark);background:var(--milk);transition:border-color 0.15s;-webkit-appearance:none;appearance:none}
.field-group input:focus,.field-group select:focus,.field-group textarea:focus{outline:none;border-color:var(--accent);background:white}
.field-group textarea{resize:vertical;min-height:70px}

/* SHIFTS TABLE */
.shifts-table{width:100%;border-collapse:collapse}
.shifts-table thead tr{background:var(--chalk);border-bottom:1.5px solid var(--steam)}
.shifts-table th{padding:8px 7px;font-size:0.66rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.06em;text-align:left}
.shift-row td{padding:7px 5px;border-bottom:1px solid var(--steam);vertical-align:middle}
.shift-row td select,.shift-row td input[type="date"]{padding:6px 7px;border:1.5px solid var(--steam);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:0.82rem;color:var(--text-dark);background:var(--milk);width:100%;-webkit-appearance:none;appearance:none;cursor:pointer}
.shift-row td select:focus,.shift-row td input:focus{outline:none;border-color:var(--accent);background:white}
.add-row-btn{display:flex;align-items:center;gap:6px;background:none;border:1.5px dashed var(--accent);color:var(--accent);padding:7px 15px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.84rem;font-weight:500;cursor:pointer;transition:all 0.15s;margin-top:10px}
.add-row-btn:hover{background:rgba(61,139,205,0.05)}
.del-row-btn{background:none;border:none;color:var(--text-light);cursor:pointer;font-size:1.05rem;padding:4px 7px;border-radius:4px;transition:color 0.12s;display:block;margin:0 auto}
.del-row-btn:hover{color:var(--flag-red)}

/* BREAK FLAGS */
.break-flag{display:inline-flex;align-items:center;gap:4px;padding:3px 7px;border-radius:4px;font-size:0.69rem;font-weight:600;white-space:nowrap}
.break-flag.ok{background:rgba(26,154,90,0.1);color:var(--flag-green);border:1px solid rgba(26,154,90,0.25)}
.break-flag.error{background:rgba(192,57,43,0.1);color:var(--flag-red);border:1px solid rgba(192,57,43,0.25)}
.break-flag.warn{background:rgba(212,130,10,0.1);color:var(--flag-amber);border:1px solid rgba(212,130,10,0.25)}
.hours-cell{font-weight:600;font-size:0.84rem;text-align:center}
.break-rule-note{background:var(--chalk);border-left:3px solid var(--accent);border-radius:0 7px 7px 0;padding:10px 14px;margin-top:12px;font-size:0.77rem;color:var(--text-mid);line-height:1.55}
.break-rule-note strong{color:var(--text-dark)}

/* RECORDS */
.rec-controls{padding:12px 22px;display:flex;gap:12px;align-items:center;background:var(--chalk);border-bottom:1px solid var(--border);flex-wrap:wrap}
.rec-controls input,.rec-controls select{padding:6px 10px;border:1.5px solid var(--steam);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:0.84rem;background:white;color:var(--text-dark);-webkit-appearance:none;appearance:none}
.rec-controls input:focus,.rec-controls select:focus{outline:none;border-color:var(--accent)}
.rec-controls label{font-size:0.69rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.06em}
table.rec-table{width:100%;border-collapse:collapse}
.rec-table thead{background:var(--ink);color:var(--cream)}
.rec-table th{padding:10px 12px;font-size:0.66rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;text-align:left}
.rec-table tbody tr{border-bottom:1px solid var(--steam);transition:background 0.1s}
.rec-table tbody tr:hover{background:var(--milk)}
.rec-table td{padding:9px 12px;font-size:0.84rem;vertical-align:middle}
.rec-table td:nth-child(1){font-weight:600;color:var(--deep)}
.empty-state{text-align:center;padding:42px 22px;color:var(--text-light)}
.empty-state .icon{font-size:2.2rem;margin-bottom:9px}
.empty-state p{font-size:0.88rem}
.summary-bar{padding:10px 22px;background:var(--chalk);border-top:1px solid var(--border);display:flex;gap:20px;font-size:0.8rem;color:var(--text-mid);flex-wrap:wrap}
.summary-bar strong{color:var(--text-dark)}
.form-actions{display:flex;gap:10px;margin-top:18px;justify-content:flex-end}

/* AMENDMENT BADGE */
.amended-badge{display:inline-flex;align-items:center;gap:4px;font-size:0.68rem;color:var(--flag-amber);border:1px solid rgba(212,130,10,0.3);background:rgba(212,130,10,0.07);padding:2px 7px;border-radius:4px;cursor:pointer}

/* ENTITY GRIDS */
.entity-add-form{display:flex;gap:11px;align-items:flex-end;padding-bottom:22px;margin-bottom:22px;border-bottom:1.5px solid var(--steam);flex-wrap:wrap}
.entity-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.entity-card{background:var(--chalk);border:1.5px solid var(--steam);border-radius:10px;padding:12px 14px;display:flex;align-items:center;gap:11px;transition:border-color 0.15s,box-shadow 0.15s}
.entity-card:hover{border-color:var(--accent);box-shadow:0 2px 10px rgba(61,139,205,0.1)}
.entity-avatar{width:38px;height:38px;flex-shrink:0;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:white}
.loc-icon{width:38px;height:38px;flex-shrink:0;border-radius:9px;background:var(--mid);display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.entity-info{flex:1;min-width:0}
.entity-name{font-weight:600;font-size:0.9rem;color:var(--deep);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.entity-sub{font-size:0.72rem;color:var(--text-light);margin-top:2px}
.entity-del{background:none;border:none;color:var(--text-light);cursor:pointer;font-size:0.95rem;padding:3px;border-radius:4px;transition:color 0.12s;flex-shrink:0}
.entity-del:hover{color:var(--flag-red)}

/* DASHBOARD */
.dash-filters{display:flex;gap:14px;align-items:flex-end;margin-bottom:22px;flex-wrap:wrap;padding:16px 20px;background:white;border-radius:13px;box-shadow:var(--shadow);border:1px solid var(--border)}
.dash-filters .field-group{min-width:130px}
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:22px}
.kpi-card{background:white;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--border);padding:16px 18px;display:flex;flex-direction:column;gap:4px}
.kpi-label{font-size:0.68rem;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:0.08em}
.kpi-value{font-size:1.6rem;font-weight:700;color:var(--deep);line-height:1.1;font-family:'Playfair Display',serif}
.kpi-sub{font-size:0.72rem;color:var(--text-mid)}
.kpi-card.accent{border-top:3px solid var(--accent)}
.kpi-card.amber{border-top:3px solid var(--accent2)}
.kpi-card.green{border-top:3px solid var(--flag-green)}
.kpi-card.red{border-top:3px solid var(--flag-red)}
.dash-cols{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
@media(max-width:700px){.dash-cols{grid-template-columns:1fr}}
.dash-card{background:white;border-radius:13px;box-shadow:var(--shadow);border:1px solid var(--border);overflow:hidden}
.dash-card-hdr{background:var(--deep);color:var(--cream);padding:12px 18px;display:flex;align-items:center;gap:8px;font-family:'Playfair Display',serif;font-size:0.92rem;font-weight:600}
.dash-card-body{padding:18px}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:9px}
.bar-label{font-size:0.8rem;color:var(--text-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:90px;max-width:120px}
.bar-track{flex:1;height:9px;background:var(--steam);border-radius:5px;overflow:hidden}
.bar-fill{height:100%;border-radius:5px;transition:width 0.5s ease}
.bar-val{font-size:0.78rem;font-weight:600;color:var(--text-mid);min-width:40px;text-align:right}
.dash-table{width:100%;border-collapse:collapse;font-size:0.82rem}
.dash-table th{padding:7px 10px;font-size:0.66rem;font-weight:600;text-transform:uppercase;letter-spacing:0.07em;color:var(--text-light);border-bottom:1.5px solid var(--steam);text-align:left}
.dash-table td{padding:8px 10px;border-bottom:1px solid var(--steam);vertical-align:middle}
.dash-table tr:last-child td{border-bottom:none}
.dash-table tr:hover td{background:var(--milk)}
.dash-table td:first-child{font-weight:600;color:var(--deep)}
.violation-item{display:flex;align-items:flex-start;gap:10px;padding:9px 0;border-bottom:1px solid var(--steam);font-size:0.82rem}
.violation-item:last-child{border-bottom:none}
.violation-dot{width:8px;height:8px;border-radius:50%;background:var(--flag-red);flex-shrink:0;margin-top:4px}

/* USERS / ADMIN */
.users-table{width:100%;border-collapse:collapse}
.users-table th{padding:9px 12px;font-size:0.66rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-light);border-bottom:1.5px solid var(--steam);text-align:left}
.users-table td{padding:10px 12px;font-size:0.84rem;border-bottom:1px solid var(--steam);vertical-align:middle}
.users-table tr:hover td{background:var(--milk)}
.role-select{padding:5px 8px;border:1.5px solid var(--steam);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:0.82rem;background:var(--milk);-webkit-appearance:none;appearance:none}

/* TOAST + MODAL */
.toast{position:fixed;bottom:22px;right:22px;background:var(--ink);color:var(--cream);padding:10px 17px;border-radius:8px;font-size:0.85rem;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,0.28);transform:translateY(70px);opacity:0;transition:all 0.3s ease;z-index:9999;max-width:320px}
.toast.show{transform:translateY(0);opacity:1}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:500}
.modal-overlay.open{display:flex}
.modal{background:white;border-radius:13px;padding:26px;max-width:420px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.25)}
.modal h3{font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:10px;color:var(--deep)}
.modal p{font-size:0.85rem;color:var(--text-mid);margin-bottom:18px;line-height:1.6}
.modal-actions{display:flex;gap:10px;justify-content:flex-end}

/* LOADING OVERLAY */
#loadingOverlay{position:fixed;inset:0;background:rgba(15,25,35,0.55);display:flex;align-items:center;justify-content:center;z-index:9998;display:none}
.spinner{width:44px;height:44px;border:4px solid rgba(255,255,255,0.2);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}

/* AUDIT LOG */
.audit-row{padding:10px 0;border-bottom:1px solid var(--steam);font-size:0.81rem}
.audit-row:last-child{border-bottom:none}
.audit-who{font-weight:600;color:var(--deep)}
.audit-meta{font-size:0.73rem;color:var(--text-light);margin-top:2px}
.audit-reason{font-size:0.78rem;color:var(--flag-amber);margin-top:3px;font-style:italic}

@media(max-width:720px){
  header{padding:0 12px;flex-wrap:wrap}
  nav{margin-left:0;order:3;width:100%;border-top:1px solid rgba(255,255,255,0.06)}
  .nav-tab{padding:0 11px;font-size:0.78rem}
  main{padding:14px 10px}
  .card-body{padding:14px}
  .kpi-row{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<!-- ==================== AUTH SCREEN ==================== -->
<div id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">
      <svg style="width:42px;height:42px" viewBox="0 0 80 60" fill="none">
        <path d="M40 28 C36 22,20 14,4 18 C12 20,18 24,20 30 C16 28,8 27,2 30 C10 32,16 34,18 40 C14 40,6 42,2 48 C12 44,22 40,28 36 C30 42,32 50,34 58 C36 50,38 40,40 34 C42 40,44 50,46 58 C48 50,50 42,52 36 C58 40,68 44,78 48 C74 42,66 40,62 40 C64 34,70 32,78 30 C72 27,64 28,60 30 C62 24,68 20,76 18 C60 14,44 22,40 28Z" fill="#3d8bcd"/>
        <circle cx="40" cy="26" r="3" fill="#e8a020"/>
      </svg>
      <div><h1>GWOC</h1><span>Timesheet System</span></div>
    </div>

    <!-- Sign In -->
    <div id="signInPanel">
      <h2>Sign In</h2>
      <p>Enter your email and password to continue.</p>
      <div class="auth-err" id="signInErr"></div>
      <div class="auth-info" id="signInInfo"></div>
      <div class="auth-field"><label>Email</label><input type="email" id="loginEmail" placeholder="you@example.com" autocomplete="email"></div>
      <div class="auth-field"><label>Password</label><input type="password" id="loginPw" placeholder="Your password" autocomplete="current-password"></div>
      <button class="btn btn-primary" style="width:100%;margin-top:6px;padding:11px" onclick="signIn()">Sign In</button>
      <p style="text-align:center;margin-top:14px;font-size:0.8rem;color:var(--text-light)">Forgotten your password? <a href="javascript:void(0)" onclick="showReset()" style="color:var(--accent);text-decoration:none">Reset it</a></p>
    </div>

    <!-- Password Reset -->
    <div id="resetPanel" style="display:none">
      <h2>Reset Password</h2>
      <p>Enter your email and we will send you a reset link.</p>
      <div class="auth-err" id="resetErr"></div>
      <div class="auth-info" id="resetInfo"></div>
      <div class="auth-field"><label>Email</label><input type="email" id="resetEmail" placeholder="you@example.com"></div>
      <button class="btn btn-primary" style="width:100%;margin-top:6px;padding:11px" onclick="sendReset()">Send Reset Link</button>
      <p style="text-align:center;margin-top:14px;font-size:0.8rem;color:var(--text-light)"><a href="javascript:void(0)" onclick="showSignIn()" style="color:var(--accent);text-decoration:none">Back to sign in</a></p>
    </div>

    <!-- Set New Password (after reset link) -->
    <div id="newPwPanel" style="display:none">
      <h2>Set New Password</h2>
      <p>Choose a strong password for your account.</p>
      <div class="auth-err" id="newPwErr"></div>
      <div class="auth-field"><label>New Password</label><input type="password" id="newPw1" placeholder="At least 8 characters"></div>
      <div class="auth-field"><label>Confirm Password</label><input type="password" id="newPw2" placeholder="Repeat password"></div>
      <button class="btn btn-primary" style="width:100%;margin-top:6px;padding:11px" onclick="setNewPassword()">Update Password</button>
    </div>
  </div>
</div>

<!-- ==================== APP ==================== -->
<div id="appRoot" style="display:none">

<header>
  <a class="logo" href="#" onclick="switchPage('dashboard');return false;">
    <svg class="swallow-icon" viewBox="0 0 80 60" fill="none">
      <path d="M40 28 C36 22,20 14,4 18 C12 20,18 24,20 30 C16 28,8 27,2 30 C10 32,16 34,18 40 C14 40,6 42,2 48 C12 44,22 40,28 36 C30 42,32 50,34 58 C36 50,38 40,40 34 C42 40,44 50,46 58 C48 50,50 42,52 36 C58 40,68 44,78 48 C74 42,66 40,62 40 C64 34,70 32,78 30 C72 27,64 28,60 30 C62 24,68 20,76 18 C60 14,44 22,40 28Z" fill="#3d8bcd"/>
      <circle cx="40" cy="26" r="3" fill="#e8a020"/>
    </svg>
    <div class="logo-text"><h1>GWOC</h1><span>Timesheet System</span></div>
  </a>
  <nav>
    <div class="nav-tab" id="tab-dashboard" onclick="switchPage('dashboard')">üìä Dashboard</div>
    <div class="nav-tab active" id="tab-timesheets" onclick="switchPage('timesheets')">üóì Timesheets</div>
    <div class="nav-tab hidden" id="tab-staff" onclick="switchPage('staff')">üë§ Staff <span class="nav-badge" id="staffBadge">0</span></div>
    <div class="nav-tab hidden" id="tab-locations" onclick="switchPage('locations')">üìç Locations</div>
    <div class="nav-tab hidden" id="tab-users" onclick="switchPage('users')">üë• Users</div>
    <div class="nav-tab hidden" id="tab-audit" onclick="switchPage('audit')">üìú Audit Log</div>
  </nav>
  <div class="header-user">
    <div class="user-pill">
      <span id="headerUserName" style="font-size:0.8rem;color:rgba(240,244,248,0.7)"></span>
      <span class="user-role-badge" id="headerRoleBadge"></span>
    </div>
    <button class="logout-btn" onclick="signOut()">Sign out</button>
  </div>
</header>

<main>

<!-- ==================== DASHBOARD ==================== -->
<div class="page" id="page-dashboard">
  <div class="dash-filters">
    <div class="field-group"><label>From</label><input type="date" id="dashFrom" onchange="renderDashboard()"></div>
    <div class="field-group"><label>To</label><input type="date" id="dashTo" onchange="renderDashboard()"></div>
    <div class="field-group"><label>Location</label><select id="dashLoc" onchange="renderDashboard()"><option value="">All locations</option></select></div>
    <div class="field-group" id="dashStaffFilterWrap" style="display:none"><label>Staff</label><select id="dashStaffFilter" onchange="renderDashboard()"><option value="">All staff</option></select></div>
    <button class="btn btn-outline" onclick="setDashPeriod('week')">This Week</button>
    <button class="btn btn-outline" onclick="setDashPeriod('month')">This Month</button>
    <button class="btn btn-outline" onclick="setDashPeriod('all')">All Time</button>
  </div>
  <div class="kpi-row" id="kpiRow"></div>
  <div class="dash-cols">
    <div class="dash-card"><div class="dash-card-hdr">üë§ Hours by Employee</div><div class="dash-card-body" id="chartEmployee"></div></div>
    <div class="dash-card"><div class="dash-card-hdr">üìç Hours by Location</div><div class="dash-card-body" id="chartLocation"></div></div>
  </div>
  <div class="dash-cols">
    <div class="dash-card"><div class="dash-card-hdr">üìÖ Hours by Day of Week</div><div class="dash-card-body" id="chartDow"></div></div>
    <div class="dash-card"><div class="dash-card-hdr">‚ö† Break Violations</div><div class="dash-card-body" id="chartViolations"></div></div>
  </div>
  <div class="dash-card" style="margin-bottom:0">
    <div class="dash-card-hdr">üìã Staff Summary Table</div>
    <div class="dash-card-body" style="padding:0;overflow-x:auto">
      <table class="dash-table" id="staffSummaryTable">
        <thead><tr><th>Name</th><th>Shifts</th><th>Total Hours</th><th>Avg Shift</th><th>Locations</th><th>Violations</th></tr></thead>
        <tbody id="staffSummaryBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ==================== TIMESHEETS ==================== -->
<div class="page active" id="page-timesheets">
  <div class="card">
    <div class="card-header"><span>‚úèÔ∏è</span><h2>Log Shifts</h2></div>
    <div class="card-body">
      <!-- Staff selector: managers/admins can choose any staff; staff members see their own name -->
      <div style="display:flex;gap:14px;margin-bottom:16px;flex-wrap:wrap;align-items:flex-end">
        <div class="field-group" style="min-width:220px;max-width:300px;flex:1" id="staffSelectWrap">
          <label>Staff Member</label>
          <select id="staffSelect" style="-webkit-appearance:none;appearance:none">
            <option value="">Select staff member...</option>
          </select>
        </div>
        <div id="staffNameReadonly" style="display:none;min-width:220px;flex:1">
          <div style="font-size:0.7rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:4px">Logging for</div>
          <div style="padding:8px 11px;background:var(--chalk);border-radius:7px;font-size:0.88rem;font-weight:600;color:var(--deep)" id="staffNameDisplay"></div>
        </div>
      </div>
      <table class="shifts-table">
        <thead><tr>
          <th style="width:112px">Date</th>
          <th style="width:90px">Start</th>
          <th style="width:90px">End</th>
          <th style="width:130px">Location</th>
          <th style="width:110px">Break Taken</th>
          <th style="width:62px">Net Hrs</th>
          <th style="width:144px">Status</th>
          <th style="width:34px"></th>
        </tr></thead>
        <tbody id="shiftRows"></tbody>
      </table>
      <button class="add-row-btn" onclick="addShiftRow()"><span style="font-size:1.1rem;font-weight:700">+</span> Add Shift Row</button>
      <div class="break-rule-note">
        <strong>Break rules:</strong> A 15-minute unpaid break is required for every complete 6-hour block worked.
        Examples: under 6h = no break required; 6‚Äì11h 59m = 15 min; 12‚Äì17h 59m = 30 min; 18‚Äì23h 59m = 45 min.
        Maximum break that can be logged is <strong>90 minutes</strong>. Break time is deducted from gross hours to give net hours.
        Amber flag = insufficient break logged. Red flag = no break logged at all.
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="resetForm()">Clear Form</button>
        <button class="btn btn-primary" onclick="saveEntry()">Save Timesheet</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><span>üìã</span><h2>Timesheet Records</h2></div>
    <div class="rec-controls">
      <div id="filterNameWrap"><label>Staff</label><br><input type="text" id="filterName" placeholder="Name..." oninput="renderRecords()" style="margin-top:3px;width:130px"></div>
      <div><label>Location</label><br><select id="filterLoc" onchange="renderRecords()" style="margin-top:3px;width:130px"><option value="">All</option></select></div>
      <div><label>From</label><br><input type="date" id="filterFrom" onchange="renderRecords()" style="margin-top:3px"></div>
      <div><label>To</label><br><input type="date" id="filterTo" onchange="renderRecords()" style="margin-top:3px"></div>
      <div style="margin-left:auto"><button class="btn btn-outline" onclick="exportCSV()" style="font-size:0.78rem;padding:6px 13px">‚¨á Export CSV</button></div>
    </div>
    <div id="recordsContainer"></div>
    <div class="summary-bar" id="summaryBar"></div>
  </div>
</div>

<!-- ==================== STAFF ==================== -->
<div class="page" id="page-staff">
  <div class="card">
    <div class="card-header"><span>üë§</span><h2>Staff Directory</h2></div>
    <div class="card-body">
      <div class="entity-add-form">
        <div class="field-group" style="min-width:130px;flex:1"><label>First Name</label><input type="text" id="newFirst" placeholder="e.g. Sarah" autocomplete="off"></div>
        <div class="field-group" style="min-width:130px;flex:1"><label>Last Name</label><input type="text" id="newLast" placeholder="e.g. Mitchell" autocomplete="off"></div>
        <div class="field-group" style="min-width:120px;flex:1"><label>Role <span style="font-weight:400;font-size:0.68rem">(optional)</span></label><input type="text" id="newRole" placeholder="e.g. Barista" autocomplete="off"></div>
        <button class="btn btn-primary" onclick="addStaff()" style="flex-shrink:0;white-space:nowrap">Add Staff Member</button>
      </div>
      <div id="staffGrid"></div>
    </div>
  </div>
</div>

<!-- ==================== LOCATIONS ==================== -->
<div class="page" id="page-locations">
  <div class="card">
    <div class="card-header"><span>üìç</span><h2>Locations</h2></div>
    <div class="card-body">
      <div class="entity-add-form">
        <div class="field-group" style="min-width:160px;flex:1"><label>Location Name</label><input type="text" id="newLocName" placeholder="e.g. High Street" autocomplete="off"></div>
        <button class="btn btn-primary" onclick="addLocation()" style="flex-shrink:0">Add Location</button>
      </div>
      <div id="locGrid"></div>
    </div>
  </div>
</div>

<!-- ==================== USERS ==================== -->
<div class="page" id="page-users">
  <div class="card">
    <div class="card-header"><span>üë•</span><h2>User Management</h2></div>
    <div class="card-body">
      <div class="entity-add-form" style="background:var(--chalk);padding:18px;border-radius:10px;margin-bottom:22px;border:none">
        <div style="width:100%;margin-bottom:10px;font-size:0.78rem;color:var(--text-mid);font-weight:500">Invite a new user ‚Äî they will receive an email to set their password.</div>
        <div class="field-group" style="min-width:160px;flex:1"><label>Email</label><input type="email" id="inviteEmail" placeholder="user@example.com"></div>
        <div class="field-group" style="min-width:120px;flex:1"><label>Full Name</label><input type="text" id="inviteName" placeholder="Jane Smith"></div>
        <div class="field-group" style="min-width:110px" id="inviteRoleWrap">
          <label>Role</label>
          <select id="inviteRole" style="-webkit-appearance:none;appearance:none;padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.88rem;background:var(--milk)">
            <option value="staff">Staff</option>
            <option value="manager">Manager</option>
            <option value="admin" id="inviteAdminOpt">Admin</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="inviteUser()" style="flex-shrink:0;white-space:nowrap">Send Invite</button>
      </div>
      <div id="usersTableWrap">
        <div class="empty-state"><div class="icon">üë•</div><p>Loading users...</p></div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== AUDIT LOG ==================== -->
<div class="page" id="page-audit">
  <div class="card">
    <div class="card-header"><span>üìú</span><h2>Audit Log ‚Äî Timesheet Amendments</h2></div>
    <div class="card-body">
      <div id="auditContainer"><div class="empty-state"><div class="icon">üìú</div><p>Loading audit log...</p></div></div>
    </div>
  </div>
</div>

</main>
</div><!-- /appRoot -->

<!-- ==================== MODALS ==================== -->

<!-- Confirm modal -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3 id="modalTitle">Confirm</h3>
    <p id="modalMsg"></p>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-red" id="modalConfirmBtn">Delete</button>
    </div>
  </div>
</div>

<!-- Amendment reason modal -->
<div class="modal-overlay" id="amendModal">
  <div class="modal" style="max-width:460px">
    <h3>‚úèÔ∏è Amend Timesheet Entry</h3>
    <p style="margin-bottom:14px">You are editing a timesheet entry as a manager or admin. A reason is required and will be saved to the audit log.</p>
    <div class="field-group" style="margin-bottom:16px">
      <label>Reason for Amendment</label>
      <textarea id="amendReason" placeholder="e.g. Incorrect end time recorded by staff member ‚Äî corrected from 17:00 to 16:30."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeAmendModal()">Cancel</button>
      <button class="btn btn-primary" id="amendConfirmBtn">Confirm Amendment</button>
    </div>
  </div>
</div>

<!-- Shift detail/edit modal -->
<div class="modal-overlay" id="shiftEditModal">
  <div class="modal" style="max-width:520px">
    <h3 id="shiftEditTitle">Edit Shift</h3>
    <div id="shiftEditBody"></div>
    <div class="modal-actions" style="margin-top:18px">
      <button class="btn btn-outline" onclick="closeShiftEditModal()">Cancel</button>
      <button class="btn btn-primary" id="shiftEditSaveBtn">Save Changes</button>
    </div>
  </div>
</div>

<div id="loadingOverlay"><div class="spinner"></div></div>
<div class="toast" id="toast"></div>

<script>
// ================================================================
// CONFIGURATION
// Replace the two placeholder values below with your Supabase details.
// Found at: Supabase Dashboard > Project Settings > API
// Use the URL and the anon/public key.
// ================================================================
const SUPABASE_URL      = "https://mafbfgvotsjscczjmjmx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hZmJmZ3ZvdHNqc2Njemptam14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NDE4MTIsImV4cCI6MjA4NzExNzgxMn0.6oLTvdh4Pf7YJ-BDfhV3gOe6HphJJwYs-am96kcnK8Q";

// ================================================================
// INIT SUPABASE
// ================================================================
const { createClient } = supabase;
const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    flowType: "pkce",
    detectSessionInUrl: true,
    persistSession: true,
    autoRefreshToken: true
  }
});

// ================================================================
// APP STATE
// ================================================================
let currentUser = null;       // Supabase auth user object
let currentProfile = null;    // Row from profiles table {id, role, full_name, email}
let staffList = [];           // Cached staff members
let locationList = [];        // Cached locations

// ================================================================
// UTILITIES
// ================================================================
function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3200);
}
function today() { return new Date().toISOString().split('T')[0]; }
function esc(str) { return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
const AV_COLS = ['#2e7bc9','#7056a0','#1a9a5a','#c97b2e','#b54d2e','#2e9fc9','#a07c2e','#b52e7e'];
function avColor(name) { let h=0; for(let i=0;i<(name||'').length;i++) h=name.charCodeAt(i)+((h<<5)-h); return AV_COLS[Math.abs(h)%AV_COLS.length]; }
function initials(name) { return (name||'?').split(' ').map(w=>w[0]||'').join('').toUpperCase().slice(0,2); }
function roleLabel(role) {
  if(role==='admin') return '<span class="user-role-badge role-admin">Admin</span>';
  if(role==='manager') return '<span class="user-role-badge role-manager">Manager</span>';
  return '<span class="user-role-badge role-staff">Staff</span>';
}
function isAdminOrManager() { return currentProfile?.role === 'admin' || currentProfile?.role === 'manager'; }
function isAdmin() { return currentProfile?.role === 'admin'; }

// ================================================================
// AUTH HELPERS
// ================================================================
function showSignIn() {
  document.getElementById('signInPanel').style.display = 'block';
  document.getElementById('resetPanel').style.display = 'none';
  document.getElementById('newPwPanel').style.display = 'none';
}
function showReset() {
  document.getElementById('signInPanel').style.display = 'none';
  document.getElementById('resetPanel').style.display = 'block';
}
function showNewPw() {
  document.getElementById('signInPanel').style.display = 'none';
  document.getElementById('resetPanel').style.display = 'none';
  document.getElementById('newPwPanel').style.display = 'block';
}
function showAuthErr(panelId, msg) {
  const el = document.getElementById(panelId);
  el.textContent = msg;
  el.style.display = 'block';
}
function showAuthInfo(panelId, msg) {
  const el = document.getElementById(panelId);
  el.textContent = msg;
  el.style.display = 'block';
}
function clearAuthMessages() {
  ['signInErr','signInInfo','resetErr','resetInfo','newPwErr'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.textContent=''; el.style.display='none'; }
  });
}

async function signIn() {
  clearAuthMessages();
  const email = document.getElementById('loginEmail').value.trim();
  const pw    = document.getElementById('loginPw').value;
  if (!email || !pw) { showAuthErr('signInErr','Please enter your email and password.'); return; }
  const btn = document.querySelector('#signInPanel .btn-primary');
  if (btn) { btn.disabled = true; btn.textContent = 'Signing in...'; }
  showLoading();
  try {
    const { data, error } = await db.auth.signInWithPassword({ email, password: pw });
    hideLoading();
    if (btn) { btn.disabled = false; btn.textContent = 'Sign In'; }
    if (error) {
      // Give a friendlier message for the most common errors
      let msg = error.message;
      if (msg.includes('Invalid login credentials')) msg = 'Incorrect email or password. Please try again.';
      if (msg.includes('Email not confirmed'))       msg = 'Please confirm your email address first ‚Äî check your inbox for a confirmation link.';
      showAuthErr('signInErr', msg);
      return;
    }
    // onAuthStateChange SIGNED_IN will fire and call bootApp()
  } catch (e) {
    hideLoading();
    if (btn) { btn.disabled = false; btn.textContent = 'Sign In'; }
    showAuthErr('signInErr', 'Connection error ‚Äî check your internet connection and try again.');
  }
}

async function sendReset() {
  clearAuthMessages();
  const email = document.getElementById('resetEmail').value.trim();
  if (!email) { showAuthErr('resetErr','Please enter your email address.'); return; }
  // Build a clean redirect URL ‚Äî strip any existing hash/query so the
  // reset token lands cleanly on the page
  const redirectTo = window.location.origin + window.location.pathname;
  showLoading();
  try {
    const { error } = await db.auth.resetPasswordForEmail(email, { redirectTo });
    hideLoading();
    if (error) { showAuthErr('resetErr', error.message); return; }
    showAuthInfo('resetInfo', 'Reset link sent ‚Äî check your inbox (and spam folder).');
  } catch (e) {
    hideLoading();
    showAuthErr('resetErr', 'Connection error ‚Äî please try again.');
  }
}

async function setNewPassword() {
  clearAuthMessages();
  const p1 = document.getElementById('newPw1').value;
  const p2 = document.getElementById('newPw2').value;
  if (!p1 || p1.length < 8) { showAuthErr('newPwErr','Password must be at least 8 characters.'); return; }
  if (p1 !== p2) { showAuthErr('newPwErr','Passwords do not match.'); return; }
  const btn = document.querySelector('#newPwPanel .btn-primary');
  if (btn) { btn.disabled = true; btn.textContent = 'Saving...'; }
  showLoading();
  try {
    const { data, error } = await db.auth.updateUser({ password: p1 });
    hideLoading();
    if (btn) { btn.disabled = false; btn.textContent = 'Update Password'; }
    if (error) { showAuthErr('newPwErr', error.message); return; }
    // Clear the hash from the URL so the recovery token isn't reused
    history.replaceState(null, '', window.location.pathname);
    showToast('Password set ‚Äî signing you in...');
    // onAuthStateChange USER_UPDATED will fire and boot the app
  } catch (e) {
    hideLoading();
    if (btn) { btn.disabled = false; btn.textContent = 'Update Password'; }
    showAuthErr('newPwErr', 'Error saving password ‚Äî please try again.');
  }
}

async function signOut() {
  await db.auth.signOut();
  currentUser = null;
  currentProfile = null;
  document.getElementById('appRoot').style.display = 'none';
  document.getElementById('authScreen').style.display = 'flex';
  clearAuthMessages();
  showSignIn();
}

// ================================================================
// AUTH STATE LISTENER ‚Äî drives the whole app
// Registered inside DOMContentLoaded so the DOM is always ready.
// Only registered when credentials are actually configured.
// ================================================================
document.addEventListener('DOMContentLoaded', () => {

  // If credentials not set, show config error and stop here
  if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
    document.getElementById('authScreen').style.display = 'flex';
    const box = document.querySelector('.auth-box');
    if (box) box.innerHTML = `
      <div style="text-align:center;padding:10px 0">
        <div style="font-size:2.5rem;margin-bottom:14px">‚öôÔ∏è</div>
        <h2 style="font-family:'Playfair Display',serif;color:#c0392b;margin-bottom:10px">Configuration Required</h2>
        <p style="font-size:0.85rem;color:#3a5068;line-height:1.6;margin-bottom:16px">
          Open <strong>index.html</strong> and replace<br>
          <code style="background:#eaf0f6;padding:2px 6px;border-radius:4px;font-size:0.8rem">YOUR_SUPABASE_URL</code> and<br>
          <code style="background:#eaf0f6;padding:2px 6px;border-radius:4px;font-size:0.8rem">YOUR_SUPABASE_ANON_KEY</code><br>
          with your values from<br>
          <strong>Supabase &rarr; Project Settings &rarr; API</strong>
        </p>
      </div>`;
    return;
  }

  // Credentials are set ‚Äî register the auth listener
  db.auth.onAuthStateChange(async (event, session) => {
    console.log('[Auth]', event, session?.user?.email || 'no user');
    console.log('[Auth] handler running, event=', event, 'has session=', !!session);

    if (event === 'PASSWORD_RECOVERY') {
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('appRoot').style.display = 'none';
      showNewPw();
      return;
    }

    if (event === 'SIGNED_OUT' || (!session && event === 'INITIAL_SESSION')) {
      currentUser = null;
      currentProfile = null;
      document.getElementById('appRoot').style.display = 'none';
      document.getElementById('authScreen').style.display = 'flex';
      showSignIn();
      return;
    }

    if (session?.user && (
      event === 'SIGNED_IN'      ||
      event === 'USER_UPDATED'   ||
      event === 'TOKEN_REFRESHED'||
      event === 'INITIAL_SESSION'
    )) {
      if (event === 'TOKEN_REFRESHED' && currentUser) return;
      console.log('[Auth] loading profile for', session.user.email);
      currentUser = session.user;
      try {
        await loadProfile();
      } catch(e) {
        console.error('[Auth] loadProfile threw:', e);
      }
      console.log('[Auth] profile loaded:', JSON.stringify(currentProfile));
      if (!currentProfile) {
        console.error('[Auth] no profile ‚Äî showing error');
        document.getElementById('authScreen').style.display = 'flex';
        document.getElementById('appRoot').style.display = 'none';
        showAuthErr('signInErr', 'Account found but no profile record exists. Ask your administrator to run the SQL setup script.');
        return;
      }
      console.log('[Auth] calling bootApp...');
      try {
        await bootApp();
      } catch(e) {
        console.error('[Auth] bootApp threw:', e);
      }
    }
  });

}); // end DOMContentLoaded

async function loadProfile() {
  try {
    const { data, error } = await db
      .from('profiles')
      .select('*')
      .eq('id', currentUser.id)
      .single();

    if (error) {
      console.error('Profile load error:', error.message);
      // If profiles table missing, create a minimal fallback so app doesn't hang
      currentProfile = {
        id: currentUser.id,
        email: currentUser.email,
        full_name: currentUser.email,
        role: 'staff',
        is_active: true
      };
      showToast('Warning: profiles table not found. Run the SQL setup script in Supabase.');
      return;
    }
    currentProfile = data;
  } catch(e) {
    console.error('loadProfile exception:', e);
    currentProfile = {
      id: currentUser.id,
      email: currentUser.email,
      full_name: currentUser.email,
      role: 'staff',
      is_active: true
    };
  }
}

// ================================================================
// BOOT APP ‚Äî called after successful auth
// ================================================================
async function bootApp() {
  try {
    console.log('[Boot] 1 - start, role:', currentProfile?.role);
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('appRoot').style.display = 'block';
    console.log('[Boot] 2 - app visible');

    document.getElementById('headerUserName').textContent = currentProfile?.full_name || currentProfile?.email || '';
    const rb = document.getElementById('headerRoleBadge');
    rb.textContent = (currentProfile?.role || 'staff').charAt(0).toUpperCase() + (currentProfile?.role || 'staff').slice(1);
    rb.className = 'user-role-badge role-' + (currentProfile?.role || 'staff');
    console.log('[Boot] 3 - header set');

    const role = currentProfile?.role;
    const showTabs = (ids) => ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.classList.remove('hidden');
    });

    if (role === 'admin' || role === 'manager') {
      showTabs(['tab-dashboard','tab-staff','tab-locations','tab-users','tab-audit']);
    } else {
      showTabs(['tab-dashboard']);
    }
    console.log('[Boot] 4 - tabs set for role:', role);

    if (!isAdminOrManager()) {
      const sw = document.getElementById('staffSelectWrap');
      const sr = document.getElementById('staffNameReadonly');
      const sd = document.getElementById('staffNameDisplay');
      const fw = document.getElementById('filterNameWrap');
      if (sw) sw.style.display = 'none';
      if (sr) sr.style.display = 'block';
      if (sd) sd.textContent = currentProfile?.full_name || currentProfile?.email;
      if (fw) fw.style.display = 'none';
    }
    console.log('[Boot] 5 - staff form configured');

    const adminOpt = document.getElementById('inviteAdminOpt');
    if (adminOpt && !isAdmin()) adminOpt.style.display = 'none';

    showLoading();
    console.log('[Boot] 6 - loading staff and locations...');
    await Promise.all([loadStaff(), loadLocations()]);
    console.log('[Boot] 7 - staff:', staffList.length, 'locations:', locationList.length);
    hideLoading();

    console.log('[Boot] 8 - adding shift row...');
    addShiftRow();
    console.log('[Boot] 9 - switching page...');
    switchPage('timesheets');
    console.log('[Boot] 10 - COMPLETE');

    const now = new Date();
    document.getElementById('dashFrom').value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    document.getElementById('dashTo').value = now.toISOString().split('T')[0];

  } catch(e) {
    hideLoading();
    console.error('[Boot] CRASHED at:', e.message, e.stack);
    showToast('App failed to load: ' + e.message);
  }
}

// ================================================================
// NAVIGATION
// ================================================================
function switchPage(p) {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
  const page = document.getElementById('page-' + p);
  const tab  = document.getElementById('tab-' + p);
  if (page) page.classList.add('active');
  if (tab)  tab.classList.add('active');

  if (p === 'timesheets')  { populateLocFilter(); renderRecords(); }
  if (p === 'staff')       renderStaffGrid();
  if (p === 'locations')   renderLocGrid();
  if (p === 'dashboard')   { populateDashFilters(); renderDashboard(); }
  if (p === 'users')       renderUsers();
  if (p === 'audit')       renderAuditLog();
}

// ================================================================
// STAFF DATA (from DB)
// ================================================================
async function loadStaff() {
  try {
    const { data, error } = await db.from('staff').select('*').order('name');
    if (error) {
      console.error('loadStaff error:', error.message);
      // Table may not exist yet ‚Äî fail gracefully
      staffList = [];
      return;
    }
    staffList = data || [];
    const badge = document.getElementById('staffBadge');
    if (badge) badge.textContent = staffList.length;
    rebuildStaffSelect();
  } catch(e) {
    console.error('loadStaff exception:', e);
    staffList = [];
  }
}

function rebuildStaffSelect() {
  const sel = document.getElementById('staffSelect');
  if (!sel) return;
  sel.innerHTML = '<option value="">Select staff member...</option>' +
    staffList.map(s => `<option value="${s.id}">${esc(s.name)}${s.role ? ' ‚Äî ' + esc(s.role) : ''}</option>`).join('');
}

async function addStaff() {
  const first = document.getElementById('newFirst').value.trim();
  const last  = document.getElementById('newLast').value.trim();
  const role  = document.getElementById('newRole').value.trim();
  if (!first && !last) { showToast('Please enter at least a first or last name'); return; }
  const name = [first, last].filter(Boolean).join(' ');
  showLoading();
  const { error } = await db.from('staff').insert({ name, role: role || null });
  hideLoading();
  if (error) { showToast('Error: ' + error.message); return; }
  document.getElementById('newFirst').value = '';
  document.getElementById('newLast').value  = '';
  document.getElementById('newRole').value  = '';
  await loadStaff();
  renderStaffGrid();
  showToast('Staff member added');
}

async function deleteStaff(id) {
  showConfirm('Remove Staff Member', 'This cannot be undone.', async () => {
    showLoading();
    const { error } = await db.from('staff').delete().eq('id', id);
    hideLoading();
    if (error) { showToast('Error: ' + error.message); return; }
    await loadStaff();
    renderStaffGrid();
    showToast('Staff member removed');
  });
}

function renderStaffGrid() {
  const grid = document.getElementById('staffGrid');
  if (!staffList.length) {
    grid.innerHTML = '<div class="empty-state" style="padding:24px 0"><div class="icon">üë§</div><p>No staff added yet.</p></div>';
    return;
  }
  grid.innerHTML = `<div class="entity-grid">${staffList.map(s => `
    <div class="entity-card">
      <div class="entity-avatar" style="background:${avColor(s.name)}">${initials(s.name)}</div>
      <div class="entity-info"><div class="entity-name">${esc(s.name)}</div><div class="entity-sub">${s.role ? esc(s.role) : '<span style="font-style:italic">No role</span>'}</div></div>
      ${isAdminOrManager() ? `<button class="entity-del" onclick="deleteStaff('${s.id}')" title="Remove">√ó</button>` : ''}
    </div>`).join('')}</div>`;
}

// ================================================================
// LOCATION DATA (from DB)
// ================================================================
async function loadLocations() {
  try {
    const { data, error } = await db.from('locations').select('*').order('name');
    if (error) {
      console.error('loadLocations error:', error.message);
      locationList = [];
      return;
    }
    locationList = data || [];
    rebuildLocSelects();
  } catch(e) {
    console.error('loadLocations exception:', e);
    locationList = [];
  }
}

function rebuildLocSelects() {
  document.querySelectorAll('.s-loc').forEach(sel => {
    const cur = sel.value;
    sel.innerHTML = '<option value="">-- Location --</option>' +
      locationList.map(l => `<option value="${l.id}"${l.id===cur?' selected':''}>${esc(l.name)}</option>`).join('');
  });
  populateLocFilter();
  populateDashFilters();
}

function populateLocFilter() {
  const sel = document.getElementById('filterLoc');
  const cur = sel.value;
  sel.innerHTML = '<option value="">All</option>' +
    locationList.map(l => `<option value="${l.id}"${l.id===cur?' selected':''}>${esc(l.name)}</option>`).join('');
}

function populateDashFilters() {
  const locSel = document.getElementById('dashLoc');
  if (locSel) {
    const cur = locSel.value;
    locSel.innerHTML = '<option value="">All locations</option>' +
      locationList.map(l => `<option value="${l.id}"${l.id===cur?' selected':''}>${esc(l.name)}</option>`).join('');
  }
  if (isAdminOrManager()) {
    const wrap = document.getElementById('dashStaffFilterWrap');
    const staffSel = document.getElementById('dashStaffFilter');
    if (wrap) wrap.style.display = 'block';
    if (staffSel) {
      const cur2 = staffSel.value;
      staffSel.innerHTML = '<option value="">All staff</option>' +
        staffList.map(s => `<option value="${s.id}"${s.id===cur2?' selected':''}>${esc(s.name)}</option>`).join('');
    }
  }
}

async function addLocation() {
  const name = document.getElementById('newLocName').value.trim();
  if (!name) { showToast('Please enter a location name'); return; }
  showLoading();
  const { error } = await db.from('locations').insert({ name });
  hideLoading();
  if (error) { showToast('Error: ' + error.message); return; }
  document.getElementById('newLocName').value = '';
  await loadLocations();
  renderLocGrid();
  showToast('Location added');
}

async function deleteLocation(id) {
  showConfirm('Remove Location', 'This cannot be undone.', async () => {
    showLoading();
    const { error } = await db.from('locations').delete().eq('id', id);
    hideLoading();
    if (error) { showToast('Error: ' + error.message); return; }
    await loadLocations();
    renderLocGrid();
    showToast('Location removed');
  });
}

function renderLocGrid() {
  const grid = document.getElementById('locGrid');
  if (!locationList.length) {
    grid.innerHTML = '<div class="empty-state" style="padding:24px 0"><div class="icon">üìç</div><p>No locations added yet.</p></div>';
    return;
  }
  grid.innerHTML = `<div class="entity-grid">${locationList.map(l => `
    <div class="entity-card">
      <div class="loc-icon">üìç</div>
      <div class="entity-info"><div class="entity-name">${esc(l.name)}</div></div>
      ${isAdminOrManager() ? `<button class="entity-del" onclick="deleteLocation('${l.id}')" title="Remove">√ó</button>` : ''}
    </div>`).join('')}</div>`;
}

// ================================================================
// TIME & BREAK UTILITIES
// ================================================================
function genTimes() {
  const t = [];
  for (let h = 0; h < 24; h++) for (let m = 0; m < 60; m += 15)
    t.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
  return t;
}
const TIME_OPTS  = genTimes();
const MAX_BREAK  = 90;
const BREAK_OPTS = (() => {
  const opts = [{ l: 'No break', v: 0 }];
  for (let m = 15; m <= MAX_BREAK; m += 15)
    opts.push({ l: m < 60 ? `${m} min` : `${Math.floor(m/60)}h${m%60 ? ` ${m%60}m` : ''}`, v: m });
  return opts;
})();

function toMins(t) { if (!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; }
function requiredBreak(grossMins) { return Math.floor(grossMins / 360) * 15; }
function calcNetHours(start, end, breakMins) {
  if (!start || !end) return null;
  const gross = toMins(end) - toMins(start);
  if (gross <= 0) return null;
  const req    = requiredBreak(gross);
  const deduct = Math.max(breakMins || 0, req);
  return (gross - deduct) / 60;
}
function breakStatus(start, end, breakMins) {
  if (!start || !end) return null;
  const gross = toMins(end) - toMins(start);
  if (gross <= 0) return null;
  const req    = requiredBreak(gross);
  const actual = breakMins || 0;
  if (req === 0)      return { type: 'ok',    label: '‚úì OK',          tip: 'Under 6 hours, no break required' };
  if (actual === 0)   return { type: 'error',  label: `‚ö† ${req}m req.`, tip: `No break logged. ${req} min required.` };
  if (actual < req)   return { type: 'warn',   label: `‚ö† Need ${req}m`, tip: `${actual} min logged, ${req} min required.` };
  return { type: 'ok', label: `‚úì ${actual}m`, tip: `Requirement met (${req} min required).` };
}

// ================================================================
// SHIFT ROW BUILDER
// ================================================================
let rowId = 0;
function mkSel(cls, opts, val, fn) {
  const sel = document.createElement('select');
  sel.className = cls;
  sel.onchange = fn;
  opts.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o.v !== undefined ? o.v : o;
    opt.textContent = o.l !== undefined ? o.l : o;
    if ((o.v !== undefined ? o.v : o) == val) opt.selected = true;
    sel.appendChild(opt);
  });
  return sel;
}

function addShiftRow(data = {}) {
  const id     = rowId++;
  const todayD = today();
  const tbody  = document.getElementById('shiftRows');
  const tr     = document.createElement('tr');
  tr.className = 'shift-row';
  tr.dataset.id = id;

  const td1 = document.createElement('td');
  const di  = document.createElement('input');
  di.type   = 'date';
  di.value  = data.date || todayD;
  di.onchange = () => updateRow(id);
  td1.appendChild(di); tr.appendChild(td1);

  const td2 = document.createElement('td');
  td2.appendChild(mkSel('s-start', TIME_OPTS.map(t=>({v:t,l:t})), data.start||'09:00', ()=>updateRow(id)));
  tr.appendChild(td2);

  const td3 = document.createElement('td');
  td3.appendChild(mkSel('s-end', TIME_OPTS.map(t=>({v:t,l:t})), data.end||'17:00', ()=>updateRow(id)));
  tr.appendChild(td3);

  const td4 = document.createElement('td');
  const locSel = document.createElement('select');
  locSel.className = 's-loc';
  locSel.innerHTML = '<option value="">-- Location --</option>' +
    locationList.map(l => `<option value="${l.id}"${l.id==data.location_id?' selected':''}>${esc(l.name)}</option>`).join('');
  td4.appendChild(locSel); tr.appendChild(td4);

  const td5 = document.createElement('td');
  td5.appendChild(mkSel('s-brk', BREAK_OPTS, data.break_mins || 0, ()=>updateRow(id)));
  tr.appendChild(td5);

  const td6 = document.createElement('td'); td6.className = 'hours-cell'; td6.dataset.role = 'hrs'; tr.appendChild(td6);
  const td7 = document.createElement('td'); td7.dataset.role = 'sts'; tr.appendChild(td7);

  const td8 = document.createElement('td');
  const db2 = document.createElement('button');
  db2.className = 'del-row-btn'; db2.textContent = '√ó'; db2.title = 'Remove row';
  db2.onclick = () => tr.remove();
  td8.appendChild(db2); tr.appendChild(td8);

  tbody.appendChild(tr);
  updateRow(id);
}

function updateRow(id) {
  const tr = document.querySelector(`tr[data-id="${id}"]`); if (!tr) return;
  const s  = tr.querySelector('.s-start').value;
  const e  = tr.querySelector('.s-end').value;
  const b  = parseInt(tr.querySelector('.s-brk').value) || 0;
  const net = calcNetHours(s, e, b);
  const hc  = tr.querySelector('[data-role="hrs"]');
  hc.textContent = (net !== null && net > 0) ? net.toFixed(2) + 'h' : '--';
  hc.style.color = (net !== null && net > 0) ? 'var(--deep)' : 'var(--text-light)';
  const sc = tr.querySelector('[data-role="sts"]'); sc.innerHTML = '';
  const st = breakStatus(s, e, b);
  if (st) {
    const badge = document.createElement('span');
    badge.className = `break-flag ${st.type}`;
    badge.title = st.tip;
    badge.textContent = st.label;
    sc.appendChild(badge);
  }
}

function getRowData() {
  return Array.from(document.querySelectorAll('.shift-row')).map(tr => {
    const date      = tr.querySelector('input[type="date"]').value;
    const start     = tr.querySelector('.s-start').value;
    const end       = tr.querySelector('.s-end').value;
    const loc_id    = tr.querySelector('.s-loc').value || null;
    const breakMins = parseInt(tr.querySelector('.s-brk').value) || 0;
    const gross     = toMins(end) - toMins(start);
    const req       = gross > 0 ? requiredBreak(gross) : 0;
    const net       = calcNetHours(start, end, breakMins);
    const st        = breakStatus(start, end, breakMins);
    return { date, start_time: start, end_time: end, location_id: loc_id, break_mins: breakMins,
      required_break_mins: req, net_hours: net, break_warning: st?.type !== 'ok' };
  }).filter(r => r.date && r.start_time && r.end_time);
}

// ================================================================
// TIMESHEET SAVE
// ================================================================
async function saveEntry() {
  let staff_id, staff_name;

  if (isAdminOrManager()) {
    const sel = document.getElementById('staffSelect');
    if (!sel.value) { showToast('Please select a staff member'); return; }
    staff_id = sel.value;
    const s  = staffList.find(x => x.id === staff_id);
    staff_name = s?.name || '';
  } else {
    // For staff users, we look up their linked staff record
    const linked = staffList.find(s => s.user_id === currentUser.id);
    if (!linked) {
      showToast('Your account is not linked to a staff member. Please contact an admin.');
      return;
    }
    staff_id   = linked.id;
    staff_name = linked.name;
  }

  const shifts = getRowData();
  if (!shifts.length) { showToast('Please add at least one shift row'); return; }

  showLoading();
  // Insert each shift as a separate row
  const rows = shifts.map(s => ({
    ...s,
    staff_id,
    created_by: currentUser.id
  }));

  const { error } = await db.from('timesheets').insert(rows);
  hideLoading();
  if (error) { showToast('Error saving: ' + error.message); return; }

  const hasWarning = shifts.some(s => s.break_warning);
  resetForm();
  await renderRecords();
  showToast(hasWarning ? 'Saved ‚Äî break violations flagged' : 'Timesheet saved');
}

function resetForm() {
  if (isAdminOrManager()) {
    document.getElementById('staffSelect').value = '';
  }
  document.getElementById('shiftRows').innerHTML = '';
  rowId = 0;
  addShiftRow();
}

// ================================================================
// RENDER RECORDS
// ================================================================
async function renderRecords() {
  const cont = document.getElementById('recordsContainer');
  const summ = document.getElementById('summaryBar');
  cont.innerHTML = '<div class="empty-state"><div class="icon" style="font-size:1.5rem">‚è≥</div><p>Loading...</p></div>';

  let query = db.from('timesheets')
    .select(`
      id, date, start_time, end_time, break_mins, required_break_mins,
      net_hours, break_warning, created_at, amended_at, amendment_reason,
      staff:staff_id ( id, name ),
      location:location_id ( id, name ),
      created_by_profile:created_by ( id, full_name )
    `)
    .order('date', { ascending: false })
    .order('start_time', { ascending: false });

  // RLS handles record visibility; we add extra client filters for convenience
  const fn = document.getElementById('filterName')?.value.trim().toLowerCase();
  const fl = document.getElementById('filterLoc')?.value;
  const ff = document.getElementById('filterFrom')?.value;
  const ft = document.getElementById('filterTo')?.value;
  if (fl) query = query.eq('location_id', fl);
  if (ff) query = query.gte('date', ff);
  if (ft) query = query.lte('date', ft);

  const { data: recs, error } = await query;
  if (error) { cont.innerHTML = '<div class="empty-state"><p>Error loading records: ' + esc(error.message) + '</p></div>'; return; }

  let filtered = recs || [];
  if (fn && isAdminOrManager()) filtered = filtered.filter(r => r.staff?.name?.toLowerCase().includes(fn));

  if (!filtered.length) {
    cont.innerHTML = '<div class="empty-state"><div class="icon">üóì</div><p>No timesheet records found.</p></div>';
    summ.innerHTML = '';
    return;
  }

  let totalNet = 0, totalWarn = 0;
  let rows = '';

  filtered.forEach(r => {
    const h = parseFloat(r.net_hours) || 0;
    totalNet += h;
    if (r.break_warning) totalWarn++;

    const stHtml = r.break_warning
      ? '<span class="break-flag error">‚ö† Break issue</span>'
      : '<span class="break-flag ok">‚úì OK</span>';

    const amendedHtml = r.amended_at
      ? `<span class="amended-badge" title="${esc(r.amendment_reason || '')}" onclick="showAmendReason(this, '${esc(r.amendment_reason || 'No reason recorded')}')">‚úè Amended</span>`
      : '';

    const canEdit = isAdminOrManager();
    const canDelete = isAdmin();

    rows += `<tr>
      <td>${esc(r.staff?.name || 'Unknown')}</td>
      <td>${r.location?.name ? esc(r.location.name) : '<span style="color:var(--text-light);font-style:italic">None</span>'}</td>
      <td>${r.date}</td>
      <td>${r.start_time?.slice(0,5)}</td>
      <td>${r.end_time?.slice(0,5)}</td>
      <td>${r.break_mins > 0 ? r.break_mins + 'm' : '‚Äî'}</td>
      <td>${r.required_break_mins > 0 ? r.required_break_mins + 'm' : '‚Äî'}</td>
      <td style="text-align:center;font-weight:600;color:var(--deep)">${h > 0 ? h.toFixed(2) + 'h' : '--'}</td>
      <td>${stHtml} ${amendedHtml}</td>
      <td style="display:flex;gap:5px;align-items:center;justify-content:center">
        ${canEdit   ? `<button class="btn btn-outline" style="padding:4px 9px;font-size:0.75rem" onclick="editShift('${r.id}')">Edit</button>` : ''}
        ${canDelete ? `<button class="btn btn-danger-outline" onclick="deleteRecord('${r.id}')">‚úï</button>` : ''}
      </td>
    </tr>`;
  });

  // Determine column headers based on role
  const nameCol = isAdminOrManager() ? '<th>Name</th>' : '';
  cont.innerHTML = `<div style="overflow-x:auto"><table class="rec-table">
    <thead><tr>${nameCol}<th>Location</th><th>Date</th><th>Start</th><th>End</th><th>Break</th><th>Req.</th><th>Net Hrs</th><th>Status</th><th></th></tr></thead>
    <tbody>${rows}</tbody></table></div>`;

  summ.innerHTML = `<span>Showing <strong>${filtered.length}</strong> ${filtered.length === 1 ? 'entry' : 'entries'}</span>
    <span>Total net hours: <strong>${totalNet.toFixed(2)}h</strong></span>
    ${totalWarn > 0
      ? `<span style="color:var(--flag-red);font-weight:600">‚ö† ${totalWarn} break violation${totalWarn > 1 ? 's' : ''}</span>`
      : '<span style="color:var(--flag-green)">‚úì No violations</span>'}`;
}

function showAmendReason(el, reason) {
  // Repurpose the confirm modal to display the reason
  document.getElementById('modalTitle').textContent = 'Amendment Reason';
  document.getElementById('modalMsg').textContent   = reason;
  document.getElementById('modalConfirmBtn').style.display = 'none';
  document.getElementById('confirmModal').classList.add('open');
}

// ================================================================
// DELETE RECORD (admin only)
// ================================================================
async function deleteRecord(id) {
  showConfirm('Delete Entry', 'Delete this timesheet entry? This cannot be undone.', async () => {
    showLoading();
    const { error } = await db.from('timesheets').delete().eq('id', id);
    hideLoading();
    if (error) { showToast('Error: ' + error.message); return; }
    await renderRecords();
    showToast('Entry deleted');
  });
}

// ================================================================
// EDIT SHIFT (manager/admin) ‚Äî requires amendment reason
// ================================================================
let _editShiftId = null;
let _editPendingFn = null;

async function editShift(id) {
  // Load the record
  const { data: r, error } = await db.from('timesheets')
    .select('*, location:location_id(id,name)')
    .eq('id', id)
    .single();
  if (error || !r) { showToast('Could not load record'); return; }

  _editShiftId = id;

  // Build the edit form inside the modal
  const locOpts = '<option value="">-- None --</option>' +
    locationList.map(l => `<option value="${l.id}"${l.id==r.location_id?' selected':''}>${esc(l.name)}</option>`).join('');

  const timeOpts = (cur) => TIME_OPTS.map(t => `<option value="${t}"${t===cur?' selected':''}>${t}</option>`).join('');

  document.getElementById('shiftEditTitle').textContent = 'Edit Shift ‚Äî ' + (r.date || '');
  document.getElementById('shiftEditBody').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
      <div class="field-group"><label>Date</label><input type="date" id="editDate" value="${r.date}"></div>
      <div class="field-group"><label>Location</label><select id="editLoc" style="-webkit-appearance:none;appearance:none;padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.88rem;background:var(--milk)">${locOpts}</select></div>
      <div class="field-group"><label>Start</label><select id="editStart" style="-webkit-appearance:none;appearance:none;padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.88rem;background:var(--milk)">${timeOpts(r.start_time?.slice(0,5))}</select></div>
      <div class="field-group"><label>End</label><select id="editEnd" style="-webkit-appearance:none;appearance:none;padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.88rem;background:var(--milk)">${timeOpts(r.end_time?.slice(0,5))}</select></div>
    </div>
    <div class="field-group" style="margin-bottom:6px">
      <label>Break Taken</label>
      <select id="editBreak" style="-webkit-appearance:none;appearance:none;padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.88rem;background:var(--milk)">
        ${BREAK_OPTS.map(o => `<option value="${o.v}"${o.v==r.break_mins?' selected':''}>${o.l}</option>`).join('')}
      </select>
    </div>`;

  document.getElementById('amendReason').value = '';
  document.getElementById('shiftEditModal').classList.add('open');
}

document.getElementById('shiftEditSaveBtn').onclick = () => {
  const reason = ''; // We'll collect the reason in the amend modal
  // Close shift edit modal, open amend reason modal
  document.getElementById('shiftEditModal').classList.remove('open');
  document.getElementById('amendReason').value = '';
  document.getElementById('amendModal').classList.add('open');
};

document.getElementById('amendConfirmBtn').onclick = async () => {
  const reason = document.getElementById('amendReason').value.trim();
  if (!reason) { showToast('Please enter a reason for the amendment'); return; }

  const date      = document.getElementById('editDate').value;
  const loc_id    = document.getElementById('editLoc').value || null;
  const start     = document.getElementById('editStart').value;
  const end       = document.getElementById('editEnd').value;
  const breakMins = parseInt(document.getElementById('editBreak').value) || 0;
  const gross     = toMins(end) - toMins(start);
  const req       = gross > 0 ? requiredBreak(gross) : 0;
  const net       = calcNetHours(start, end, breakMins);
  const st        = breakStatus(start, end, breakMins);

  showLoading();
  const { error } = await db.from('timesheets').update({
    date,
    location_id: loc_id,
    start_time: start,
    end_time: end,
    break_mins: breakMins,
    required_break_mins: req,
    net_hours: net,
    break_warning: st?.type !== 'ok',
    amended_by: currentUser.id,
    amended_at: new Date().toISOString(),
    amendment_reason: reason
  }).eq('id', _editShiftId);
  hideLoading();

  if (error) { showToast('Error saving amendment: ' + error.message); return; }

  // Write audit log
  await db.from('amendment_log').insert({
    timesheet_id: _editShiftId,
    amended_by: currentUser.id,
    reason,
    changed_at: new Date().toISOString()
  });

  document.getElementById('amendModal').classList.remove('open');
  _editShiftId = null;
  await renderRecords();
  showToast('Timesheet amended and audit entry recorded');
};

function closeShiftEditModal() {
  document.getElementById('shiftEditModal').classList.remove('open');
  _editShiftId = null;
}
function closeAmendModal() {
  document.getElementById('amendModal').classList.remove('open');
}

// ================================================================
// USER MANAGEMENT (admin + manager)
// ================================================================
async function inviteUser() {
  const email = document.getElementById('inviteEmail').value.trim();
  const name  = document.getElementById('inviteName').value.trim();
  const role  = document.getElementById('inviteRole').value;

  if (!email) { showToast('Please enter an email address'); return; }
  if (!name)  { showToast('Please enter a full name'); return; }
  if (role === 'admin' && !isAdmin()) { showToast('Only admins can create admin accounts'); return; }

  showLoading();
  // Call the Supabase Edge Function to create the user invite
  const { data, error } = await db.functions.invoke('invite-user', {
    body: { email, full_name: name, role }
  });
  hideLoading();

  if (error) { showToast('Error: ' + error.message); return; }
  if (data?.error) { showToast('Error: ' + data.error); return; }

  document.getElementById('inviteEmail').value = '';
  document.getElementById('inviteName').value  = '';
  await renderUsers();
  showToast(`Invite sent to ${email}`);
}

async function renderUsers() {
  const wrap = document.getElementById('usersTableWrap');
  wrap.innerHTML = '<div class="empty-state"><div class="icon" style="font-size:1.5rem">‚è≥</div><p>Loading...</p></div>';

  const { data, error } = await db.from('profiles').select('*').order('full_name');
  if (error) { wrap.innerHTML = '<div class="empty-state"><p>Error loading users.</p></div>'; return; }
  if (!data?.length) { wrap.innerHTML = '<div class="empty-state"><div class="icon">üë•</div><p>No users found.</p></div>'; return; }

  const canChangeRole   = isAdmin();
  const canDeactivate   = isAdmin();

  wrap.innerHTML = `<table class="users-table">
    <thead><tr>
      <th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th>
    </tr></thead>
    <tbody>${data.map(u => `
      <tr>
        <td><span style="display:inline-flex;align-items:center;gap:8px">
          <span style="width:30px;height:30px;border-radius:50%;background:${avColor(u.full_name||u.email)};display:inline-flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;color:white">${initials(u.full_name||u.email)}</span>
          ${esc(u.full_name || '‚Äî')}
        </span></td>
        <td style="color:var(--text-mid)">${esc(u.email || '')}</td>
        <td>${canChangeRole && u.id !== currentUser.id
          ? `<select class="role-select" onchange="updateUserRole('${u.id}', this.value)">
              <option value="staff"   ${u.role==='staff'  ?'selected':''}>Staff</option>
              <option value="manager" ${u.role==='manager'?'selected':''}>Manager</option>
              <option value="admin"   ${u.role==='admin'  ?'selected':''}>Admin</option>
             </select>`
          : roleLabel(u.role)}</td>
        <td><span style="font-size:0.78rem;color:${u.is_active?'var(--flag-green)':'var(--text-light)'}">${u.is_active ? '‚óè Active' : '‚óã Inactive'}</span></td>
        <td style="display:flex;gap:6px">
          ${canDeactivate && u.id !== currentUser.id
            ? `<button class="btn ${u.is_active?'btn-danger-outline':'btn-outline'}" style="padding:4px 10px;font-size:0.76rem"
                onclick="toggleUserActive('${u.id}', ${u.is_active})">${u.is_active ? 'Deactivate' : 'Reactivate'}</button>`
            : ''}
        </td>
      </tr>`).join('')}</tbody></table>`;
}

async function updateUserRole(userId, newRole) {
  if (!isAdmin()) { showToast('Only admins can change roles'); return; }
  showLoading();
  const { error } = await db.from('profiles').update({ role: newRole }).eq('id', userId);
  hideLoading();
  if (error) { showToast('Error: ' + error.message); return; }
  showToast('Role updated');
  await renderUsers();
}

async function toggleUserActive(userId, currentlyActive) {
  showLoading();
  const { error } = await db.from('profiles').update({ is_active: !currentlyActive }).eq('id', userId);
  hideLoading();
  if (error) { showToast('Error: ' + error.message); return; }
  showToast(currentlyActive ? 'User deactivated' : 'User reactivated');
  await renderUsers();
}

// ================================================================
// AUDIT LOG
// ================================================================
async function renderAuditLog() {
  const cont = document.getElementById('auditContainer');
  cont.innerHTML = '<div class="empty-state"><div class="icon" style="font-size:1.5rem">‚è≥</div><p>Loading...</p></div>';

  const { data, error } = await db.from('amendment_log')
    .select(`
      id, reason, changed_at,
      timesheet:timesheet_id ( date, start_time, end_time, staff:staff_id(name) ),
      amended_by_profile:amended_by ( full_name, email )
    `)
    .order('changed_at', { ascending: false })
    .limit(100);

  if (error) { cont.innerHTML = '<div class="empty-state"><p>Error loading audit log.</p></div>'; return; }
  if (!data?.length) { cont.innerHTML = '<div class="empty-state"><div class="icon">üìú</div><p>No amendments recorded yet.</p></div>'; return; }

  cont.innerHTML = data.map(a => {
    const who   = a.amended_by_profile?.full_name || a.amended_by_profile?.email || 'Unknown';
    const when  = a.changed_at ? new Date(a.changed_at).toLocaleString('en-GB') : '';
    const ts    = a.timesheet;
    const tsStr = ts ? `${ts.staff?.name || '?'} ‚Äî ${ts.date} ${ts.start_time?.slice(0,5)} to ${ts.end_time?.slice(0,5)}` : 'Unknown entry';
    return `<div class="audit-row">
      <div><span class="audit-who">${esc(who)}</span> amended: <strong>${esc(tsStr)}</strong></div>
      <div class="audit-meta">${esc(when)}</div>
      <div class="audit-reason">Reason: ${esc(a.reason || '‚Äî')}</div>
    </div>`;
  }).join('');
}

// ================================================================
// DASHBOARD
// ================================================================
function setDashPeriod(period) {
  const now = new Date();
  let from, to = now.toISOString().split('T')[0];
  if (period === 'week') {
    const d = new Date(now); d.setDate(d.getDate() - d.getDay() + 1);
    from = d.toISOString().split('T')[0];
  } else if (period === 'month') {
    from = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  } else { from = ''; to = ''; }
  document.getElementById('dashFrom').value = from;
  document.getElementById('dashTo').value   = to;
  renderDashboard();
}

async function renderDashboard() {
  const ff = document.getElementById('dashFrom').value;
  const ft = document.getElementById('dashTo').value;
  const fl = document.getElementById('dashLoc').value;
  const fs = document.getElementById('dashStaffFilter')?.value;

  let query = db.from('timesheets')
    .select('*, staff:staff_id(id,name), location:location_id(id,name)');
  if (ff) query = query.gte('date', ff);
  if (ft) query = query.lte('date', ft);
  if (fl) query = query.eq('location_id', fl);
  if (fs) query = query.eq('staff_id', fs);

  const { data: shifts, error } = await query;
  if (error) { console.error(error); return; }
  const allShifts = shifts || [];

  const totalHours  = allShifts.reduce((a, s) => a + (parseFloat(s.net_hours) || 0), 0);
  const totalShifts = allShifts.length;
  const uniqueStaff = new Set(allShifts.map(s => s.staff_id)).size;
  const violations  = allShifts.filter(s => s.break_warning).length;
  const avgShift    = totalShifts > 0 ? totalHours / totalShifts : 0;

  document.getElementById('kpiRow').innerHTML = `
    <div class="kpi-card accent"><div class="kpi-label">Total Net Hours</div><div class="kpi-value">${totalHours.toFixed(1)}</div><div class="kpi-sub">across ${totalShifts} shift${totalShifts!==1?'s':''}</div></div>
    <div class="kpi-card green"><div class="kpi-label">Active Staff</div><div class="kpi-value">${uniqueStaff}</div><div class="kpi-sub">in selected period</div></div>
    <div class="kpi-card amber"><div class="kpi-label">Avg Shift Length</div><div class="kpi-value">${avgShift.toFixed(1)}h</div><div class="kpi-sub">net hours</div></div>
    <div class="kpi-card ${violations>0?'red':'green'}"><div class="kpi-label">Break Violations</div><div class="kpi-value">${violations}</div><div class="kpi-sub">${violations>0?'require attention':'all compliant'}</div></div>`;

  const BAR_COLORS = ['#3d8bcd','#e8a020','#1a9a5a','#7056a0','#c97b2e','#b52e7e','#2e9fc9','#b54d2e'];
  const AVC = ['#2e7bc9','#7056a0','#1a9a5a','#c97b2e','#b54d2e','#2e9fc9','#a07c2e','#b52e7e'];

  function drawBars(containerId, data, colorFn) {
    const cont = document.getElementById(containerId);
    if (!data.length) { cont.innerHTML = '<div class="empty-state" style="padding:24px 0"><p>No data for this period.</p></div>'; return; }
    const max = Math.max(...data.map(d => d.val));
    cont.innerHTML = data.map((d, i) => `
      <div class="bar-row">
        <div class="bar-label" title="${esc(d.label)}">${esc(d.label)}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${max>0?(d.val/max*100):0}%;background:${colorFn(i)}"></div></div>
        <div class="bar-val">${d.val.toFixed(1)}h</div>
      </div>`).join('');
  }

  const byEmp = {};
  allShifts.forEach(s => { const n = s.staff?.name || 'Unknown'; byEmp[n] = (byEmp[n]||0) + (parseFloat(s.net_hours)||0); });
  drawBars('chartEmployee', Object.entries(byEmp).sort((a,b)=>b[1]-a[1]).map(([label,val])=>({label,val})), i=>AVC[i%AVC.length]);

  const byLoc = {};
  allShifts.forEach(s => { const l = s.location?.name || 'Unspecified'; byLoc[l] = (byLoc[l]||0) + (parseFloat(s.net_hours)||0); });
  drawBars('chartLocation', Object.entries(byLoc).sort((a,b)=>b[1]-a[1]).map(([label,val])=>({label,val})), i=>BAR_COLORS[i%BAR_COLORS.length]);

  const DOW = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const byDow = {Mon:0,Tue:0,Wed:0,Thu:0,Fri:0,Sat:0,Sun:0};
  allShifts.forEach(s => { if (!s.date) return; const d = new Date(s.date); const k = DOW[(d.getDay()+6)%7]; byDow[k] += parseFloat(s.net_hours)||0; });
  drawBars('chartDow', DOW.map(d=>({label:d,val:byDow[d]})), i=>['#3d8bcd','#3d8bcd','#3d8bcd','#3d8bcd','#3d8bcd','#e8a020','#7056a0'][i]);

  const violShifts = allShifts.filter(s => s.break_warning).slice(0, 12);
  const vc = document.getElementById('chartViolations');
  if (!violShifts.length) {
    vc.innerHTML = '<div class="empty-state" style="padding:24px 0"><div class="icon" style="font-size:1.5rem">‚úÖ</div><p>No violations in this period.</p></div>';
  } else {
    vc.innerHTML = violShifts.map(s => `
      <div class="violation-item">
        <div class="violation-dot"></div>
        <div>
          <strong>${esc(s.staff?.name||'?')}</strong> ‚Äî ${s.date} ${s.start_time?.slice(0,5)} to ${s.end_time?.slice(0,5)}
          ${s.location?.name ? `<span style="color:var(--text-light);font-size:0.75rem"> @ ${esc(s.location.name)}</span>` : ''}
          <div style="font-size:0.74rem;color:var(--text-light);margin-top:1px">
            Break taken: ${s.break_mins>0?s.break_mins+'m':'none'} | Required: ${s.required_break_mins}m
          </div>
        </div>
      </div>`).join('');
  }

  const staffMap = {};
  allShifts.forEach(s => {
    const n = s.staff?.name || 'Unknown';
    if (!staffMap[n]) staffMap[n] = { shifts:0, hours:0, locs:new Set(), violations:0 };
    const e = staffMap[n];
    e.shifts++;
    e.hours += parseFloat(s.net_hours)||0;
    if (s.location?.name) e.locs.add(s.location.name);
    if (s.break_warning) e.violations++;
  });
  const tbody = document.getElementById('staffSummaryBody');
  tbody.innerHTML = Object.entries(staffMap).sort((a,b)=>b[1].hours-a[1].hours).map(([name,d]) => `
    <tr>
      <td><span style="display:inline-flex;align-items:center;gap:8px"><span style="width:24px;height:24px;border-radius:50%;background:${avColor(name)};display:inline-flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:700;color:white">${initials(name)}</span>${esc(name)}</span></td>
      <td>${d.shifts}</td>
      <td style="font-weight:600">${d.hours.toFixed(2)}h</td>
      <td>${d.shifts>0?(d.hours/d.shifts).toFixed(2)+'h':'‚Äî'}</td>
      <td style="font-size:0.78rem;color:var(--text-mid)">${[...d.locs].join(', ')||'‚Äî'}</td>
      <td>${d.violations>0?`<span class="break-flag error">‚ö† ${d.violations}</span>`:'<span class="break-flag ok">‚úì 0</span>'}</td>
    </tr>`).join('');
  if (!tbody.innerHTML) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-light);font-style:italic">No data for this period</td></tr>';
}

// ================================================================
// EXPORT CSV
// ================================================================
async function exportCSV() {
  showLoading();
  const { data: recs, error } = await db.from('timesheets')
    .select('*, staff:staff_id(name), location:location_id(name)')
    .order('date', { ascending: false });
  hideLoading();
  if (error || !recs?.length) { showToast('No records to export'); return; }

  let csv = 'Name,Location,Date,Start,End,Break Taken (mins),Break Required (mins),Net Hours,Break Violation\n';
  recs.forEach(r => {
    csv += `"${r.staff?.name||''}","${r.location?.name||''}",${r.date},${r.start_time?.slice(0,5)||''},${r.end_time?.slice(0,5)||''},${r.break_mins||0},${r.required_break_mins||0},${r.net_hours?parseFloat(r.net_hours).toFixed(2):''},${r.break_warning?'YES':'No'}\n`;
  });

  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
  a.download = `gwoc-timesheets-${today()}.csv`;
  a.click();
  showToast('CSV downloaded');
}

// ================================================================
// CONFIRM MODAL
// ================================================================
let _mc = null;
function showConfirm(title, msg, cb) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMsg').textContent   = msg;
  document.getElementById('modalConfirmBtn').style.display = '';
  _mc = cb;
  document.getElementById('confirmModal').classList.add('open');
}
function closeModal() {
  document.getElementById('confirmModal').classList.remove('open');
  _mc = null;
}
document.getElementById('modalConfirmBtn').onclick = () => { if (_mc) _mc(); closeModal(); };
document.getElementById('confirmModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

// Keyboard support
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeModal();
    closeAmendModal();
    closeShiftEditModal();
  }
  if (e.key === 'Enter' && document.getElementById('authScreen').style.display !== 'none') {
    if (document.getElementById('signInPanel').style.display !== 'none') signIn();
  }
});
</script>
</body>
</html>
