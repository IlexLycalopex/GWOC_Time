<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GWOC Timesheet System</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --ink:#0f1923; --deep:#1b2b3a; --mid:#2c4a63; --accent:#3d8bcd; --accent2:#e8a020;
  --cream:#f0f4f8; --milk:#f8fafc; --steam:#dde4ec; --chalk:#eaf0f6;
  --flag-red:#c0392b; --flag-green:#1a9a5a; --flag-amber:#d4820a;
  --text-dark:#0f1923; --text-mid:#3a5068; --text-light:#7a95aa;
  --border:rgba(44,74,99,0.15); --shadow:0 2px 14px rgba(15,25,35,0.09);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--milk);color:var(--text-dark);min-height:100vh;
  background-image:radial-gradient(ellipse at 8% 0%,rgba(61,139,205,0.07) 0%,transparent 55%),radial-gradient(ellipse at 92% 100%,rgba(232,160,32,0.05) 0%,transparent 55%)}

/* HEADER */
header{background:var(--ink);color:var(--cream);padding:0 28px;display:flex;align-items:stretch;box-shadow:0 2px 18px rgba(0,0,0,0.35);position:sticky;top:0;z-index:200}
.logo{display:flex;align-items:center;gap:12px;padding:13px 0;flex-shrink:0;text-decoration:none;color:inherit}
.swallow-icon{width:38px;height:38px;flex-shrink:0}
.logo-text h1{font-family:'Playfair Display',serif;font-size:1.25rem;letter-spacing:0.03em;color:var(--cream)}
.logo-text span{font-size:0.65rem;color:rgba(240,244,248,0.5);display:block;font-weight:400;letter-spacing:0.1em;text-transform:uppercase;margin-top:-1px}
nav{display:flex;align-items:stretch;margin-left:24px;flex:1;overflow-x:auto}
.nav-tab{display:flex;align-items:center;gap:6px;padding:0 16px;color:rgba(240,244,248,0.45);font-size:0.83rem;font-weight:500;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.15s;user-select:none;white-space:nowrap}
.nav-tab:hover{color:var(--cream);background:rgba(255,255,255,0.04)}
.nav-tab.active{color:var(--cream);border-bottom-color:var(--accent);background:rgba(255,255,255,0.04)}
.nav-badge{background:var(--accent);color:white;font-size:0.63rem;font-weight:700;padding:1px 6px;border-radius:20px;min-width:18px;text-align:center}
.nav-admin{margin-left:auto;color:rgba(240,244,248,0.35);font-size:0.8rem}
.nav-admin:hover{color:var(--accent2);background:rgba(232,160,32,0.06)}
.nav-admin.active{color:var(--accent2);border-bottom-color:var(--accent2)}

/* LAYOUT */
main{max-width:1080px;margin:0 auto;padding:26px 20px}
.page{display:none}.page.active{display:block}

/* BUTTONS */
.btn{padding:8px 18px;border:none;border-radius:7px;font-family:'DM Sans',sans-serif;font-weight:500;font-size:0.84rem;cursor:pointer;transition:all 0.15s}
.btn-primary{background:var(--accent);color:white}.btn-primary:hover{background:#2d7ab8;transform:translateY(-1px)}
.btn-secondary{background:var(--accent2);color:white}.btn-secondary:hover{background:#c27010;transform:translateY(-1px)}
.btn-outline{background:transparent;color:var(--text-mid);border:1.5px solid var(--steam)}.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-danger-outline{background:transparent;color:var(--flag-red);border:1px solid rgba(192,57,43,0.35);padding:5px 11px;font-size:0.8rem}.btn-danger-outline:hover{background:rgba(192,57,43,0.07)}
.btn-red{background:var(--flag-red);color:white}.btn-red:hover{background:#a93226}

/* CARDS */
.card{background:white;border-radius:13px;box-shadow:var(--shadow);border:1px solid var(--border);overflow:hidden;margin-bottom:24px}
.card-header{background:var(--deep);color:var(--cream);padding:13px 22px;display:flex;align-items:center;gap:10px}
.card-header h2{font-family:'Playfair Display',serif;font-size:1rem;font-weight:600}
.card-body{padding:22px}

/* FORM */
.field-group{display:flex;flex-direction:column;gap:4px}
.field-group label{font-size:0.7rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.07em}
.field-group input,.field-group select{padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.88rem;color:var(--text-dark);background:var(--milk);transition:border-color 0.15s;-webkit-appearance:none;appearance:none}
.field-group input:focus,.field-group select:focus{outline:none;border-color:var(--accent);background:white}

/* AUTOCOMPLETE */
.ac-wrap{position:relative}
.ac-drop{position:absolute;top:calc(100% + 4px);left:0;right:0;background:white;border:1.5px solid var(--accent);border-radius:9px;box-shadow:0 8px 28px rgba(15,25,35,0.14);z-index:400;overflow:hidden;max-height:220px;overflow-y:auto}
.ac-item{padding:8px 13px;font-size:0.88rem;cursor:pointer;display:flex;align-items:center;gap:9px;transition:background 0.1s;color:var(--text-dark);border-bottom:1px solid var(--steam)}
.ac-item:last-child{border-bottom:none}.ac-item:hover,.ac-item.hl{background:var(--chalk)}
.ac-av{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.68rem;font-weight:700;color:white;flex-shrink:0}
.ac-role-lbl{font-size:0.72rem;color:var(--text-light);margin-left:auto;font-style:italic}
.ac-empty{padding:10px 14px;font-size:0.84rem;color:var(--text-light);font-style:italic;text-align:center}

/* SHIFTS TABLE */
.shifts-table{width:100%;border-collapse:collapse}
.shifts-table thead tr{background:var(--chalk);border-bottom:1.5px solid var(--steam)}
.shifts-table th{padding:8px 7px;font-size:0.66rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.06em;text-align:left}
.shift-row td{padding:7px 5px;border-bottom:1px solid var(--steam);vertical-align:middle}
.shift-row td select,.shift-row td input[type="date"]{padding:6px 7px;border:1.5px solid var(--steam);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:0.82rem;color:var(--text-dark);background:var(--milk);width:100%;-webkit-appearance:none;appearance:none;cursor:pointer}
.shift-row td select:focus,.shift-row td input:focus{outline:none;border-color:var(--accent);background:white}
.add-row-btn{display:flex;align-items:center;gap:6px;background:none;border:1.5px dashed var(--accent);color:var(--accent);padding:7px 15px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.84rem;font-weight:500;cursor:pointer;transition:all 0.15s;margin-top:10px}
.add-row-btn:hover{background:rgba(61,139,205,0.05)}
.del-row-btn{background:none;border:none;color:var(--text-light);cursor:pointer;font-size:1.05rem;padding:4px 7px;border-radius:4px;transition:color 0.12s;display:block;margin:0 auto}
.del-row-btn:hover{color:var(--flag-red)}

/* BREAK FLAGS */
.break-flag{display:inline-flex;align-items:center;gap:4px;padding:3px 7px;border-radius:4px;font-size:0.69rem;font-weight:600;white-space:nowrap}
.break-flag.ok{background:rgba(26,154,90,0.1);color:var(--flag-green);border:1px solid rgba(26,154,90,0.25)}
.break-flag.error{background:rgba(192,57,43,0.1);color:var(--flag-red);border:1px solid rgba(192,57,43,0.25)}
.break-flag.warn{background:rgba(212,130,10,0.1);color:var(--flag-amber);border:1px solid rgba(212,130,10,0.25)}
.hours-cell{font-weight:600;font-size:0.84rem;text-align:center}

/* BREAK RULE NOTE */
.break-rule-note{background:var(--chalk);border-left:3px solid var(--accent);border-radius:0 7px 7px 0;padding:10px 14px;margin-top:12px;font-size:0.77rem;color:var(--text-mid);line-height:1.55}
.break-rule-note strong{color:var(--text-dark)}

/* RECORDS */
.rec-controls{padding:12px 22px;display:flex;gap:12px;align-items:center;background:var(--chalk);border-bottom:1px solid var(--border);flex-wrap:wrap}
.rec-controls input,.rec-controls select{padding:6px 10px;border:1.5px solid var(--steam);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:0.84rem;background:white;color:var(--text-dark);-webkit-appearance:none;appearance:none}
.rec-controls input:focus,.rec-controls select:focus{outline:none;border-color:var(--accent)}
.rec-controls label{font-size:0.69rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.06em}
table.rec-table{width:100%;border-collapse:collapse}
.rec-table thead{background:var(--ink);color:var(--cream)}
.rec-table th{padding:10px 12px;font-size:0.66rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;text-align:left}
.rec-table tbody tr{border-bottom:1px solid var(--steam);transition:background 0.1s}
.rec-table tbody tr:hover{background:var(--milk)}
.rec-table td{padding:9px 12px;font-size:0.84rem;vertical-align:middle}
.rec-table td:nth-child(1){font-weight:600;color:var(--deep)}
.empty-state{text-align:center;padding:42px 22px;color:var(--text-light)}
.empty-state .icon{font-size:2.2rem;margin-bottom:9px}
.empty-state p{font-size:0.88rem}
.summary-bar{padding:10px 22px;background:var(--chalk);border-top:1px solid var(--border);display:flex;gap:20px;font-size:0.8rem;color:var(--text-mid);flex-wrap:wrap}
.summary-bar strong{color:var(--text-dark)}
.form-actions{display:flex;gap:10px;margin-top:18px;justify-content:flex-end}

/* ENTITY GRIDS (staff, locations) */
.entity-add-form{display:flex;gap:11px;align-items:flex-end;padding-bottom:22px;margin-bottom:22px;border-bottom:1.5px solid var(--steam);flex-wrap:wrap}
.entity-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.entity-card{background:var(--chalk);border:1.5px solid var(--steam);border-radius:10px;padding:12px 14px;display:flex;align-items:center;gap:11px;transition:border-color 0.15s,box-shadow 0.15s}
.entity-card:hover{border-color:var(--accent);box-shadow:0 2px 10px rgba(61,139,205,0.1)}
.entity-avatar{width:38px;height:38px;flex-shrink:0;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:white}
.loc-icon{width:38px;height:38px;flex-shrink:0;border-radius:9px;background:var(--mid);display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.entity-info{flex:1;min-width:0}
.entity-name{font-weight:600;font-size:0.9rem;color:var(--deep);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.entity-sub{font-size:0.72rem;color:var(--text-light);margin-top:2px}
.entity-del{background:none;border:none;color:var(--text-light);cursor:pointer;font-size:0.95rem;padding:3px;border-radius:4px;transition:color 0.12s;flex-shrink:0}
.entity-del:hover{color:var(--flag-red)}

/* ===== DASHBOARD ===== */
.dash-filters{display:flex;gap:14px;align-items:flex-end;margin-bottom:22px;flex-wrap:wrap;padding:16px 20px;background:white;border-radius:13px;box-shadow:var(--shadow);border:1px solid var(--border)}
.dash-filters .field-group{min-width:130px}

/* KPI row */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:22px}
.kpi-card{background:white;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--border);padding:16px 18px;display:flex;flex-direction:column;gap:4px}
.kpi-label{font-size:0.68rem;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:0.08em}
.kpi-value{font-size:1.6rem;font-weight:700;color:var(--deep);line-height:1.1;font-family:'Playfair Display',serif}
.kpi-sub{font-size:0.72rem;color:var(--text-mid)}
.kpi-card.accent{border-top:3px solid var(--accent)}
.kpi-card.amber{border-top:3px solid var(--accent2)}
.kpi-card.green{border-top:3px solid var(--flag-green)}
.kpi-card.red{border-top:3px solid var(--flag-red)}

/* Two-column dashboard layout */
.dash-cols{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
@media(max-width:700px){.dash-cols{grid-template-columns:1fr}}

.dash-card{background:white;border-radius:13px;box-shadow:var(--shadow);border:1px solid var(--border);overflow:hidden}
.dash-card-hdr{background:var(--deep);color:var(--cream);padding:12px 18px;display:flex;align-items:center;gap:8px;font-family:'Playfair Display',serif;font-size:0.92rem;font-weight:600}
.dash-card-body{padding:18px}

/* Bar chart rows */
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:9px}
.bar-label{font-size:0.8rem;color:var(--text-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:90px;max-width:120px}
.bar-track{flex:1;height:9px;background:var(--steam);border-radius:5px;overflow:hidden}
.bar-fill{height:100%;border-radius:5px;transition:width 0.5s ease}
.bar-val{font-size:0.78rem;font-weight:600;color:var(--text-mid);min-width:40px;text-align:right}

/* Table inside dash */
.dash-table{width:100%;border-collapse:collapse;font-size:0.82rem}
.dash-table th{padding:7px 10px;font-size:0.66rem;font-weight:600;text-transform:uppercase;letter-spacing:0.07em;color:var(--text-light);border-bottom:1.5px solid var(--steam);text-align:left}
.dash-table td{padding:8px 10px;border-bottom:1px solid var(--steam);vertical-align:middle}
.dash-table tr:last-child td{border-bottom:none}
.dash-table tr:hover td{background:var(--milk)}
.dash-table td:first-child{font-weight:600;color:var(--deep)}

/* Violations list */
.violation-item{display:flex;align-items:flex-start;gap:10px;padding:9px 0;border-bottom:1px solid var(--steam);font-size:0.82rem}
.violation-item:last-child{border-bottom:none}
.violation-dot{width:8px;height:8px;border-radius:50%;background:var(--flag-red);flex-shrink:0;margin-top:4px}
.violation-dot.warn{background:var(--flag-amber)}

/* ADMIN */
#adminLock{max-width:360px;margin:60px auto;text-align:center}
#adminLock .lock-icon{font-size:3rem;margin-bottom:14px}
#adminLock h2{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--deep);margin-bottom:6px}
#adminLock p{font-size:0.85rem;color:var(--text-mid);margin-bottom:20px}
#adminLock input{width:100%;padding:10px 14px;border:1.5px solid var(--steam);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.95rem;margin-bottom:10px;background:var(--milk);text-align:center;letter-spacing:0.1em}
#adminLock input:focus{outline:none;border-color:var(--accent)}
#adminLock .lock-err{color:var(--flag-red);font-size:0.82rem;margin-top:8px;display:none}
.admin-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.admin-action-card{background:white;border-radius:13px;border:1px solid var(--border);box-shadow:var(--shadow);padding:20px}
.admin-action-card h3{font-family:'Playfair Display',serif;font-size:0.96rem;color:var(--deep);margin-bottom:6px}
.admin-action-card p{font-size:0.79rem;color:var(--text-mid);margin-bottom:14px;line-height:1.5}
.admin-logout{display:flex;justify-content:flex-end;margin-bottom:16px}
.upload-zone{border:2px dashed var(--steam);border-radius:9px;padding:20px 14px;text-align:center;cursor:pointer;transition:border-color 0.15s,background 0.15s;font-size:0.81rem;color:var(--text-light)}
.upload-zone:hover{border-color:var(--accent);background:rgba(61,139,205,0.03);color:var(--accent)}
.upload-zone input[type="file"]{display:none}
.upload-zone .upload-icon{font-size:1.7rem;margin-bottom:5px;display:block}

/* GOOGLE SHEETS SYNC */
.sync-card{background:white;border-radius:13px;border:1px solid var(--border);box-shadow:var(--shadow);padding:20px;grid-column:1/-1}
.sync-card h3{font-family:'Playfair Display',serif;font-size:0.96rem;color:var(--deep);margin-bottom:6px;display:flex;align-items:center;gap:8px}
.sync-url-row{display:flex;gap:8px;margin-bottom:12px}
.sync-url-row input{flex:1;padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.84rem;color:var(--text-dark);background:var(--milk)}
.sync-url-row input:focus{outline:none;border-color:var(--accent);background:white}
.sync-status{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;font-size:0.82rem;margin-top:12px;min-height:40px}
.sync-status.idle{background:var(--chalk);color:var(--text-mid)}
.sync-status.syncing{background:rgba(61,139,205,0.08);color:var(--accent);border:1px solid rgba(61,139,205,0.2)}
.sync-status.success{background:rgba(26,154,90,0.09);color:var(--flag-green);border:1px solid rgba(26,154,90,0.22)}
.sync-status.error{background:rgba(192,57,43,0.08);color:var(--flag-red);border:1px solid rgba(192,57,43,0.2)}
.sync-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.sync-status.idle .sync-dot{background:var(--text-light)}
.sync-status.syncing .sync-dot{background:var(--accent);animation:pulse 1s infinite}
.sync-status.success .sync-dot{background:var(--flag-green)}
.sync-status.error .sync-dot{background:var(--flag-red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.sync-meta{font-size:0.75rem;color:var(--text-light);margin-top:6px}

/* TOAST + MODAL */
.toast{position:fixed;bottom:22px;right:22px;background:var(--ink);color:var(--cream);padding:10px 17px;border-radius:8px;font-size:0.85rem;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,0.28);transform:translateY(70px);opacity:0;transition:all 0.3s ease;z-index:9999;max-width:320px}
.toast.show{transform:translateY(0);opacity:1}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:500}
.modal-overlay.open{display:flex}
.modal{background:white;border-radius:13px;padding:26px;max-width:400px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.25)}
.modal h3{font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:10px;color:var(--deep)}
.modal p{font-size:0.85rem;color:var(--text-mid);margin-bottom:18px;line-height:1.6}
.modal-actions{display:flex;gap:10px;justify-content:flex-end}

@media(max-width:720px){
  header{padding:0 12px;flex-wrap:wrap}
  nav{margin-left:0;order:3;width:100%;border-top:1px solid rgba(255,255,255,0.06)}
  .nav-tab{padding:0 11px;font-size:0.78rem}
  main{padding:14px 10px}
  .card-body{padding:14px}
  .logo-text h1{font-size:1.05rem}
  .admin-grid{grid-template-columns:1fr}
  .kpi-row{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<div id="authPage" style="display:none;min-height:100vh;align-items:center;justify-content:center;padding:28px">
  <div class="card" style="max-width:420px;width:100%">
    <div class="card-header"><span>üîê</span><h2>Sign in</h2></div>
    <div class="card-body">
      <div class="field-group" style="margin-bottom:12px">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="name@example.com" autocomplete="email">
      </div>
      <div class="field-group" style="margin-bottom:14px">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')authSignIn()">
      </div>
      <div class="form-actions" style="justify-content:space-between;align-items:center">
        <button class="btn btn-outline" onclick="authResetPw()">Reset password</button>
        <button class="btn btn-primary" onclick="authSignIn()">Sign in</button>
      </div>
      <div style="margin-top:12px;font-size:0.8rem;color:var(--text-mid);line-height:1.5">
        <div><strong>Admin note:</strong> Set <span style="font-family:monospace">SUPABASE_URL</span> and <span style="font-family:monospace">SUPABASE_ANON_KEY</span> in the script.</div>
      </div>
      <div class="lock-err" id="authErr" style="display:none;margin-top:12px;text-align:left"></div>
    </div>
  </div>
</div>

<header>
  <a class="logo" href="#" onclick="switchPage('dashboard');return false;">
    <svg class="swallow-icon" viewBox="0 0 80 60" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M40 28 C36 22,20 14,4 18 C12 20,18 24,20 30 C16 28,8 27,2 30 C10 32,16 34,18 40 C14 40,6 42,2 48 C12 44,22 40,28 36 C30 42,32 50,34 58 C36 50,38 40,40 34 C42 40,44 50,46 58 C48 50,50 42,52 36 C58 40,68 44,78 48 C74 42,66 40,62 40 C64 34,70 32,78 30 C72 27,64 28,60 30 C62 24,68 20,76 18 C60 14,44 22,40 28Z" fill="#3d8bcd"/>
      <circle cx="40" cy="26" r="3" fill="#e8a020"/>
    </svg>
    <div class="logo-text"><h1>GWOC</h1><span>Timesheet System</span></div>
  </a>
  <nav>
    <div class="nav-tab" id="tab-dashboard" onclick="switchPage('dashboard')">üìä Dashboard</div>
    <div class="nav-tab active" id="tab-timesheets" onclick="switchPage('timesheets')">üóì Timesheets</div>
    <div class="nav-tab" id="tab-staff" onclick="switchPage('staff')">üë§ Staff <span class="nav-badge" id="staffBadge">0</span></div>
    <div class="nav-tab" id="tab-locations" onclick="switchPage('locations')">üìç Locations <span class="nav-badge" id="locBadge" style="background:var(--accent2)">0</span></div>
    <div class="nav-tab nav-admin" id="tab-admin" onclick="switchPage('admin')">‚öô Admin</div>
    <div class="nav-tab" id="tab-user" style="margin-left:auto;cursor:default;pointer-events:none;color:rgba(240,244,248,0.55)"></div>
    <div class="nav-tab" id="tab-logout" onclick="authSignOut()" style="color:rgba(240,244,248,0.45)">‚éã Sign out</div>
  </nav>
</header>

<main>

<!-- ==================== DASHBOARD ==================== -->
<div class="page" id="page-dashboard">

  <div class="dash-filters">
    <div class="field-group">
      <label>From</label>
      <input type="date" id="dashFrom" onchange="renderDashboard()">
    </div>
    <div class="field-group">
      <label>To</label>
      <input type="date" id="dashTo" onchange="renderDashboard()">
    </div>
    <div class="field-group">
      <label>Location</label>
      <select id="dashLoc" onchange="renderDashboard()">
        <option value="">All locations</option>
      </select>
    </div>
    <button class="btn btn-outline" onclick="setDashPeriod('week')">This Week</button>
    <button class="btn btn-outline" onclick="setDashPeriod('month')">This Month</button>
    <button class="btn btn-outline" onclick="setDashPeriod('all')">All Time</button>
  </div>

  <!-- KPI row -->
  <div class="kpi-row" id="kpiRow"></div>

  <!-- Charts row -->
  <div class="dash-cols">
    <div class="dash-card">
      <div class="dash-card-hdr">üë§ Hours by Employee</div>
      <div class="dash-card-body" id="chartEmployee"></div>
    </div>
    <div class="dash-card">
      <div class="dash-card-hdr">üìç Hours by Location</div>
      <div class="dash-card-body" id="chartLocation"></div>
    </div>
  </div>

  <div class="dash-cols">
    <div class="dash-card">
      <div class="dash-card-hdr">üìÖ Hours by Day of Week</div>
      <div class="dash-card-body" id="chartDow"></div>
    </div>
    <div class="dash-card">
      <div class="dash-card-hdr">‚ö† Break Violations</div>
      <div class="dash-card-body" id="chartViolations"></div>
    </div>
  </div>

  <!-- Detail table -->
  <div class="dash-card" style="margin-bottom:0">
    <div class="dash-card-hdr">üìã Staff Summary Table</div>
    <div class="dash-card-body" style="padding:0;overflow-x:auto">
      <table class="dash-table" id="staffSummaryTable">
        <thead><tr>
          <th>Name</th><th>Shifts</th><th>Total Hours</th><th>Avg Shift</th><th>Locations</th><th>Violations</th>
        </tr></thead>
        <tbody id="staffSummaryBody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- ==================== TIMESHEETS ==================== -->
<div class="page active" id="page-timesheets">
  <div class="card">
    <div class="card-header"><span>‚úèÔ∏è</span><h2>Log Shifts</h2></div>
    <div class="card-body">
      <div style="display:flex;gap:14px;margin-bottom:16px;flex-wrap:wrap;align-items:flex-end">
        <div class="field-group" style="min-width:220px;max-width:300px;flex:1">
          <label>Staff Name</label>
          <div class="ac-wrap">
            <input type="text" id="staffName" placeholder="Type or search name..." autocomplete="off"
              oninput="acInput('staffName','acDropStaff',loadStaff,'name')"
              onkeydown="acKeydown(event,'staffName','acDropStaff',loadStaff,'name')"
              onfocus="acInput('staffName','acDropStaff',loadStaff,'name')"
              onblur="acBlur('acDropStaff')">
            <div class="ac-drop" id="acDropStaff" style="display:none"></div>
          </div>
        </div>
      </div>
      <table class="shifts-table">
        <thead><tr>
          <th style="width:112px">Date</th>
          <th style="width:90px">Start</th>
          <th style="width:90px">End</th>
          <th style="width:130px">Location</th>
          <th style="width:110px">Break Taken</th>
          <th style="width:62px">Net Hrs</th>
          <th style="width:144px">Status</th>
          <th style="width:34px"></th>
        </tr></thead>
        <tbody id="shiftRows"></tbody>
      </table>
      <button class="add-row-btn" onclick="addShiftRow()"><span style="font-size:1.1rem;font-weight:700">+</span> Add Shift Row</button>
      <div class="break-rule-note">
        <strong>Break rules:</strong> A 15-minute unpaid break is required for every complete 6-hour block worked.
        Examples: under 6h = no break required; 6‚Äì11h 59m = 15 min; 12‚Äì17h 59m = 30 min; 18‚Äì23h 59m = 45 min.
        Maximum break that can be logged is <strong>90 minutes</strong>. Break time is deducted from gross hours to give net hours.
        Amber flag = insufficient break logged. Red flag = no break logged at all.
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="resetForm()">Clear Form</button>
        <button class="btn btn-primary" onclick="saveEntry()">Save Timesheet</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><span>üìã</span><h2>Timesheet Records</h2></div>
    <div class="rec-controls">
      <div><label>Staff</label><br><input type="text" id="filterName" placeholder="Name..." oninput="renderRecords()" style="margin-top:3px;width:130px"></div>
      <div><label>Location</label><br><select id="filterLoc" onchange="renderRecords()" style="margin-top:3px;width:130px"><option value="">All</option></select></div>
      <div><label>From</label><br><input type="date" id="filterFrom" onchange="renderRecords()" style="margin-top:3px"></div>
      <div><label>To</label><br><input type="date" id="filterTo" onchange="renderRecords()" style="margin-top:3px"></div>
    </div>
    <div id="recordsContainer"></div>
    <div class="summary-bar" id="summaryBar"></div>
  </div>
</div>

<!-- ==================== STAFF ==================== -->
<div class="page" id="page-staff">
  <div class="card">
    <div class="card-header"><span>üë§</span><h2>Staff Directory</h2></div>
    <div class="card-body">
      <div class="entity-add-form">
        <div class="field-group" style="min-width:130px;flex:1"><label>First Name</label><input type="text" id="newFirst" placeholder="e.g. Sarah" autocomplete="off" onkeydown="if(event.key==='Enter')addStaff()"></div>
        <div class="field-group" style="min-width:130px;flex:1"><label>Last Name</label><input type="text" id="newLast" placeholder="e.g. Mitchell" autocomplete="off" onkeydown="if(event.key==='Enter')addStaff()"></div>
        <div class="field-group" style="min-width:120px;flex:1"><label>Role <span style="font-weight:400;font-size:0.68rem">(optional)</span></label><input type="text" id="newRole" placeholder="e.g. Barista" autocomplete="off" onkeydown="if(event.key==='Enter')addStaff()"></div>
        <button class="btn btn-primary" onclick="addStaff()" style="flex-shrink:0;white-space:nowrap">Add Staff Member</button>
      </div>
      <div id="staffGrid"></div>
    </div>
  </div>
</div>

<!-- ==================== LOCATIONS ==================== -->
<div class="page" id="page-locations">
  <div class="card">
    <div class="card-header"><span>üìç</span><h2>Locations</h2></div>
    <div class="card-body">
      <div class="entity-add-form">
        <div class="field-group" style="min-width:160px;flex:1"><label>Location Name</label><input type="text" id="newLocName" placeholder="e.g. High Street" autocomplete="off" onkeydown="if(event.key==='Enter')addLocation()"></div>

        <button class="btn btn-primary" onclick="addLocation()" style="flex-shrink:0">Add Location</button>
      </div>
      <div id="locGrid"></div>
    </div>
  </div>
</div>

<!-- ==================== ADMIN ==================== -->
<!-- ==================== ADMIN ==================== -->
<div class="page" id="page-admin">
  <div class="card">
    <div class="card-header"><span>‚öô</span><h2>Admin</h2></div>
    <div class="card-body">

      <div class="admin-grid">

        <div class="admin-action-card" style="grid-column:1/-1">
          <h3>üë• Invite User</h3>
          <p>Create a user and send an invite email. Roles: staff (default), manager, admin.</p>
          <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
            <div class="field-group" style="min-width:220px;flex:1">
              <label>Email</label>
              <input type="email" id="inviteEmail" placeholder="name@example.com">
            </div>
            <div class="field-group" style="min-width:220px;flex:1">
              <label>Full name</label>
              <input type="text" id="inviteName" placeholder="Full name">
            </div>
            <div class="field-group" style="min-width:140px">
              <label>Role</label>
              <select id="inviteRole">
                <option value="staff">staff</option>
                <option value="manager">manager</option>
                <option value="admin">admin</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="adminInvite()">Send invite</button>
          </div>
          <div style="margin-top:10px;font-size:0.8rem;color:var(--text-mid)" id="inviteStatus"></div>
        </div>

        <div class="admin-action-card">
          <h3>üì• Export Shifts CSV</h3>
          <p>Download shifts (flat rows) as CSV.</p>
          <button class="btn btn-primary" onclick="exportCSV()">Download CSV</button>
        </div>

        <div class="admin-action-card">
          <h3 style="color:var(--flag-red)">üóë Clear Shift Data</h3>
          <p>Permanently delete all shifts.</p>
          <button class="btn btn-red" onclick="clearTimesheets()">Clear all shifts</button>
        </div>

      </div>

      <div class="break-rule-note" style="margin-top:16px">
        <strong>Roles:</strong> staff can view and submit their own shifts; managers can view all shifts and edit with a mandatory note; admins can do everything plus invite users and manage locations.
      </div>

    </div>
  </div>
</div>

</main>

<div class="modal-overlay" id="editShiftModal">
  <div class="modal" style="max-width:520px;width:92%">
    <h3>‚úèÔ∏è Edit shift</h3>
    <p style="margin-bottom:10px">Managers and admins must add a note explaining why they changed a shift.</p>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div class="field-group">
        <label>Date</label>
        <input type="date" id="edit_date">
      </div>
      <div class="field-group">
        <label>Location</label>
        <select id="edit_location"></select>
      </div>
      <div class="field-group">
        <label>Start</label>
        <select id="edit_start"></select>
      </div>
      <div class="field-group">
        <label>End</label>
        <select id="edit_end"></select>
      </div>
      <div class="field-group" style="grid-column:1/-1">
        <label>Break taken (mins)</label>
        <select id="edit_break"></select>
      </div>
      <div class="field-group" style="grid-column:1/-1">
        <label>Mandatory note</label>
        <input type="text" id="edit_note" placeholder="Reason for change (required)">
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeEditShift()">Cancel</button>
      <button class="btn btn-primary" onclick="saveEditShift()">Save changes</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3 id="modalTitle">Confirm</h3><p id="modalMsg"></p>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-red" id="modalConfirmBtn">Delete</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ================================================================
// SUPABASE CONFIG
// ================================================================
// 1) Create a Supabase project
// 2) Paste your project URL + anon key below
// 3) Create tables + RLS policies (see notes in repo / previous guidance)
//
// IMPORTANT: Do NOT put your service role key in this file.
const SUPABASE_URL = https://mafbfgvotsjscczjmjmx.supabase.co;
const SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hZmJmZ3ZvdHNqc2Njemptam14Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NDE4MTIsImV4cCI6MjA4NzExNzgxMn0.6oLTvdh4Pf7YJ-BDfhV3gOe6HphJJwYs-am96kcnK8Q;

let sb = null;

// Current session context
let currentUser = null;
let currentProfile = null; // { user_id, full_name, email, role }
let currentRole = 'staff'; // staff | manager | admin

// Cached reference data
let cachedLocations = [];  // [{id,name}]
let cachedProfiles  = [];  // [{user_id, full_name, email, role}]

// Editing context
let editingShiftId = null;

// ================================================================
// UTILITIES
// ================================================================
function $(id){ return document.getElementById(id); }
function showToast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3200); }

let _mc = null;
function showConfirm(title, msg, cb) {
  $('modalTitle').textContent = title;
  $('modalMsg').textContent   = msg;
  _mc = cb;
  $('confirmModal').classList.add('open');
}
function closeModal() { $('confirmModal').classList.remove('open'); _mc = null; }
$('modalConfirmBtn').onclick = () => { if (_mc) _mc(); closeModal(); };
$('confirmModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

function showAuth(errMsg='') {
  document.querySelector('header').style.display='none';
  document.querySelector('main').style.display='none';
  $('authPage').style.display='flex';
  $('tab-logout').style.display='none';
  $('tab-user').style.display='none';
  if (errMsg) { $('authErr').style.display='block'; $('authErr').textContent = errMsg; }
  else { $('authErr').style.display='none'; $('authErr').textContent=''; }
}
function hideAuth() {
  $('authPage').style.display='none';
  document.querySelector('header').style.display='';
  document.querySelector('main').style.display='';
  $('tab-logout').style.display='';
  $('tab-user').style.display='';
}

// ================================================================
// NAVIGATION + ROLE GATING
// ================================================================
function setNavForRole(role) {
  // Staff: dashboard + timesheets. Manager: plus staff directory. Admin: plus locations + admin.
  const showStaffTab = (role === 'manager' || role === 'admin');
  const showLocTab   = (role === 'admin');
  const showAdminTab = (role === 'admin');

  $('tab-staff').style.display     = showStaffTab ? '' : 'none';
  $('tab-locations').style.display = showLocTab   ? '' : 'none';
  $('tab-admin').style.display     = showAdminTab ? '' : 'none';

  // Default page if user is on something they cannot access
  const active = document.querySelector('.page.active')?.id?.replace('page-','') || 'timesheets';
  const allowed = new Set(['dashboard','timesheets']);
  if (showStaffTab) allowed.add('staff');
  if (showLocTab) allowed.add('locations');
  if (showAdminTab) allowed.add('admin');
  if (!allowed.has(active)) switchPage('timesheets');
}

function switchPage(p) {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
  $('page-' + p).classList.add('active');
  const tab = $('tab-' + p);
  if (tab) tab.classList.add('active');

  if (p === 'timesheets') { renderRecords(); populateLocFilter(); }
  if (p === 'staff')      { renderStaffDirectory(); }
  if (p === 'locations')  { renderLocGrid(); }
  if (p === 'dashboard')  { populateDashLocFilter(); renderDashboard(); }
  if (p === 'admin')      { /* no-op */ }
}

// ================================================================
// AUTH
// ================================================================
async function authSignIn() {
  const email = $('loginEmail').value.trim();
  const password = $('loginPassword').value;
  if (!email || !password) { showAuth('Enter email and password'); return; }

  try {
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if (error) throw error;
    // onAuthStateChange will run bootstrap
  } catch (e) {
    showAuth(e.message || 'Sign in failed');
  }
}

async function authResetPw() {
  const email = $('loginEmail').value.trim();
  if (!email) { showAuth('Enter your email first'); return; }
  try {
    const { error } = await sb.auth.resetPasswordForEmail(email);
    if (error) throw error;
    showAuth('Password reset email sent (check inbox)');
  } catch(e) {
    showAuth(e.message || 'Could not send reset email');
  }
}

async function authSignOut() {
  try { await sb.auth.signOut(); } catch {}
  currentUser = null;
  currentProfile = null;
  currentRole = 'staff';
  showAuth();
}

// ================================================================
// DATA ACCESS
// ================================================================
async function loadMyProfile() {
  const { data: { user } } = await sb.auth.getUser();
  currentUser = user;
  if (!currentUser) return null;

  // Profile row created by trigger on auth.users (recommended).
  const { data, error } = await sb
    .from('profiles')
    .select('user_id, full_name, email, role')
    .eq('user_id', currentUser.id)
    .maybeSingle();

  if (error) throw error;

  // Fallback if profile missing: create minimal one (admin can fix later)
  if (!data) {
    const insert = { user_id: currentUser.id, full_name: currentUser.email, email: currentUser.email, role: 'staff' };
    const { data: created, error: e2 } = await sb.from('profiles').insert(insert).select('user_id, full_name, email, role').single();
    if (e2) throw e2;
    return created;
  }

  return data;
}

async function loadLocations() {
  const { data, error } = await sb.from('locations').select('id,name').order('name');
  if (error) throw error;
  cachedLocations = data || [];
  $('locBadge').textContent = cachedLocations.length;
  rebuildLocSelects();
  return cachedLocations;
}

async function loadProfilesIfAllowed() {
  if (currentRole === 'staff') { cachedProfiles = []; $('staffBadge').textContent = '0'; return []; }
  const { data, error } = await sb.from('profiles').select('user_id, full_name, email, role').order('full_name');
  if (error) throw error;
  cachedProfiles = data || [];
  $('staffBadge').textContent = cachedProfiles.length;
  return cachedProfiles;
}

async function fetchShifts(filters={}) {
  // filters: {name, locationName, from, to, userId}
  let q = sb.from('shifts')
    .select('id, shift_date, start_time, end_time, break_minutes, required_break_minutes, net_hours, location_id, user_id, locations(name)')
    .order('shift_date', { ascending: false })
    .order('start_time', { ascending: false });

  if (filters.userId) q = q.eq('user_id', filters.userId);
  if (filters.from)   q = q.gte('shift_date', filters.from);
  if (filters.to)     q = q.lte('shift_date', filters.to);

  if (filters.locationName) {
    const loc = cachedLocations.find(l => l.name === filters.locationName);
    if (loc) q = q.eq('location_id', loc.id);
    else q = q.eq('location_id', '__none__');
  }

  const { data, error } = await q;
  if (error) throw error;

  let shifts = data || [];
  const missingNames = shifts.some(s => !s.profiles && !s.staffName);
  // Map user_id -> name (from cache or fetch)
  const userIds = [...new Set(shifts.map(s => s.user_id).filter(Boolean))];
  const map = new Map();
  cachedProfiles.forEach(p => map.set(p.user_id, p.full_name));

  const unfound = userIds.filter(id => !map.has(id));
  if (unfound.length) {
    const { data: profs, error: e2 } = await sb.from('profiles').select('user_id, full_name').in('user_id', unfound);
    if (!e2 && profs) profs.forEach(p => map.set(p.user_id, p.full_name));
  }

  shifts = shifts.map(s => ({
    id: s.id,
    user_id: s.user_id,
    staffName: map.get(s.user_id) || 'Unknown',
    date: s.shift_date,
    start: s.start_time,
    end: s.end_time,
    breakMins: s.break_minutes || 0,
    requiredBreak: s.required_break_minutes || 0,
    netHours: s.net_hours,
    location: s.locations?.name || '',
    location_id: s.location_id
  }));

  if (filters.name) {
    const n = filters.name.toLowerCase();
    shifts = shifts.filter(s => (s.staffName || '').toLowerCase().includes(n));
  }

  return shifts;
}

// ================================================================
// SHIFT ROWS (existing UI, minor tweaks)
// ================================================================
const MAX_BREAK = 90;
function genTimes() {
  const t=[];
  for(let h=0;h<24;h++) for(let m=0;m<60;m+=15) t.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
  return t;
}
const TIME_OPTS = genTimes();

const BREAK_OPTS = (()=>{
  const opts=[{l:'No break',v:0}];
  for(let m=15;m<=MAX_BREAK;m+=15) opts.push({l:m<60?`${m} min`:`${Math.floor(m/60)}h${m%60?` ${m%60}m`:''}`,v:m});
  return opts;
})();

function mkSel(cls, opts, val, fn) {
  const sel=document.createElement('select'); sel.className=cls; sel.onchange=fn;
  opts.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.v!==undefined?o.v:o; opt.textContent=o.l!==undefined?o.l:o; if((o.v!==undefined?o.v:o)==val) opt.selected=true; sel.appendChild(opt); });
  return sel;
}

function toMins(t) { if(!t) return 0; const[h,m]=t.split(':').map(Number); return h*60+m; }
function requiredBreak(grossMins) { return Math.floor(grossMins/360)*15; } // 15 per full 6h block
function calcNetHours(start, end, breakMins) {
  if(!start||!end) return null;
  const gross = toMins(end)-toMins(start);
  if(gross<=0) return null;
  const req  = requiredBreak(gross);
  const deduct = Math.max(breakMins||0, req);
  return (gross-deduct)/60;
}
function breakStatus(start, end, breakMins) {
  if(!start||!end) return null;
  const gross = toMins(end)-toMins(start);
  if(gross<=0) return null;
  const req = requiredBreak(gross);
  const actual = breakMins||0;
  if(req===0) return {type:'ok',label:'‚úì OK',tip:'Under 6 hours, no break required'};
  if(actual===0) return {type:'error',label:`‚ö† ${req}m req.`,tip:`No break logged. ${req} min required.`};
  if(actual<req)  return {type:'warn',label:`‚ö† Need ${req}m`,tip:`${actual} min logged, ${req} min required.`};
  return {type:'ok',label:`‚úì ${actual}m`,tip:`Requirement met (${req} min required).`};
}

let rowId = 0;
function addShiftRow(data={}) {
  const id=rowId++;
  const today=new Date().toISOString().split('T')[0];
  const tbody=$('shiftRows');
  const tr=document.createElement('tr'); tr.className='shift-row'; tr.dataset.id=id;

  const td1=document.createElement('td');
  const di=document.createElement('input'); di.type='date'; di.value=data.date||today; di.onchange=()=>updateRow(id);
  td1.appendChild(di); tr.appendChild(td1);

  const td2=document.createElement('td');
  td2.appendChild(mkSel('s-start',TIME_OPTS.map(t=>({v:t,l:t})),data.start||'09:00',()=>updateRow(id)));
  tr.appendChild(td2);

  const td3=document.createElement('td');
  td3.appendChild(mkSel('s-end',TIME_OPTS.map(t=>({v:t,l:t})),data.end||'17:00',()=>updateRow(id)));
  tr.appendChild(td3);

  const td4=document.createElement('td');
  const locSel=document.createElement('select'); locSel.className='s-loc';
  locSel.innerHTML='<option value="">-- Location --</option>'+cachedLocations.map(l=>`<option value="${l.name}"${l.name===data.location?' selected':''}>${l.name}</option>`).join('');
  locSel.onchange=()=>updateRow(id);
  td4.appendChild(locSel); tr.appendChild(td4);

  const td5=document.createElement('td');
  td5.appendChild(mkSel('s-brk',BREAK_OPTS,data.breakMins||0,()=>updateRow(id)));
  tr.appendChild(td5);

  const td6=document.createElement('td'); td6.className='hours-cell'; td6.dataset.role='hrs'; tr.appendChild(td6);
  const td7=document.createElement('td'); td7.dataset.role='sts'; tr.appendChild(td7);

  const td8=document.createElement('td');
  const db=document.createElement('button'); db.className='del-row-btn'; db.textContent='√ó'; db.title='Remove row';
  db.onclick=()=>tr.remove(); td8.appendChild(db); tr.appendChild(td8);

  tbody.appendChild(tr);
  updateRow(id);
}

function updateRow(id) {
  const tr=document.querySelector(`tr[data-id="${id}"]`); if(!tr) return;
  const s=tr.querySelector('.s-start').value;
  const e=tr.querySelector('.s-end').value;
  const b=parseInt(tr.querySelector('.s-brk').value)||0;
  const net=calcNetHours(s,e,b);
  const hc=tr.querySelector('[data-role="hrs"]');
  hc.textContent=(net!==null&&net>0)?net.toFixed(2)+'h':'--';
  hc.style.color=(net!==null&&net>0)?'var(--deep)':'var(--text-light)';
  const sc=tr.querySelector('[data-role="sts"]'); sc.innerHTML='';
  const st=breakStatus(s,e,b);
  if(st){ const badge=document.createElement('span'); badge.className=`break-flag ${st.type}`; badge.title=st.tip; badge.textContent=st.label; sc.appendChild(badge); }
}

function getRowData() {
  return Array.from(document.querySelectorAll('.shift-row')).map(tr=>{
    const date=tr.querySelector('input[type="date"]').value;
    const start=tr.querySelector('.s-start').value;
    const end=tr.querySelector('.s-end').value;
    const locationName=tr.querySelector('.s-loc').value;
    const breakMins=parseInt(tr.querySelector('.s-brk').value)||0;
    const gross=toMins(end)-toMins(start);
    const req=gross>0?requiredBreak(gross):0;
    const net=calcNetHours(start,end,breakMins);
    const st=breakStatus(start,end,breakMins);
    return {date,start,end,locationName,breakMins,requiredBreak:req,netHours:net,breakWarning:st?.type!=='ok'};
  }).filter(r=>r.date&&r.start&&r.end);
}

function resetForm(){
  $('shiftRows').innerHTML='';
  rowId=0;
  addShiftRow();
  if (currentRole === 'staff' && currentProfile) $('staffName').value = currentProfile.full_name || currentProfile.email || '';
}

// ================================================================
// AUTOCOMPLETE (staff selector)
// ================================================================
let acIdx = {};
const AV_COLS = ['#2e7bc9','#7056a0','#1a9a5a','#c97b2e','#b54d2e','#2e9fc9','#a07c2e','#b52e7e'];
function avColor(name) { let h=0; for(let i=0;i<name.length;i++) h=name.charCodeAt(i)+((h<<5)-h); return AV_COLS[Math.abs(h)%AV_COLS.length]; }
function initials(name) { return name.split(' ').map(w=>w[0]||'').join('').toUpperCase().slice(0,2); }

function acInputProfiles(inputId, dropId) {
  const val = $(inputId).value.trim().toLowerCase();
  const data = cachedProfiles.length ? cachedProfiles : (currentProfile ? [currentProfile] : []);
  const matches = val ? data.filter(p => (p.full_name||'').toLowerCase().includes(val) || (p.email||'').toLowerCase().includes(val)) : data;
  acIdx[dropId] = -1;
  const dd = $(dropId);
  if (!matches.length) dd.innerHTML = '<div class="ac-empty">No matches</div>';
  else dd.innerHTML = matches.map((p,i)=>`
    <div class="ac-item" data-idx="${i}" data-val="${(p.full_name||p.email||'').replace(/"/g,'&quot;')}"
      onmousedown="acSel('${inputId}','${dropId}','${(p.full_name||p.email||'').replace(/'/g,"\'")}')">
      <div class="ac-av" style="background:${avColor(p.full_name||p.email||'')}">${initials(p.full_name||p.email||'')}</div>
      <span>${p.full_name || p.email}</span>
      <span class="ac-role-lbl">${p.role || ''}</span>
    </div>`).join('');
  dd.style.display = 'block';
}
function acSel(inputId, dropId, val) { $(inputId).value=val; $(dropId).style.display='none'; acIdx[dropId]=-1; }
function acBlur(dropId) { setTimeout(()=>{$(dropId).style.display='none';acIdx[dropId]=-1;},160); }
function acKeydown(e, inputId, dropId) {
  const dd = $(dropId); if(dd.style.display==='none') return;
  const items = dd.querySelectorAll('.ac-item'); if(!items.length) return;
  if(!acIdx[dropId]&&acIdx[dropId]!==0) acIdx[dropId]=-1;
  if(e.key==='ArrowDown'){e.preventDefault();acIdx[dropId]=Math.min(acIdx[dropId]+1,items.length-1);}
  else if(e.key==='ArrowUp'){e.preventDefault();acIdx[dropId]=Math.max(acIdx[dropId]-1,0);}
  else if(e.key==='Enter'&&acIdx[dropId]>=0){e.preventDefault();acSel(inputId,dropId,items[acIdx[dropId]].dataset.val);return;}
  else if(e.key==='Escape'){dd.style.display='none';return;}
  items.forEach((el,i)=>el.classList.toggle('hl',i===acIdx[dropId]));
}

// ================================================================
// LOCATIONS (admin-managed)
// ================================================================
function rebuildLocSelects() {
  document.querySelectorAll('.s-loc').forEach(sel => {
    const cur = sel.value;
    sel.innerHTML = '<option value="">-- Location --</option>' + cachedLocations.map(l=>`<option value="${l.name}"${l.name===cur?' selected':''}>${l.name}</option>`).join('');
  });
  populateLocFilter();
  populateDashLocFilter();
}

function populateLocFilter() {
  const sel = $('filterLoc');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">All</option>' + cachedLocations.map(l=>`<option value="${l.name}"${l.name===cur?' selected':''}>${l.name}</option>`).join('');
}
function populateDashLocFilter() {
  const sel = $('dashLoc');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">All locations</option>' + cachedLocations.map(l=>`<option value="${l.name}"${l.name===cur?' selected':''}>${l.name}</option>`).join('');
}

async function addLocation() {
  if (currentRole !== 'admin') { showToast('Only admins can add locations'); return; }
  const name = $('newLocName').value.trim();
  if (!name) { showToast('Please enter a location name'); return; }
  try {
    const { error } = await sb.from('locations').insert({ name });
    if (error) throw error;
    $('newLocName').value = '';
    await loadLocations();
    renderLocGrid();
    showToast('Location added');
  } catch(e) {
    showToast(e.message || 'Could not add location');
  }
}

async function deleteLocation(id) {
  if (currentRole !== 'admin') { showToast('Only admins can remove locations'); return; }
  showConfirm('Remove Location', 'This cannot be undone.', async () => {
    try {
      const { error } = await sb.from('locations').delete().eq('id', id);
      if (error) throw error;
      await loadLocations();
      renderLocGrid();
      showToast('Location removed');
    } catch(e) {
      showToast(e.message || 'Could not remove location');
    }
  });
}

function renderLocGrid() {
  const grid = $('locGrid');
  if (!grid) return;
  if (currentRole !== 'admin') {
    grid.innerHTML = '<div class="empty-state" style="padding:24px 0"><div class="icon">üìç</div><p>Only admins can manage locations.</p></div>';
    return;
  }
  const list = cachedLocations;
  if (!list.length) { grid.innerHTML='<div class="empty-state" style="padding:24px 0"><div class="icon">üìç</div><p>No locations added yet.</p></div>'; return; }
  grid.innerHTML = `<div class="entity-grid">${list.map(l=>`
    <div class="entity-card">
      <div class="loc-icon">üìç</div>
      <div class="entity-info"><div class="entity-name">${l.name}</div></div>
      <button class="entity-del" onclick="deleteLocation('${l.id}')" title="Remove">√ó</button>
    </div>`).join('')}</div>`;
}

// ================================================================
// STAFF DIRECTORY (read-only, manager/admin)
// ================================================================
function renderStaffDirectory() {
  const grid = $('staffGrid');
  if (!grid) return;

  // Hide local "add staff" form; users are created via invite flow
  const addForm = document.querySelector('#page-staff .entity-add-form');
  if (addForm) addForm.style.display = 'none';

  if (currentRole === 'staff') {
    grid.innerHTML = '<div class="empty-state" style="padding:24px 0"><div class="icon">üë§</div><p>Only managers and admins can view the staff directory.</p></div>';
    return;
  }

  const list = cachedProfiles;
  if (!list.length) { grid.innerHTML='<div class="empty-state" style="padding:24px 0"><div class="icon">üë§</div><p>No users found.</p></div>'; return; }

  grid.innerHTML = `<div class="entity-grid">${list.map(p=>`
    <div class="entity-card">
      <div class="entity-avatar" style="background:${avColor(p.full_name||p.email||'')}">${initials(p.full_name||p.email||'')}</div>
      <div class="entity-info">
        <div class="entity-name">${p.full_name || p.email}</div>
        <div class="entity-sub">${(p.role||'staff')} ‚Ä¢ ${p.email||''}</div>
      </div>
    </div>`).join('')}</div>`;
}

// ================================================================
// TIMESHEETS: SAVE
// ================================================================
function resolveUserIdFromStaffName(name) {
  if (currentRole === 'staff') return currentUser?.id || null;
  const p = cachedProfiles.find(x => (x.full_name||'').toLowerCase() === name.toLowerCase());
  if (p) return p.user_id;
  // fallback: try email match
  const p2 = cachedProfiles.find(x => (x.email||'').toLowerCase() === name.toLowerCase());
  return p2 ? p2.user_id : null;
}

async function saveEntry() {
  if (!currentUser) { showToast('Please sign in'); return; }

  const name = $('staffName').value.trim();
  let userId = resolveUserIdFromStaffName(name);
  if (!userId) {
    if (currentRole === 'staff') userId = currentUser.id;
    else { showToast('Pick a staff member from the list'); return; }
  }

  const shifts = getRowData();
  if(!shifts.length){showToast('Please add at least one shift row');return;}

  // Location is mandatory
  const missingLoc = shifts.find(s => !s.locationName);
  if (missingLoc) { showToast('Location is mandatory for every shift'); return; }

  // Map location names -> ids
  const locMap = new Map(cachedLocations.map(l => [l.name, l.id]));
  const rows = [];
  for (const s of shifts) {
    const locId = locMap.get(s.locationName);
    if (!locId) { showToast('Unknown location: ' + s.locationName); return; }
    rows.push({
      user_id: userId,
      location_id: locId,
      shift_date: s.date,
      start_time: s.start,
      end_time: s.end,
      break_minutes: s.breakMins,
      required_break_minutes: s.requiredBreak,
      net_hours: s.netHours
    });
  }

  try {
    const { error } = await sb.from('shifts').insert(rows);
    if (error) throw error;
    resetForm();
    await renderRecords();
    showToast('Shift(s) saved');
  } catch(e) {
    showToast(e.message || 'Could not save shifts');
  }
}

// ================================================================
// RECORDS: LIST, EDIT, DELETE
// ================================================================
async function renderRecords() {
  const cont=$('recordsContainer');
  const summ=$('summaryBar');
  if (!cont) return;

  const fn=$('filterName')?.value?.trim() || '';
  const fl=$('filterLoc')?.value || '';
  const ff=$('filterFrom')?.value || '';
  const ft=$('filterTo')?.value || '';

  const filters = { name: fn, locationName: fl, from: ff, to: ft };
  if (currentRole === 'staff') filters.userId = currentUser?.id;

  let shifts = [];
  try { shifts = await fetchShifts(filters); }
  catch(e) { cont.innerHTML = `<div class="empty-state"><p>${e.message || 'Could not load records'}</p></div>`; return; }

  if(!shifts.length){cont.innerHTML=`<div class="empty-state"><div class="icon">üóì</div><p>No timesheet records yet.</p></div>`;if(summ) summ.innerHTML='';return;}

  let totalNet=0,totalWarn=0,rows='';
  shifts.forEach(s=>{
    const h=s.netHours||0; totalNet+=h; if(s.requiredBreak>0 && (s.breakMins||0) < s.requiredBreak) totalWarn++;
    const warn = (s.requiredBreak>0 && (s.breakMins||0) < s.requiredBreak);
    const stHtml=warn?'<span class="break-flag error">‚ö† Break issue</span>':'<span class="break-flag ok">‚úì OK</span>';

    const canEdit = (currentRole === 'manager' || currentRole === 'admin');
    const canDelete = (currentRole === 'admin');

    rows+=`<tr>
      <td>${s.staffName}</td>
      <td>${s.location || '<span style="color:var(--text-light);font-style:italic">None</span>'}</td>
      <td>${s.date}</td><td>${s.start}</td><td>${s.end}</td>
      <td>${s.breakMins>0?s.breakMins+'m':'‚Äî'}</td>
      <td>${s.requiredBreak>0?s.requiredBreak+'m':'‚Äî'}</td>
      <td style="text-align:center;font-weight:600;color:var(--deep)">${h>0?Number(h).toFixed(2)+'h':'--'}</td>
      <td>${stHtml}</td>
      <td style="text-align:center">
        <button class="btn btn-outline" onclick="openEditShift('${s.id}')" style="padding:5px 10px;font-size:0.8rem;${canEdit?'':'opacity:0.35;cursor:not-allowed'}" ${canEdit?'':'disabled'}>Edit</button>
        <button class="btn btn-danger-outline" onclick="deleteShift('${s.id}')" title="${canDelete?'Delete shift':'Admin only'}" style="${canDelete?'':'opacity:0.35;cursor:not-allowed'}" ${canDelete?'':'disabled'}>‚úï</button>
      </td>
    </tr>`;
  });

  cont.innerHTML=`<div style="overflow-x:auto"><table class="rec-table">
    <thead><tr><th>Name</th><th>Location</th><th>Date</th><th>Start</th><th>End</th><th>Break</th><th>Req.</th><th>Net Hrs</th><th>Status</th><th></th></tr></thead>
    <tbody>${rows}</tbody></table></div>`;

  if (summ) summ.innerHTML=`<span>Showing <strong>${shifts.length}</strong> shift${shifts.length===1?'':'s'}</span>
    <span>Total net hours: <strong>${totalNet.toFixed(2)}h</strong></span>
    ${totalWarn>0?`<span style="color:var(--flag-red);font-weight:600">‚ö† ${totalWarn} break issue${totalWarn>1?'s':''}</span>`:'<span style="color:var(--flag-green)">‚úì No issues</span>'}`;
}

async function deleteShift(id) {
  if (currentRole !== 'admin') { showToast('Admins only'); return; }
  showConfirm('Delete shift','Delete this shift?', async () => {
    try {
      const { error } = await sb.from('shifts').delete().eq('id', id);
      if (error) throw error;
      await renderRecords();
      showToast('Shift deleted');
    } catch(e) {
      showToast(e.message || 'Could not delete shift');
    }
  });
}

// ================================================================
// EDIT SHIFT MODAL
// ================================================================
function openEditShift(id) {
  if (!(currentRole === 'manager' || currentRole === 'admin')) { showToast('Not permitted'); return; }
  editingShiftId = id;

  // Build select options
  $('edit_start').innerHTML = TIME_OPTS.map(t=>`<option value="${t}">${t}</option>`).join('');
  $('edit_end').innerHTML   = TIME_OPTS.map(t=>`<option value="${t}">${t}</option>`).join('');
  $('edit_break').innerHTML = BREAK_OPTS.map(o=>`<option value="${o.v}">${o.l}</option>`).join('');
  $('edit_location').innerHTML = '<option value="">-- Location --</option>' + cachedLocations.map(l=>`<option value="${l.id}">${l.name}</option>`).join('');

  $('edit_note').value = '';

  // Fetch the shift
  (async ()=>{
    try {
      const { data, error } = await sb.from('shifts').select('id, shift_date, start_time, end_time, break_minutes, location_id').eq('id', id).single();
      if (error) throw error;
      $('edit_date').value = data.shift_date;
      $('edit_start').value = data.start_time;
      $('edit_end').value = data.end_time;
      $('edit_break').value = String(data.break_minutes || 0);
      $('edit_location').value = data.location_id || '';
      $('editShiftModal').classList.add('open');
    } catch(e) {
      showToast(e.message || 'Could not load shift');
    }
  })();
}

function closeEditShift() {
  $('editShiftModal').classList.remove('open');
  editingShiftId = null;
}
$('editShiftModal').addEventListener('click', function(e){ if(e.target === this) closeEditShift(); });

async function saveEditShift() {
  if (!editingShiftId) return;

  const note = $('edit_note').value.trim();
  if (!note) { showToast('Edit note is required'); return; }

  const locId = $('edit_location').value;
  if (!locId) { showToast('Location is mandatory'); return; }

  const start = $('edit_start').value;
  const end   = $('edit_end').value;
  const b     = parseInt($('edit_break').value)||0;

  const gross = toMins(end) - toMins(start);
  if (gross <= 0) { showToast('End must be after start'); return; }

  const req = requiredBreak(gross);
  const net = calcNetHours(start, end, b);

  try {
    const payload = {
      shift_date: $('edit_date').value,
      location_id: locId,
      start_time: start,
      end_time: end,
      break_minutes: b,
      required_break_minutes: req,
      net_hours: net,
      last_edit_note: note,
      last_edited_by: currentUser?.id || null,
      last_edited_at: new Date().toISOString()
    };

    const { error } = await sb.from('shifts').update(payload).eq('id', editingShiftId);
    if (error) throw error;

    closeEditShift();
    await renderRecords();
    showToast('Shift updated');
  } catch(e) {
    showToast(e.message || 'Could not update shift');
  }
}

// ================================================================
// DASHBOARD (uses shifts table)
// ================================================================
function setDashPeriod(period) {
  const now = new Date();
  let from, to = now.toISOString().split('T')[0];
  if (period === 'week') {
    const d = new Date(now); d.setDate(d.getDate()-d.getDay()+1);
    from = d.toISOString().split('T')[0];
  } else if (period === 'month') {
    from = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  } else {
    from = ''; to = '';
  }
  $('dashFrom').value = from;
  $('dashTo').value   = to;
  renderDashboard();
}

const BAR_COLORS = ['#3d8bcd','#e8a020','#1a9a5a','#7056a0','#c97b2e','#b52e7e','#2e9fc9','#b54d2e'];
function drawBars(containerId, data, unit='h') {
  const cont = $(containerId);
  if (!cont) return;
  if (!data.length) { cont.innerHTML='<div class="empty-state" style="padding:24px 0"><p>No data for this period.</p></div>'; return; }
  const max = Math.max(...data.map(d=>d.val));
  cont.innerHTML = data.map((d,i) => `
    <div class="bar-row">
      <div class="bar-label" title="${d.label}">${d.label}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${max>0?(d.val/max*100):0}%;background:${BAR_COLORS[i % BAR_COLORS.length]}"></div></div>
      <div class="bar-val">${d.val.toFixed(1)}${unit}</div>
    </div>`).join('');
}

async function renderDashboard() {
  const ff  = $('dashFrom').value;
  const ft  = $('dashTo').value;
  const fl  = $('dashLoc').value;

  const filters = { from: ff, to: ft, locationName: fl };
  if (currentRole === 'staff') filters.userId = currentUser?.id;

  let shifts = [];
  try { shifts = await fetchShifts(filters); }
  catch(e) { return; }

  const totalHours   = shifts.reduce((a,s)=>a+(Number(s.netHours)||0),0);
  const totalShifts  = shifts.length;
  const uniqueStaff  = new Set(shifts.map(s=>s.staffName)).size;
  const violations   = shifts.filter(s => s.requiredBreak>0 && (s.breakMins||0) < s.requiredBreak).length;
  const avgShift     = totalShifts > 0 ? totalHours/totalShifts : 0;

  $('kpiRow').innerHTML = `
    <div class="kpi-card accent"><div class="kpi-label">Total Net Hours</div><div class="kpi-value">${totalHours.toFixed(1)}</div><div class="kpi-sub">across ${totalShifts} shift${totalShifts!==1?'s':''}</div></div>
    <div class="kpi-card green"><div class="kpi-label">Active Staff</div><div class="kpi-value">${uniqueStaff}</div><div class="kpi-sub">in selected period</div></div>
    <div class="kpi-card amber"><div class="kpi-label">Avg Shift Length</div><div class="kpi-value">${avgShift.toFixed(1)}h</div><div class="kpi-sub">net hours</div></div>
    <div class="kpi-card ${violations>0?'red':'green'}"><div class="kpi-label">Break Issues</div><div class="kpi-value">${violations}</div><div class="kpi-sub">${violations>0?'need attention':'all compliant'}</div></div>`;

  // Hours by employee
  const byEmp = new Map();
  shifts.forEach(s => byEmp.set(s.staffName, (byEmp.get(s.staffName)||0) + (Number(s.netHours)||0)));
  const empData = [...byEmp.entries()].map(([label,val])=>({label,val})).sort((a,b)=>b.val-a.val).slice(0,12);
  drawBars('chartEmployee', empData);

  // Hours by location
  const byLoc = new Map();
  shifts.forEach(s => byLoc.set(s.location || 'Unassigned', (byLoc.get(s.location || 'Unassigned')||0) + (Number(s.netHours)||0)));
  const locData = [...byLoc.entries()].map(([label,val])=>({label,val})).sort((a,b)=>b.val-a.val).slice(0,12);
  drawBars('chartLocation', locData);

  // Hours by day of week
  const dowNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const byDow = new Map(dowNames.map(d=>[d,0]));
  shifts.forEach(s => {
    const d = new Date(s.date + 'T00:00:00Z').getUTCDay();
    const key = dowNames[d];
    byDow.set(key, (byDow.get(key)||0) + (Number(s.netHours)||0));
  });
  const dowData = dowNames.map(d=>({label:d,val:byDow.get(d)||0}));
  drawBars('chartDow', dowData);

  // Violations list
  const vio = shifts.filter(s => s.requiredBreak>0 && (s.breakMins||0) < s.requiredBreak).slice(0,20);
  const vcont = $('chartViolations');
  if (vcont) {
    vcont.innerHTML = vio.length ? vio.map(s=>`
      <div class="violation-item">
        <div class="violation-dot"></div>
        <div>
          <div><strong>${s.staffName}</strong> ‚Ä¢ ${s.date} ‚Ä¢ ${s.location || 'Unassigned'}</div>
          <div style="color:var(--text-mid)">Logged ${s.breakMins||0}m, required ${s.requiredBreak}m</div>
        </div>
      </div>`).join('') : '<div class="empty-state" style="padding:24px 0"><p>No break issues found.</p></div>';
  }

  // Summary table
  const staffMap = new Map();
  shifts.forEach(s=>{
    const key=s.staffName;
    if(!staffMap.has(key)) staffMap.set(key,{shifts:0,hours:0,locs:new Set(),violations:0});
    const e=staffMap.get(key);
    e.shifts++; e.hours+=(Number(s.netHours)||0);
    if(s.location) e.locs.add(s.location);
    if(s.requiredBreak>0 && (s.breakMins||0) < s.requiredBreak) e.violations++;
  });

  const tbody=$('staffSummaryBody');
  if (tbody) {
    tbody.innerHTML=[...staffMap.entries()].sort((a,b)=>b[1].hours-a[1].hours).map(([name,d])=>`
      <tr>
        <td><span style="display:inline-flex;align-items:center;gap:8px"><span style="width:24px;height:24px;border-radius:50%;background:${avColor(name)};display:inline-flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:700;color:white">${initials(name)}</span>${name}</span></td>
        <td>${d.shifts}</td>
        <td style="font-weight:600">${d.hours.toFixed(2)}h</td>
        <td>${d.shifts>0?(d.hours/d.shifts).toFixed(2)+'h':'‚Äî'}</td>
        <td style="font-size:0.78rem;color:var(--text-mid)">${[...d.locs].join(', ')||'‚Äî'}</td>
        <td>${d.violations>0?`<span class="break-flag error">‚ö† ${d.violations}</span>`:'<span class="break-flag ok">‚úì 0</span>'}</td>
      </tr>`).join('');
    if(!tbody.innerHTML) tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-light);font-style:italic">No data for this period</td></tr>';
  }
}

// ================================================================
// ADMIN: INVITE + EXPORT + CLEAR
// ================================================================
async function adminInvite() {
  if (currentRole !== 'admin') { showToast('Admins only'); return; }
  const email = $('inviteEmail').value.trim();
  const full_name = $('inviteName').value.trim();
  const role = $('inviteRole').value;

  if (!email) { showToast('Email is required'); return; }
  if (!full_name) { showToast('Full name is required'); return; }
  $('inviteStatus').textContent = 'Sending invite...';

  try {
    // Requires a Supabase Edge Function named "admin-invite"
    // It should:
    // - create the auth user (invite)
    // - upsert profiles row with {user_id, email, full_name, role}
    const { data, error } = await sb.functions.invoke('admin-invite', { body: { email, full_name, role } });
    if (error) throw error;

    $('inviteStatus').textContent = 'Invite sent to ' + email;
    $('inviteEmail').value = '';
    $('inviteName').value = '';
    $('inviteRole').value = 'staff';

    await loadProfilesIfAllowed();
    showToast('Invite sent');
  } catch(e) {
    $('inviteStatus').textContent = e.message || 'Invite failed';
    showToast(e.message || 'Invite failed');
  }
}

function dlFile(content,filename,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=filename;a.click();}
function today(){return new Date().toISOString().split('T')[0];}

async function exportCSV() {
  try {
    const shifts = await fetchShifts({}); // respects staff role filters only if passed; exports full dataset for admin/manager.
    const allowed = (currentRole === 'admin' || currentRole === 'manager');
    const exportRows = (currentRole === 'staff') ? await fetchShifts({ userId: currentUser?.id }) : shifts;

    if (!exportRows.length) { showToast('No data to export'); return; }
    let csv='Name,Location,Date,Start,End,Break Taken (mins),Break Required (mins),Net Hours
';
    exportRows.forEach(s=>{
      csv+=`"${s.staffName}","${s.location||''}",${s.date},${s.start},${s.end},${s.breakMins||0},${s.requiredBreak||0},${s.netHours?Number(s.netHours).toFixed(2):''}
`;
    });
    dlFile(csv,`gwoc-shifts-${today()}.csv`,'text/csv');
    showToast('CSV downloaded');
  } catch(e) {
    showToast(e.message || 'Could not export');
  }
}

async function clearTimesheets() {
  if (currentRole !== 'admin') { showToast('Admins only'); return; }
  showConfirm('Clear all shifts','Delete all shift rows permanently?', async ()=>{
    try {
      // Use RPC to truncate safely (recommended). Here: delete all rows.
      const { error } = await sb.from('shifts').delete().neq('id','00000000-0000-0000-0000-000000000000');
      if (error) throw error;
      await renderRecords();
      showToast('All shifts cleared');
    } catch(e) {
      showToast(e.message || 'Could not clear shifts');
    }
  });
}

// ================================================================
// INIT
// ================================================================
async function bootstrap() {
  if (!SUPABASE_URL.startsWith('http')) { showAuth('Set SUPABASE_URL and SUPABASE_ANON_KEY in the script'); return; }

  sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  sb.auth.onAuthStateChange(async (_event, session) => {
    if (!session?.user) { showAuth(); return; }
    await onSignedIn();
  });

  const { data: { session } } = await sb.auth.getSession();
  if (!session?.user) { showAuth(); return; }
  await onSignedIn();
}

async function onSignedIn() {
  try {
    currentProfile = await loadMyProfile();
    currentRole = (currentProfile?.role || 'staff').toLowerCase();
    hideAuth();

    $('tab-user').textContent = `${currentProfile.full_name || currentProfile.email || ''} (${currentRole})`;

    setNavForRole(currentRole);

    // Load reference data
    await loadLocations();
    await loadProfilesIfAllowed();

    // Staff selector behaviour
    if (currentRole === 'staff') {
      $('staffName').value = currentProfile.full_name || currentProfile.email || '';
      $('staffName').setAttribute('disabled','disabled');
      $('staffName').style.opacity = '0.85';
    } else {
      $('staffName').removeAttribute('disabled');
    }

    // Wire autocomplete handlers (replace previous inline handlers)
    $('staffName').oninput = ()=>acInputProfiles('staffName','acDropStaff');
    $('staffName').onkeydown = (e)=>acKeydown(e,'staffName','acDropStaff');
    $('staffName').onfocus = ()=>acInputProfiles('staffName','acDropStaff');
    $('staffName').onblur = ()=>acBlur('acDropStaff');

    // Locations page add form gating
    const locAddForm = document.querySelector('#page-locations .entity-add-form');
    if (locAddForm) locAddForm.style.display = (currentRole === 'admin') ? '' : 'none';

    // Staff page add form already hidden in render
    // Initial render
    resetForm();
    await renderRecords();
    initDashboardDefaults();
  } catch(e) {
    showAuth(e.message || 'Could not load profile');
  }
}

function initDashboardDefaults() {
  const now=new Date();
  if ($('dashFrom')) $('dashFrom').value=new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0];
  if ($('dashTo')) $('dashTo').value=now.toISOString().split('T')[0];
}

// Start
bootstrap();
</script>
</body>
</html>
