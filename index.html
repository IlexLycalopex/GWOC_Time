<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GWOC Timesheet System</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --ink:#0f1923; --deep:#1b2b3a; --mid:#2c4a63; --accent:#3d8bcd; --accent2:#e8a020;
  --cream:#f0f4f8; --milk:#f8fafc; --steam:#dde4ec; --chalk:#eaf0f6;
  --flag-red:#c0392b; --flag-green:#1a9a5a; --flag-amber:#d4820a;
  --text-dark:#0f1923; --text-mid:#3a5068; --text-light:#7a95aa;
  --border:rgba(44,74,99,0.15); --shadow:0 2px 14px rgba(15,25,35,0.09);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--milk);color:var(--text-dark);min-height:100vh;
  background-image:radial-gradient(ellipse at 8% 0%,rgba(61,139,205,0.07) 0%,transparent 55%),radial-gradient(ellipse at 92% 100%,rgba(232,160,32,0.05) 0%,transparent 55%)}

/* HEADER */
header{background:var(--ink);color:var(--cream);padding:0 28px;display:flex;align-items:stretch;box-shadow:0 2px 18px rgba(0,0,0,0.35);position:sticky;top:0;z-index:200}
.logo{display:flex;align-items:center;gap:12px;padding:13px 0;flex-shrink:0;text-decoration:none;color:inherit}
.swallow-icon{width:38px;height:38px;flex-shrink:0}
.logo-text h1{font-family:'Playfair Display',serif;font-size:1.25rem;letter-spacing:0.03em;color:var(--cream)}
.logo-text span{font-size:0.65rem;color:rgba(240,244,248,0.5);display:block;font-weight:400;letter-spacing:0.1em;text-transform:uppercase;margin-top:-1px}
nav{display:flex;align-items:stretch;margin-left:24px;flex:1;overflow-x:auto}
.nav-tab{display:flex;align-items:center;gap:6px;padding:0 16px;color:rgba(240,244,248,0.45);font-size:0.83rem;font-weight:500;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.15s;user-select:none;white-space:nowrap}
.nav-tab:hover{color:var(--cream);background:rgba(255,255,255,0.04)}
.nav-tab.active{color:var(--cream);border-bottom-color:var(--accent);background:rgba(255,255,255,0.04)}
.nav-badge{background:var(--accent);color:white;font-size:0.63rem;font-weight:700;padding:1px 6px;border-radius:20px;min-width:18px;text-align:center}
.nav-admin{margin-left:auto;color:rgba(240,244,248,0.35);font-size:0.8rem}
.nav-admin:hover{color:var(--accent2);background:rgba(232,160,32,0.06)}
.nav-admin.active{color:var(--accent2);border-bottom-color:var(--accent2)}

/* LAYOUT */
main{max-width:1080px;margin:0 auto;padding:26px 20px}
.page{display:none}.page.active{display:block}

/* BUTTONS */
.btn{padding:8px 18px;border:none;border-radius:7px;font-family:'DM Sans',sans-serif;font-weight:500;font-size:0.84rem;cursor:pointer;transition:all 0.15s}
.btn-primary{background:var(--accent);color:white}.btn-primary:hover{background:#2d7ab8;transform:translateY(-1px)}
.btn-secondary{background:var(--accent2);color:white}.btn-secondary:hover{background:#c27010;transform:translateY(-1px)}
.btn-outline{background:transparent;color:var(--text-mid);border:1.5px solid var(--steam)}.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-danger-outline{background:transparent;color:var(--flag-red);border:1px solid rgba(192,57,43,0.35);padding:5px 11px;font-size:0.8rem}.btn-danger-outline:hover{background:rgba(192,57,43,0.07)}
.btn-red{background:var(--flag-red);color:white}.btn-red:hover{background:#a93226}

/* CARDS */
.card{background:white;border-radius:13px;box-shadow:var(--shadow);border:1px solid var(--border);overflow:hidden;margin-bottom:24px}
.card-header{background:var(--deep);color:var(--cream);padding:13px 22px;display:flex;align-items:center;gap:10px}
.card-header h2{font-family:'Playfair Display',serif;font-size:1rem;font-weight:600}
.card-body{padding:22px}

/* FORM */
.field-group{display:flex;flex-direction:column;gap:4px}
.field-group label{font-size:0.7rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.07em}
.field-group input,.field-group select{padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.88rem;color:var(--text-dark);background:var(--milk);transition:border-color 0.15s;-webkit-appearance:none;appearance:none}
.field-group input:focus,.field-group select:focus{outline:none;border-color:var(--accent);background:white}

/* AUTOCOMPLETE */
.ac-wrap{position:relative}
.ac-drop{position:absolute;top:calc(100% + 4px);left:0;right:0;background:white;border:1.5px solid var(--accent);border-radius:9px;box-shadow:0 8px 28px rgba(15,25,35,0.14);z-index:400;overflow:hidden;max-height:220px;overflow-y:auto}
.ac-item{padding:8px 13px;font-size:0.88rem;cursor:pointer;display:flex;align-items:center;gap:9px;transition:background 0.1s;color:var(--text-dark);border-bottom:1px solid var(--steam)}
.ac-item:last-child{border-bottom:none}.ac-item:hover,.ac-item.hl{background:var(--chalk)}
.ac-av{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.68rem;font-weight:700;color:white;flex-shrink:0}
.ac-role-lbl{font-size:0.72rem;color:var(--text-light);margin-left:auto;font-style:italic}
.ac-empty{padding:10px 14px;font-size:0.84rem;color:var(--text-light);font-style:italic;text-align:center}

/* SHIFTS TABLE */
.shifts-table{width:100%;border-collapse:collapse}
.shifts-table thead tr{background:var(--chalk);border-bottom:1.5px solid var(--steam)}
.shifts-table th{padding:8px 7px;font-size:0.66rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.06em;text-align:left}
.shift-row td{padding:7px 5px;border-bottom:1px solid var(--steam);vertical-align:middle}
.shift-row td select,.shift-row td input[type="date"]{padding:6px 7px;border:1.5px solid var(--steam);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:0.82rem;color:var(--text-dark);background:var(--milk);width:100%;-webkit-appearance:none;appearance:none;cursor:pointer}
.shift-row td select:focus,.shift-row td input:focus{outline:none;border-color:var(--accent);background:white}
.add-row-btn{display:flex;align-items:center;gap:6px;background:none;border:1.5px dashed var(--accent);color:var(--accent);padding:7px 15px;border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.84rem;font-weight:500;cursor:pointer;transition:all 0.15s;margin-top:10px}
.add-row-btn:hover{background:rgba(61,139,205,0.05)}
.del-row-btn{background:none;border:none;color:var(--text-light);cursor:pointer;font-size:1.05rem;padding:4px 7px;border-radius:4px;transition:color 0.12s;display:block;margin:0 auto}
.del-row-btn:hover{color:var(--flag-red)}

/* BREAK FLAGS */
.break-flag{display:inline-flex;align-items:center;gap:4px;padding:3px 7px;border-radius:4px;font-size:0.69rem;font-weight:600;white-space:nowrap}
.break-flag.ok{background:rgba(26,154,90,0.1);color:var(--flag-green);border:1px solid rgba(26,154,90,0.25)}
.break-flag.error{background:rgba(192,57,43,0.1);color:var(--flag-red);border:1px solid rgba(192,57,43,0.25)}
.break-flag.warn{background:rgba(212,130,10,0.1);color:var(--flag-amber);border:1px solid rgba(212,130,10,0.25)}
.hours-cell{font-weight:600;font-size:0.84rem;text-align:center}

/* BREAK RULE NOTE */
.break-rule-note{background:var(--chalk);border-left:3px solid var(--accent);border-radius:0 7px 7px 0;padding:10px 14px;margin-top:12px;font-size:0.77rem;color:var(--text-mid);line-height:1.55}
.break-rule-note strong{color:var(--text-dark)}

/* RECORDS */
.rec-controls{padding:12px 22px;display:flex;gap:12px;align-items:center;background:var(--chalk);border-bottom:1px solid var(--border);flex-wrap:wrap}
.rec-controls input,.rec-controls select{padding:6px 10px;border:1.5px solid var(--steam);border-radius:6px;font-family:'DM Sans',sans-serif;font-size:0.84rem;background:white;color:var(--text-dark);-webkit-appearance:none;appearance:none}
.rec-controls input:focus,.rec-controls select:focus{outline:none;border-color:var(--accent)}
.rec-controls label{font-size:0.69rem;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.06em}
table.rec-table{width:100%;border-collapse:collapse}
.rec-table thead{background:var(--ink);color:var(--cream)}
.rec-table th{padding:10px 12px;font-size:0.66rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;text-align:left}
.rec-table tbody tr{border-bottom:1px solid var(--steam);transition:background 0.1s}
.rec-table tbody tr:hover{background:var(--milk)}
.rec-table td{padding:9px 12px;font-size:0.84rem;vertical-align:middle}
.rec-table td:nth-child(1){font-weight:600;color:var(--deep)}
.empty-state{text-align:center;padding:42px 22px;color:var(--text-light)}
.empty-state .icon{font-size:2.2rem;margin-bottom:9px}
.empty-state p{font-size:0.88rem}
.summary-bar{padding:10px 22px;background:var(--chalk);border-top:1px solid var(--border);display:flex;gap:20px;font-size:0.8rem;color:var(--text-mid);flex-wrap:wrap}
.summary-bar strong{color:var(--text-dark)}
.form-actions{display:flex;gap:10px;margin-top:18px;justify-content:flex-end}

/* ENTITY GRIDS (staff, locations) */
.entity-add-form{display:flex;gap:11px;align-items:flex-end;padding-bottom:22px;margin-bottom:22px;border-bottom:1.5px solid var(--steam);flex-wrap:wrap}
.entity-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
.entity-card{background:var(--chalk);border:1.5px solid var(--steam);border-radius:10px;padding:12px 14px;display:flex;align-items:center;gap:11px;transition:border-color 0.15s,box-shadow 0.15s}
.entity-card:hover{border-color:var(--accent);box-shadow:0 2px 10px rgba(61,139,205,0.1)}
.entity-avatar{width:38px;height:38px;flex-shrink:0;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;color:white}
.loc-icon{width:38px;height:38px;flex-shrink:0;border-radius:9px;background:var(--mid);display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.entity-info{flex:1;min-width:0}
.entity-name{font-weight:600;font-size:0.9rem;color:var(--deep);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.entity-sub{font-size:0.72rem;color:var(--text-light);margin-top:2px}
.entity-del{background:none;border:none;color:var(--text-light);cursor:pointer;font-size:0.95rem;padding:3px;border-radius:4px;transition:color 0.12s;flex-shrink:0}
.entity-del:hover{color:var(--flag-red)}

/* ===== DASHBOARD ===== */
.dash-filters{display:flex;gap:14px;align-items:flex-end;margin-bottom:22px;flex-wrap:wrap;padding:16px 20px;background:white;border-radius:13px;box-shadow:var(--shadow);border:1px solid var(--border)}
.dash-filters .field-group{min-width:130px}

/* KPI row */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:22px}
.kpi-card{background:white;border-radius:12px;box-shadow:var(--shadow);border:1px solid var(--border);padding:16px 18px;display:flex;flex-direction:column;gap:4px}
.kpi-label{font-size:0.68rem;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:0.08em}
.kpi-value{font-size:1.6rem;font-weight:700;color:var(--deep);line-height:1.1;font-family:'Playfair Display',serif}
.kpi-sub{font-size:0.72rem;color:var(--text-mid)}
.kpi-card.accent{border-top:3px solid var(--accent)}
.kpi-card.amber{border-top:3px solid var(--accent2)}
.kpi-card.green{border-top:3px solid var(--flag-green)}
.kpi-card.red{border-top:3px solid var(--flag-red)}

/* Two-column dashboard layout */
.dash-cols{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
@media(max-width:700px){.dash-cols{grid-template-columns:1fr}}

.dash-card{background:white;border-radius:13px;box-shadow:var(--shadow);border:1px solid var(--border);overflow:hidden}
.dash-card-hdr{background:var(--deep);color:var(--cream);padding:12px 18px;display:flex;align-items:center;gap:8px;font-family:'Playfair Display',serif;font-size:0.92rem;font-weight:600}
.dash-card-body{padding:18px}

/* Bar chart rows */
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:9px}
.bar-label{font-size:0.8rem;color:var(--text-dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:90px;max-width:120px}
.bar-track{flex:1;height:9px;background:var(--steam);border-radius:5px;overflow:hidden}
.bar-fill{height:100%;border-radius:5px;transition:width 0.5s ease}
.bar-val{font-size:0.78rem;font-weight:600;color:var(--text-mid);min-width:40px;text-align:right}

/* Table inside dash */
.dash-table{width:100%;border-collapse:collapse;font-size:0.82rem}
.dash-table th{padding:7px 10px;font-size:0.66rem;font-weight:600;text-transform:uppercase;letter-spacing:0.07em;color:var(--text-light);border-bottom:1.5px solid var(--steam);text-align:left}
.dash-table td{padding:8px 10px;border-bottom:1px solid var(--steam);vertical-align:middle}
.dash-table tr:last-child td{border-bottom:none}
.dash-table tr:hover td{background:var(--milk)}
.dash-table td:first-child{font-weight:600;color:var(--deep)}

/* Violations list */
.violation-item{display:flex;align-items:flex-start;gap:10px;padding:9px 0;border-bottom:1px solid var(--steam);font-size:0.82rem}
.violation-item:last-child{border-bottom:none}
.violation-dot{width:8px;height:8px;border-radius:50%;background:var(--flag-red);flex-shrink:0;margin-top:4px}
.violation-dot.warn{background:var(--flag-amber)}

/* ADMIN */
#adminLock{max-width:360px;margin:60px auto;text-align:center}
#adminLock .lock-icon{font-size:3rem;margin-bottom:14px}
#adminLock h2{font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--deep);margin-bottom:6px}
#adminLock p{font-size:0.85rem;color:var(--text-mid);margin-bottom:20px}
#adminLock input{width:100%;padding:10px 14px;border:1.5px solid var(--steam);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.95rem;margin-bottom:10px;background:var(--milk);text-align:center;letter-spacing:0.1em}
#adminLock input:focus{outline:none;border-color:var(--accent)}
#adminLock .lock-err{color:var(--flag-red);font-size:0.82rem;margin-top:8px;display:none}
.admin-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.admin-action-card{background:white;border-radius:13px;border:1px solid var(--border);box-shadow:var(--shadow);padding:20px}
.admin-action-card h3{font-family:'Playfair Display',serif;font-size:0.96rem;color:var(--deep);margin-bottom:6px}
.admin-action-card p{font-size:0.79rem;color:var(--text-mid);margin-bottom:14px;line-height:1.5}
.admin-logout{display:flex;justify-content:flex-end;margin-bottom:16px}
.upload-zone{border:2px dashed var(--steam);border-radius:9px;padding:20px 14px;text-align:center;cursor:pointer;transition:border-color 0.15s,background 0.15s;font-size:0.81rem;color:var(--text-light)}
.upload-zone:hover{border-color:var(--accent);background:rgba(61,139,205,0.03);color:var(--accent)}
.upload-zone input[type="file"]{display:none}
.upload-zone .upload-icon{font-size:1.7rem;margin-bottom:5px;display:block}

/* GOOGLE SHEETS SYNC */
.sync-card{background:white;border-radius:13px;border:1px solid var(--border);box-shadow:var(--shadow);padding:20px;grid-column:1/-1}
.sync-card h3{font-family:'Playfair Display',serif;font-size:0.96rem;color:var(--deep);margin-bottom:6px;display:flex;align-items:center;gap:8px}
.sync-url-row{display:flex;gap:8px;margin-bottom:12px}
.sync-url-row input{flex:1;padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.84rem;color:var(--text-dark);background:var(--milk)}
.sync-url-row input:focus{outline:none;border-color:var(--accent);background:white}
.sync-status{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;font-size:0.82rem;margin-top:12px;min-height:40px}
.sync-status.idle{background:var(--chalk);color:var(--text-mid)}
.sync-status.syncing{background:rgba(61,139,205,0.08);color:var(--accent);border:1px solid rgba(61,139,205,0.2)}
.sync-status.success{background:rgba(26,154,90,0.09);color:var(--flag-green);border:1px solid rgba(26,154,90,0.22)}
.sync-status.error{background:rgba(192,57,43,0.08);color:var(--flag-red);border:1px solid rgba(192,57,43,0.2)}
.sync-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.sync-status.idle .sync-dot{background:var(--text-light)}
.sync-status.syncing .sync-dot{background:var(--accent);animation:pulse 1s infinite}
.sync-status.success .sync-dot{background:var(--flag-green)}
.sync-status.error .sync-dot{background:var(--flag-red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.sync-meta{font-size:0.75rem;color:var(--text-light);margin-top:6px}

/* TOAST + MODAL */
.toast{position:fixed;bottom:22px;right:22px;background:var(--ink);color:var(--cream);padding:10px 17px;border-radius:8px;font-size:0.85rem;font-weight:500;box-shadow:0 4px 20px rgba(0,0,0,0.28);transform:translateY(70px);opacity:0;transition:all 0.3s ease;z-index:9999;max-width:320px}
.toast.show{transform:translateY(0);opacity:1}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:500}
.modal-overlay.open{display:flex}
.modal{background:white;border-radius:13px;padding:26px;max-width:400px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.25)}
.modal h3{font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:10px;color:var(--deep)}
.modal p{font-size:0.85rem;color:var(--text-mid);margin-bottom:18px;line-height:1.6}
.modal-actions{display:flex;gap:10px;justify-content:flex-end}

@media(max-width:720px){
  header{padding:0 12px;flex-wrap:wrap}
  nav{margin-left:0;order:3;width:100%;border-top:1px solid rgba(255,255,255,0.06)}
  .nav-tab{padding:0 11px;font-size:0.78rem}
  main{padding:14px 10px}
  .card-body{padding:14px}
  .logo-text h1{font-size:1.05rem}
  .admin-grid{grid-template-columns:1fr}
  .kpi-row{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<header>
  <a class="logo" href="#" onclick="switchPage('dashboard');return false;">
    <svg class="swallow-icon" viewBox="0 0 80 60" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M40 28 C36 22,20 14,4 18 C12 20,18 24,20 30 C16 28,8 27,2 30 C10 32,16 34,18 40 C14 40,6 42,2 48 C12 44,22 40,28 36 C30 42,32 50,34 58 C36 50,38 40,40 34 C42 40,44 50,46 58 C48 50,50 42,52 36 C58 40,68 44,78 48 C74 42,66 40,62 40 C64 34,70 32,78 30 C72 27,64 28,60 30 C62 24,68 20,76 18 C60 14,44 22,40 28Z" fill="#3d8bcd"/>
      <circle cx="40" cy="26" r="3" fill="#e8a020"/>
    </svg>
    <div class="logo-text"><h1>GWOC</h1><span>Timesheet System</span></div>
  </a>
  <nav>
    <div class="nav-tab" id="tab-dashboard" onclick="switchPage('dashboard')">üìä Dashboard</div>
    <div class="nav-tab active" id="tab-timesheets" onclick="switchPage('timesheets')">üóì Timesheets</div>
    <div class="nav-tab" id="tab-staff" onclick="switchPage('staff')">üë§ Staff <span class="nav-badge" id="staffBadge">0</span></div>
    <div class="nav-tab" id="tab-locations" onclick="switchPage('locations')">üìç Locations <span class="nav-badge" id="locBadge" style="background:var(--accent2)">0</span></div>
    <div class="nav-tab nav-admin" id="tab-admin" onclick="switchPage('admin')">‚öô Admin</div>
  </nav>
</header>

<main>

<!-- ==================== DASHBOARD ==================== -->
<div class="page" id="page-dashboard">

  <div class="dash-filters">
    <div class="field-group">
      <label>From</label>
      <input type="date" id="dashFrom" onchange="renderDashboard()">
    </div>
    <div class="field-group">
      <label>To</label>
      <input type="date" id="dashTo" onchange="renderDashboard()">
    </div>
    <div class="field-group">
      <label>Location</label>
      <select id="dashLoc" onchange="renderDashboard()">
        <option value="">All locations</option>
      </select>
    </div>
    <button class="btn btn-outline" onclick="setDashPeriod('week')">This Week</button>
    <button class="btn btn-outline" onclick="setDashPeriod('month')">This Month</button>
    <button class="btn btn-outline" onclick="setDashPeriod('all')">All Time</button>
  </div>

  <!-- KPI row -->
  <div class="kpi-row" id="kpiRow"></div>

  <!-- Charts row -->
  <div class="dash-cols">
    <div class="dash-card">
      <div class="dash-card-hdr">üë§ Hours by Employee</div>
      <div class="dash-card-body" id="chartEmployee"></div>
    </div>
    <div class="dash-card">
      <div class="dash-card-hdr">üìç Hours by Location</div>
      <div class="dash-card-body" id="chartLocation"></div>
    </div>
  </div>

  <div class="dash-cols">
    <div class="dash-card">
      <div class="dash-card-hdr">üìÖ Hours by Day of Week</div>
      <div class="dash-card-body" id="chartDow"></div>
    </div>
    <div class="dash-card">
      <div class="dash-card-hdr">‚ö† Break Violations</div>
      <div class="dash-card-body" id="chartViolations"></div>
    </div>
  </div>

  <!-- Detail table -->
  <div class="dash-card" style="margin-bottom:0">
    <div class="dash-card-hdr">üìã Staff Summary Table</div>
    <div class="dash-card-body" style="padding:0;overflow-x:auto">
      <table class="dash-table" id="staffSummaryTable">
        <thead><tr>
          <th>Name</th><th>Shifts</th><th>Total Hours</th><th>Avg Shift</th><th>Locations</th><th>Violations</th>
        </tr></thead>
        <tbody id="staffSummaryBody"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- ==================== TIMESHEETS ==================== -->
<div class="page active" id="page-timesheets">
  <div class="card">
    <div class="card-header"><span>‚úèÔ∏è</span><h2>Log Shifts</h2></div>
    <div class="card-body">
      <div style="display:flex;gap:14px;margin-bottom:16px;flex-wrap:wrap;align-items:flex-end">
        <div class="field-group" style="min-width:220px;max-width:300px;flex:1">
          <label>Staff Name</label>
          <div class="ac-wrap">
            <input type="text" id="staffName" placeholder="Type or search name..." autocomplete="off"
              oninput="acInput('staffName','acDropStaff',loadStaff,'name')"
              onkeydown="acKeydown(event,'staffName','acDropStaff',loadStaff,'name')"
              onfocus="acInput('staffName','acDropStaff',loadStaff,'name')"
              onblur="acBlur('acDropStaff')">
            <div class="ac-drop" id="acDropStaff" style="display:none"></div>
          </div>
        </div>
      </div>
      <table class="shifts-table">
        <thead><tr>
          <th style="width:112px">Date</th>
          <th style="width:90px">Start</th>
          <th style="width:90px">End</th>
          <th style="width:130px">Location</th>
          <th style="width:110px">Break Taken</th>
          <th style="width:62px">Net Hrs</th>
          <th style="width:144px">Status</th>
          <th style="width:34px"></th>
        </tr></thead>
        <tbody id="shiftRows"></tbody>
      </table>
      <button class="add-row-btn" onclick="addShiftRow()"><span style="font-size:1.1rem;font-weight:700">+</span> Add Shift Row</button>
      <div class="break-rule-note">
        <strong>Break rules:</strong> A 15-minute unpaid break is required for every complete 6-hour block worked.
        Examples: under 6h = no break required; 6‚Äì11h 59m = 15 min; 12‚Äì17h 59m = 30 min; 18‚Äì23h 59m = 45 min.
        Maximum break that can be logged is <strong>90 minutes</strong>. Break time is deducted from gross hours to give net hours.
        Amber flag = insufficient break logged. Red flag = no break logged at all.
      </div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="resetForm()">Clear Form</button>
        <button class="btn btn-primary" onclick="saveEntry()">Save Timesheet</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><span>üìã</span><h2>Timesheet Records</h2></div>
    <div class="rec-controls">
      <div><label>Staff</label><br><input type="text" id="filterName" placeholder="Name..." oninput="renderRecords()" style="margin-top:3px;width:130px"></div>
      <div><label>Location</label><br><select id="filterLoc" onchange="renderRecords()" style="margin-top:3px;width:130px"><option value="">All</option></select></div>
      <div><label>From</label><br><input type="date" id="filterFrom" onchange="renderRecords()" style="margin-top:3px"></div>
      <div><label>To</label><br><input type="date" id="filterTo" onchange="renderRecords()" style="margin-top:3px"></div>
    </div>
    <div id="recordsContainer"></div>
    <div class="summary-bar" id="summaryBar"></div>
  </div>
</div>

<!-- ==================== STAFF ==================== -->
<div class="page" id="page-staff">
  <div class="card">
    <div class="card-header"><span>üë§</span><h2>Staff Directory</h2></div>
    <div class="card-body">
      <div class="entity-add-form">
        <div class="field-group" style="min-width:130px;flex:1"><label>First Name</label><input type="text" id="newFirst" placeholder="e.g. Sarah" autocomplete="off" onkeydown="if(event.key==='Enter')addStaff()"></div>
        <div class="field-group" style="min-width:130px;flex:1"><label>Last Name</label><input type="text" id="newLast" placeholder="e.g. Mitchell" autocomplete="off" onkeydown="if(event.key==='Enter')addStaff()"></div>
        <div class="field-group" style="min-width:120px;flex:1"><label>Role <span style="font-weight:400;font-size:0.68rem">(optional)</span></label><input type="text" id="newRole" placeholder="e.g. Barista" autocomplete="off" onkeydown="if(event.key==='Enter')addStaff()"></div>
        <button class="btn btn-primary" onclick="addStaff()" style="flex-shrink:0;white-space:nowrap">Add Staff Member</button>
      </div>
      <div id="staffGrid"></div>
    </div>
  </div>
</div>

<!-- ==================== LOCATIONS ==================== -->
<div class="page" id="page-locations">
  <div class="card">
    <div class="card-header"><span>üìç</span><h2>Locations</h2></div>
    <div class="card-body">
      <div class="entity-add-form">
        <div class="field-group" style="min-width:160px;flex:1"><label>Location Name</label><input type="text" id="newLocName" placeholder="e.g. High Street" autocomplete="off" onkeydown="if(event.key==='Enter')addLocation()"></div>

        <button class="btn btn-primary" onclick="addLocation()" style="flex-shrink:0">Add Location</button>
      </div>
      <div id="locGrid"></div>
    </div>
  </div>
</div>

<!-- ==================== ADMIN ==================== -->
<div class="page" id="page-admin">
  <div id="adminLock">
    <div class="lock-icon">üîí</div>
    <h2>Admin Access</h2>
    <p>Enter the admin password to continue.</p>
    <input type="password" id="adminPwInput" placeholder="Password" onkeydown="if(event.key==='Enter')checkAdminPw()">
    <button class="btn btn-primary" style="width:100%" onclick="checkAdminPw()">Unlock</button>
    <div class="lock-err" id="pwErr">Incorrect password. Please try again.</div>
  </div>
  <div id="adminPanel" style="display:none">
    <div class="admin-logout"><button class="btn btn-outline" onclick="lockAdmin()">üîí Lock Admin</button></div>
    <div class="admin-grid">

      <!-- GOOGLE SHEETS SYNC ‚Äî full width -->
      <div class="sync-card">
        <h3>
          <svg width="20" height="20" viewBox="0 0 48 48" fill="none" style="flex-shrink:0"><rect width="48" height="48" rx="6" fill="#0f9d58"/><path d="M14 13h20v22H14V13z" fill="white"/><rect x="18" y="17" width="12" height="2" rx="1" fill="#0f9d58"/><rect x="18" y="21" width="12" height="2" rx="1" fill="#0f9d58"/><rect x="18" y="25" width="8" height="2" rx="1" fill="#0f9d58"/></svg>
          Google Sheets Backup Sync
        </h3>
        <p style="font-size:0.79rem;color:var(--text-mid);margin-bottom:14px;line-height:1.55">
          Push all timesheet records to a Google Sheet for backup. Paste your Apps Script Web App URL below, then click Sync Now.
          Each sync overwrites the <em>Timesheets</em> tab completely with the latest data.
          <br><a href="#" onclick="showSetupGuide();return false;" style="color:var(--accent);font-size:0.78rem;text-decoration:none">üìñ View setup instructions</a>
          &nbsp;&nbsp;<a href="#" onclick="openScriptUrl();return false;" style="color:var(--text-light);font-size:0.78rem;text-decoration:none">üîó Open URL in browser</a>
        </p>
        <div class="sync-url-row">
          <input type="url" id="sheetsWebAppUrl" placeholder="https://script.google.com/macros/s/.../exec" oninput="saveSyncUrl()">
          <button class="btn btn-outline" onclick="testConnection()" id="testBtn" style="white-space:nowrap;flex-shrink:0">Test</button>
          <select id="syncMode" style="padding:8px 10px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.83rem;background:var(--milk);color:var(--text-dark);-webkit-appearance:none;appearance:none;flex-shrink:0" onchange="saveSyncMode()">
            <option value="append">Append new rows</option>
            <option value="replace">Replace all</option>
          </select>
          <button class="btn btn-primary" onclick="syncToSheets()" id="syncBtn" style="flex-shrink:0">Sync Now</button>
        </div>
        <div class="sync-status idle" id="syncStatus">
          <div class="sync-dot"></div>
          <span id="syncStatusText">Not yet synced ‚Äî click Test first to verify connection</span>
        </div>
        <div class="sync-meta" id="syncMeta"></div>
      </div>

      <div class="admin-action-card">
        <h3>üì• Export Timesheets</h3>
        <p>Download all timesheet records as a CSV file, compatible with Excel and Google Sheets.</p>
        <button class="btn btn-primary" onclick="exportCSV()">Download Timesheets CSV</button>
      </div>
      <div class="admin-action-card">
        <h3>üì• Export Staff List</h3>
        <p>Download the current staff directory as a CSV, useful for backups or bulk edits.</p>
        <button class="btn btn-secondary" onclick="exportStaffCSV()">Download Staff CSV</button>
      </div>
      <div class="admin-action-card">
        <h3>üì§ Upload Staff (CSV)</h3>
        <p>Bulk-import staff from a CSV. Columns: <strong>name</strong> (or first_name + last_name) and optionally <strong>role</strong>. Duplicates are skipped.</p>
        <div class="upload-zone" onclick="document.getElementById('staffUpload').click()">
          <span class="upload-icon">‚¨ÜÔ∏è</span>Click to select a CSV file
          <input type="file" id="staffUpload" accept=".csv" onchange="importStaffCSV(event)">
        </div>
      </div>
      <div class="admin-action-card">
        <h3 style="color:var(--flag-red)">üóë Clear Timesheet Data</h3>
        <p>Permanently delete all timesheet records. Staff and location data are not affected.</p>
        <button class="btn btn-red" onclick="clearTimesheets()">Clear All Timesheets</button>
      </div>
      <div class="admin-action-card">
        <h3 style="color:var(--flag-red)">üóë Clear All Data</h3>
        <p>Permanently delete all data including timesheets, staff, and locations. Use with caution.</p>
        <button class="btn btn-red" onclick="clearEverything()">Clear Everything</button>
      </div>
      <div class="admin-action-card">
        <h3>üîë Change Password</h3>
        <p>Update the admin password. Default is <strong>admin1234</strong> ‚Äî change before use.</p>
        <div style="display:flex;flex-direction:column;gap:8px">
          <input type="password" id="newPw1" placeholder="New password" style="padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.87rem;background:var(--milk)">
          <input type="password" id="newPw2" placeholder="Confirm new password" style="padding:8px 11px;border:1.5px solid var(--steam);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:0.87rem;background:var(--milk)">
          <button class="btn btn-outline" onclick="changePassword()">Update Password</button>
        </div>
      </div>
    </div>
  </div>
</div>

</main>

<div class="modal-overlay" id="confirmModal">
  <div class="modal">
    <h3 id="modalTitle">Confirm</h3><p id="modalMsg"></p>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-red" id="modalConfirmBtn">Delete</button>
    </div>
  </div>
</div>

<!-- Setup guide modal -->
<div class="modal-overlay" id="setupGuideModal" onclick="if(event.target===this)closeSetupGuide()">
  <div class="modal" style="max-width:560px;max-height:88vh;overflow-y:auto">
    <h3>üìñ Google Sheets Setup Guide</h3>
    <div style="font-size:0.83rem;color:var(--text-mid);line-height:1.7">
      <p style="margin-bottom:12px">This takes about 3 minutes. You only need to do it once.</p>

      <p><strong style="color:var(--deep)">Step 1 ‚Äî Create a Google Sheet</strong></p>
      <p style="margin-bottom:10px">Go to <a href="https://sheets.google.com" target="_blank" style="color:var(--accent)">sheets.google.com</a> and create a new blank spreadsheet. Name it something like <em>GWOC Timesheets</em>.</p>

      <p><strong style="color:var(--deep)">Step 2 ‚Äî Open Apps Script</strong></p>
      <p style="margin-bottom:10px">In the sheet, go to <strong>Extensions ‚Üí Apps Script</strong>. Delete any existing code in the editor.</p>

      <p><strong style="color:var(--deep)">Step 3 ‚Äî Paste the Apps Script</strong></p>
      <p style="margin-bottom:6px">Copy the entire contents of the file <strong>gwoc-sheets-script.gs</strong> (provided alongside this app) and paste it into the Apps Script editor. Click <strong>Save</strong> (üíæ).</p>

      <p><strong style="color:var(--deep)">Step 4 ‚Äî Deploy as a Web App</strong></p>
      <p style="margin-bottom:4px">Click <strong>Deploy ‚Üí New deployment</strong>.</p>
      <ul style="margin-left:18px;margin-bottom:10px">
        <li>Type: <strong>Web app</strong></li>
        <li>Execute as: <strong>Me</strong></li>
        <li>Who has access: <strong>Anyone</strong></li>
      </ul>
      <p style="margin-bottom:10px">Click <strong>Deploy</strong>. Google will ask you to authorise ‚Äî click through the permissions. Copy the <strong>Web App URL</strong> it gives you.</p>

      <p><strong style="color:var(--deep)">Step 5 ‚Äî Paste the URL here</strong></p>
      <p style="margin-bottom:14px">Close this guide, paste the URL into the Sync URL field in Admin, and click <strong>Sync Now</strong>. Your data will appear in a tab called <em>Timesheets</em> in the Google Sheet.</p>

      <div style="background:var(--chalk);border-left:3px solid var(--accent2);border-radius:0 7px 7px 0;padding:10px 13px;font-size:0.78rem;color:var(--text-mid)">
        <strong>Note:</strong> Each sync fully overwrites the Timesheets tab. It does not append ‚Äî it replaces. This keeps the sheet clean and consistent with your local data.
      </div>
    </div>
    <div class="modal-actions" style="margin-top:18px">
      <button class="btn btn-primary" onclick="closeSetupGuide()">Got it</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ================================================================
// CONSTANTS
// ================================================================
const ADMIN_PW_KEY = 'gwoc_admin_pw';
const DEFAULT_PW   = 'admin1234';
const MAX_BREAK    = 90; // minutes

// ================================================================
// NAVIGATION
// ================================================================
function switchPage(p) {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
  document.getElementById('page-' + p).classList.add('active');
  document.getElementById('tab-' + p).classList.add('active');
  if (p === 'timesheets') { renderRecords(); populateLocFilter(); }
  if (p === 'staff')      renderStaffGrid();
  if (p === 'locations')  renderLocGrid();
  if (p === 'dashboard')  { populateDashLocFilter(); renderDashboard(); }
}

// ================================================================
// ADMIN
// ================================================================
let adminUnlocked = false;
function getAdminPw() { return localStorage.getItem(ADMIN_PW_KEY) || DEFAULT_PW; }
function checkAdminPw() {
  const val = document.getElementById('adminPwInput').value;
  if (val === getAdminPw()) {
    adminUnlocked = true;
    document.getElementById('adminLock').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    document.getElementById('adminPwInput').value = '';
    document.getElementById('pwErr').style.display = 'none';
    renderRecords(); // refresh delete button states
  } else {
    document.getElementById('pwErr').style.display = 'block';
    document.getElementById('adminPwInput').value = '';
  }
}
function lockAdmin() {
  adminUnlocked = false;
  document.getElementById('adminLock').style.display = 'block';
  document.getElementById('adminPanel').style.display = 'none';
  renderRecords(); // refresh delete button states
}
function changePassword() {
  const p1 = document.getElementById('newPw1').value;
  const p2 = document.getElementById('newPw2').value;
  if (!p1) { showToast('Please enter a new password'); return; }
  if (p1 !== p2) { showToast('Passwords do not match'); return; }
  if (p1.length < 6) { showToast('Password must be at least 6 characters'); return; }
  localStorage.setItem(ADMIN_PW_KEY, p1);
  document.getElementById('newPw1').value = '';
  document.getElementById('newPw2').value = '';
  showToast('Password updated');
}

// ================================================================
// MODAL
// ================================================================
let _mc = null;
function showConfirm(title, msg, cb) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalMsg').textContent = msg;
  _mc = cb;
  document.getElementById('confirmModal').classList.add('open');
}
function closeModal() { document.getElementById('confirmModal').classList.remove('open'); _mc = null; }
document.getElementById('modalConfirmBtn').onclick = () => { if (_mc) _mc(); closeModal(); };
document.getElementById('confirmModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

// ================================================================
// STAFF DATA
// ================================================================
function loadStaff() { try { return JSON.parse(localStorage.getItem('gwoc_staff') || '[]'); } catch { return []; } }
function saveStaffList(list) { localStorage.setItem('gwoc_staff', JSON.stringify(list)); document.getElementById('staffBadge').textContent = list.length; }
function initBadges() { document.getElementById('staffBadge').textContent = loadStaff().length; document.getElementById('locBadge').textContent = loadLocations().length; }

function addStaff() {
  const first = document.getElementById('newFirst').value.trim();
  const last  = document.getElementById('newLast').value.trim();
  const role  = document.getElementById('newRole').value.trim();
  if (!first && !last) { showToast('Please enter at least a first or last name'); return; }
  const name = [first, last].filter(Boolean).join(' ');
  const list = loadStaff();
  if (list.find(s => s.name.toLowerCase() === name.toLowerCase())) { showToast('That name already exists'); return; }
  list.push({ id: Date.now(), name, role });
  list.sort((a, b) => a.name.localeCompare(b.name));
  saveStaffList(list);
  document.getElementById('newFirst').value = '';
  document.getElementById('newLast').value = '';
  document.getElementById('newRole').value = '';
  document.getElementById('newFirst').focus();
  renderStaffGrid();
  showToast('Staff member added');
}
function deleteStaff(id) {
  showConfirm('Remove Staff Member', 'This cannot be undone.', () => { saveStaffList(loadStaff().filter(s => s.id !== id)); renderStaffGrid(); showToast('Staff member removed'); });
}

const AV_COLS = ['#2e7bc9','#7056a0','#1a9a5a','#c97b2e','#b54d2e','#2e9fc9','#a07c2e','#b52e7e'];
function avColor(name) { let h=0; for(let i=0;i<name.length;i++) h=name.charCodeAt(i)+((h<<5)-h); return AV_COLS[Math.abs(h)%AV_COLS.length]; }
function initials(name) { return name.split(' ').map(w=>w[0]||'').join('').toUpperCase().slice(0,2); }

function renderStaffGrid() {
  const grid = document.getElementById('staffGrid');
  const list = loadStaff();
  if (!list.length) { grid.innerHTML='<div class="empty-state" style="padding:24px 0"><div class="icon">üë§</div><p>No staff added yet.</p></div>'; return; }
  grid.innerHTML = `<div class="entity-grid">${list.map(s=>`
    <div class="entity-card">
      <div class="entity-avatar" style="background:${avColor(s.name)}">${initials(s.name)}</div>
      <div class="entity-info"><div class="entity-name">${s.name}</div><div class="entity-sub">${s.role||'<span style="font-style:italic">No role</span>'}</div></div>
      <button class="entity-del" onclick="deleteStaff(${s.id})" title="Remove">√ó</button>
    </div>`).join('')}</div>`;
}

// ================================================================
// LOCATION DATA
// ================================================================
function loadLocations() { try { return JSON.parse(localStorage.getItem('gwoc_locations') || '[]'); } catch { return []; } }
function saveLocations(list) { localStorage.setItem('gwoc_locations', JSON.stringify(list)); document.getElementById('locBadge').textContent = list.length; }

function addLocation() {
  const name = document.getElementById('newLocName').value.trim();
  if (!name) { showToast('Please enter a location name'); return; }
  const list = loadLocations();
  if (list.find(l => l.name.toLowerCase() === name.toLowerCase())) { showToast('That location already exists'); return; }
  list.push({ id: Date.now(), name });
  list.sort((a, b) => a.name.localeCompare(b.name));
  saveLocations(list);
  document.getElementById('newLocName').value = '';
  document.getElementById('newLocName').focus();
  renderLocGrid(); rebuildLocSelects();
  showToast('Location added');
}
function deleteLocation(id) {
  showConfirm('Remove Location', 'This cannot be undone.', () => { saveLocations(loadLocations().filter(l => l.id !== id)); renderLocGrid(); rebuildLocSelects(); showToast('Location removed'); });
}
function renderLocGrid() {
  const grid = document.getElementById('locGrid');
  const list = loadLocations();
  if (!list.length) { grid.innerHTML='<div class="empty-state" style="padding:24px 0"><div class="icon">üìç</div><p>No locations added yet.</p></div>'; return; }
  grid.innerHTML = `<div class="entity-grid">${list.map(l=>`
    <div class="entity-card">
      <div class="loc-icon">üìç</div>
      <div class="entity-info"><div class="entity-name">${l.name}</div></div>
      <button class="entity-del" onclick="deleteLocation(${l.id})" title="Remove">√ó</button>
    </div>`).join('')}</div>`;
}
function rebuildLocSelects() {
  const locs = loadLocations();
  document.querySelectorAll('.s-loc').forEach(sel => {
    const cur = sel.value;
    sel.innerHTML = '<option value="">-- Location --</option>' + locs.map(l=>`<option value="${l.name}"${l.name===cur?' selected':''}>${l.name}</option>`).join('');
  });
  populateLocFilter();
  populateDashLocFilter();
}
function populateLocFilter() {
  const sel = document.getElementById('filterLoc');
  const cur = sel.value;
  const locs = loadLocations();
  sel.innerHTML = '<option value="">All</option>' + locs.map(l=>`<option value="${l.name}"${l.name===cur?' selected':''}>${l.name}</option>`).join('');
}
function populateDashLocFilter() {
  const sel = document.getElementById('dashLoc');
  const cur = sel.value;
  const locs = loadLocations();
  sel.innerHTML = '<option value="">All locations</option>' + locs.map(l=>`<option value="${l.name}"${l.name===cur?' selected':''}>${l.name}</option>`).join('');
}

// ================================================================
// AUTOCOMPLETE
// ================================================================
let acIdx = {};
function acInput(inputId, dropId, dataFn, field) {
  const val = document.getElementById(inputId).value.trim().toLowerCase();
  const matches = val ? dataFn().filter(s=>s[field].toLowerCase().includes(val)) : dataFn();
  acIdx[dropId] = -1;
  const dd = document.getElementById(dropId);
  if (!matches.length) { dd.innerHTML='<div class="ac-empty">No matches ‚Äî type freely</div>'; }
  else { dd.innerHTML = matches.map((s,i)=>`<div class="ac-item" data-idx="${i}" data-val="${s[field].replace(/"/g,'&quot;')}" onmousedown="acSel('${inputId}','${dropId}','${s[field].replace(/'/g,"\\'")}')"><div class="ac-av" style="background:${avColor(s[field])}">${initials(s[field])}</div><span>${s[field]}</span>${s.role?`<span class="ac-role-lbl">${s.role}</span>`:''}</div>`).join(''); }
  dd.style.display = 'block';
}
function acSel(inputId, dropId, val) { document.getElementById(inputId).value=val; document.getElementById(dropId).style.display='none'; acIdx[dropId]=-1; }
function acBlur(dropId) { setTimeout(()=>{document.getElementById(dropId).style.display='none';acIdx[dropId]=-1;},160); }
function acKeydown(e, inputId, dropId, dataFn, field) {
  const dd = document.getElementById(dropId); if(dd.style.display==='none') return;
  const items = dd.querySelectorAll('.ac-item'); if(!items.length) return;
  if(!acIdx[dropId]&&acIdx[dropId]!==0) acIdx[dropId]=-1;
  if(e.key==='ArrowDown'){e.preventDefault();acIdx[dropId]=Math.min(acIdx[dropId]+1,items.length-1);}
  else if(e.key==='ArrowUp'){e.preventDefault();acIdx[dropId]=Math.max(acIdx[dropId]-1,0);}
  else if(e.key==='Enter'&&acIdx[dropId]>=0){e.preventDefault();acSel(inputId,dropId,items[acIdx[dropId]].dataset.val);return;}
  else if(e.key==='Escape'){dd.style.display='none';return;}
  items.forEach((el,i)=>el.classList.toggle('hl',i===acIdx[dropId]));
}

// ================================================================
// TIME & BREAK UTILITIES
// ================================================================
function genTimes() {
  const t=[];
  for(let h=0;h<24;h++) for(let m=0;m<60;m+=15) t.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
  return t;
}
const TIME_OPTS = genTimes();

// Break options: 0 to MAX_BREAK in 15-min steps
const BREAK_OPTS = (()=>{
  const opts=[{l:'No break',v:0}];
  for(let m=15;m<=MAX_BREAK;m+=15) opts.push({l:m<60?`${m} min`:`${Math.floor(m/60)}h${m%60?` ${m%60}m`:''}`,v:m});
  return opts;
})();

function toMins(t) { if(!t) return 0; const[h,m]=t.split(':').map(Number); return h*60+m; }

function requiredBreak(grossMins) { return Math.floor(grossMins/360)*15; } // 15 per full 6h block

function calcNetHours(start, end, breakMins) {
  if(!start||!end) return null;
  const gross = toMins(end)-toMins(start);
  if(gross<=0) return null;
  const req  = requiredBreak(gross);
  const deduct = Math.max(breakMins||0, req);
  return (gross-deduct)/60;
}

function breakStatus(start, end, breakMins) {
  if(!start||!end) return null;
  const gross = toMins(end)-toMins(start);
  if(gross<=0) return null;
  const req = requiredBreak(gross);
  const actual = breakMins||0;
  if(req===0) return {type:'ok',label:'‚úì OK',tip:'Under 6 hours, no break required'};
  if(actual===0) return {type:'error',label:`‚ö† ${req}m req.`,tip:`No break logged. ${req} min required (${Math.floor(gross/360)}√ó6h).`};
  if(actual<req)  return {type:'warn',label:`‚ö† Need ${req}m`,tip:`${actual} min logged, ${req} min required.`};
  return {type:'ok',label:`‚úì ${actual}m`,tip:`Requirement met (${req} min required).`};
}

// ================================================================
// SHIFT ROW BUILDER
// ================================================================
let rowId = 0;
function mkSel(cls, opts, val, fn) {
  const sel=document.createElement('select'); sel.className=cls; sel.onchange=fn;
  opts.forEach(o=>{ const opt=document.createElement('option'); opt.value=o.v!==undefined?o.v:o; opt.textContent=o.l!==undefined?o.l:o; if((o.v!==undefined?o.v:o)==val) opt.selected=true; sel.appendChild(opt); });
  return sel;
}

function addShiftRow(data={}) {
  const id=rowId++;
  const today=new Date().toISOString().split('T')[0];
  const tbody=document.getElementById('shiftRows');
  const tr=document.createElement('tr'); tr.className='shift-row'; tr.dataset.id=id;

  const td1=document.createElement('td');
  const di=document.createElement('input'); di.type='date'; di.value=data.date||today; di.onchange=()=>updateRow(id);
  td1.appendChild(di); tr.appendChild(td1);

  const td2=document.createElement('td');
  td2.appendChild(mkSel('s-start',TIME_OPTS.map(t=>({v:t,l:t})),data.start||'09:00',()=>updateRow(id)));
  tr.appendChild(td2);

  const td3=document.createElement('td');
  td3.appendChild(mkSel('s-end',TIME_OPTS.map(t=>({v:t,l:t})),data.end||'17:00',()=>updateRow(id)));
  tr.appendChild(td3);

  const td4=document.createElement('td');
  const locSel=document.createElement('select'); locSel.className='s-loc';
  locSel.innerHTML='<option value="">-- Location --</option>'+loadLocations().map(l=>`<option value="${l.name}"${l.name===data.location?' selected':''}>${l.name}</option>`).join('');
  td4.appendChild(locSel); tr.appendChild(td4);

  const td5=document.createElement('td');
  td5.appendChild(mkSel('s-brk',BREAK_OPTS,data.breakMins||0,()=>updateRow(id)));
  tr.appendChild(td5);

  const td6=document.createElement('td'); td6.className='hours-cell'; td6.dataset.role='hrs'; tr.appendChild(td6);
  const td7=document.createElement('td'); td7.dataset.role='sts'; tr.appendChild(td7);

  const td8=document.createElement('td');
  const db=document.createElement('button'); db.className='del-row-btn'; db.textContent='√ó'; db.title='Remove row';
  db.onclick=()=>tr.remove(); td8.appendChild(db); tr.appendChild(td8);

  tbody.appendChild(tr);
  updateRow(id);
}

function updateRow(id) {
  const tr=document.querySelector(`tr[data-id="${id}"]`); if(!tr) return;
  const s=tr.querySelector('.s-start').value;
  const e=tr.querySelector('.s-end').value;
  const b=parseInt(tr.querySelector('.s-brk').value)||0;
  const net=calcNetHours(s,e,b);
  const hc=tr.querySelector('[data-role="hrs"]');
  hc.textContent=(net!==null&&net>0)?net.toFixed(2)+'h':'--';
  hc.style.color=(net!==null&&net>0)?'var(--deep)':'var(--text-light)';
  const sc=tr.querySelector('[data-role="sts"]'); sc.innerHTML='';
  const st=breakStatus(s,e,b);
  if(st){ const badge=document.createElement('span'); badge.className=`break-flag ${st.type}`; badge.title=st.tip; badge.textContent=st.label; sc.appendChild(badge); }
}

function getRowData() {
  return Array.from(document.querySelectorAll('.shift-row')).map(tr=>{
    const date=tr.querySelector('input[type="date"]').value;
    const start=tr.querySelector('.s-start').value;
    const end=tr.querySelector('.s-end').value;
    const location=tr.querySelector('.s-loc').value;
    const breakMins=parseInt(tr.querySelector('.s-brk').value)||0;
    const gross=toMins(end)-toMins(start);
    const req=gross>0?requiredBreak(gross):0;
    const net=calcNetHours(start,end,breakMins);
    const st=breakStatus(start,end,breakMins);
    return {date,start,end,location,breakMins,requiredBreak:req,netHours:net,breakWarning:st?.type!=='ok'};
  }).filter(r=>r.date&&r.start&&r.end);
}

// ================================================================
// TIMESHEET STORAGE
// ================================================================
function loadRecords() { try { return JSON.parse(localStorage.getItem('gwoc_records')||'[]'); } catch { return []; } }
function saveRecords(r) { localStorage.setItem('gwoc_records', JSON.stringify(r)); }

function saveEntry() {
  const name=document.getElementById('staffName').value.trim();
  if(!name){showToast('Please enter a staff name');return;}
  const shifts=getRowData();
  if(!shifts.length){showToast('Please add at least one shift row');return;}
  const warn=shifts.some(s=>s.breakWarning);
  const recs=loadRecords();
  recs.unshift({id:Date.now(),name,shifts,savedAt:new Date().toISOString()});
  saveRecords(recs);
  resetForm(); renderRecords();
  showToast(warn?'Saved ‚Äî break violations flagged':'Timesheet saved');
}

function deleteRecord(id) {
  if (!adminUnlocked) {
    showToast('Unlock Admin to delete records');
    return;
  }
  showConfirm('Delete Entry','Delete this timesheet entry?',()=>{saveRecords(loadRecords().filter(r=>r.id!==id));renderRecords();showToast('Entry deleted');});
}

// ================================================================
// RENDER RECORDS
// ================================================================
function renderRecords() {
  const cont=document.getElementById('recordsContainer');
  const summ=document.getElementById('summaryBar');
  let recs=loadRecords();
  const fn=document.getElementById('filterName').value.trim().toLowerCase();
  const fl=document.getElementById('filterLoc').value;
  const ff=document.getElementById('filterFrom').value;
  const ft=document.getElementById('filterTo').value;
  if(fn) recs=recs.filter(r=>r.name.toLowerCase().includes(fn));
  if(fl) recs=recs.filter(r=>r.shifts.some(s=>s.location===fl));
  if(ff||ft) recs=recs.filter(r=>r.shifts.some(s=>{if(ff&&s.date<ff) return false; if(ft&&s.date>ft) return false; return true;}));
  if(!recs.length){cont.innerHTML=`<div class="empty-state"><div class="icon">üóì</div><p>No timesheet records yet.</p></div>`;summ.innerHTML='';return;}
  let totalNet=0,totalWarn=0,rows='';
  recs.forEach(entry=>{
    entry.shifts.forEach(s=>{
      const h=s.netHours||0; totalNet+=h; if(s.breakWarning) totalWarn++;
      const stHtml=s.breakWarning?'<span class="break-flag error">‚ö† Break issue</span>':'<span class="break-flag ok">‚úì OK</span>';
      rows+=`<tr>
        <td>${entry.name}</td>
        <td>${s.location||'<span style="color:var(--text-light);font-style:italic">None</span>'}</td>
        <td>${s.date}</td><td>${s.start}</td><td>${s.end}</td>
        <td>${s.breakMins>0?s.breakMins+'m':'‚Äî'}</td>
        <td>${s.requiredBreak>0?s.requiredBreak+'m':'‚Äî'}</td>
        <td style="text-align:center;font-weight:600;color:var(--deep)">${h>0?h.toFixed(2)+'h':'--'}</td>
        <td>${stHtml}</td>
        <td style="text-align:center"><button class="btn btn-danger-outline" onclick="deleteRecord(${entry.id})" title="${adminUnlocked?'Delete entry':'Unlock Admin to delete'}" style="${adminUnlocked?'':'opacity:0.35;cursor:not-allowed'}">‚úï</button></td>
      </tr>`;
    });
  });
  cont.innerHTML=`<div style="overflow-x:auto"><table class="rec-table"><thead><tr><th>Name</th><th>Location</th><th>Date</th><th>Start</th><th>End</th><th>Break</th><th>Req.</th><th>Net Hrs</th><th>Status</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
  summ.innerHTML=`<span>Showing <strong>${recs.length}</strong> ${recs.length===1?'entry':'entries'}</span><span>Total net hours: <strong>${totalNet.toFixed(2)}h</strong></span>${totalWarn>0?`<span style="color:var(--flag-red);font-weight:600">‚ö† ${totalWarn} break violation${totalWarn>1?'s':''}</span>`:'<span style="color:var(--flag-green)">‚úì No violations</span>'}`;
}

// ================================================================
// DASHBOARD
// ================================================================
function setDashPeriod(period) {
  const now = new Date();
  let from, to = now.toISOString().split('T')[0];
  if (period === 'week') {
    const d = new Date(now); d.setDate(d.getDate()-d.getDay()+1);
    from = d.toISOString().split('T')[0];
  } else if (period === 'month') {
    from = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  } else {
    from = ''; to = '';
  }
  document.getElementById('dashFrom').value = from;
  document.getElementById('dashTo').value   = to;
  renderDashboard();
}

function getDashShifts() {
  const ff  = document.getElementById('dashFrom').value;
  const ft  = document.getElementById('dashTo').value;
  const fl  = document.getElementById('dashLoc').value;
  const recs = loadRecords();
  const shifts = [];
  recs.forEach(entry => {
    entry.shifts.forEach(s => {
      if (ff && s.date < ff) return;
      if (ft && s.date > ft) return;
      if (fl && s.location !== fl) return;
      shifts.push({ ...s, staffName: entry.name });
    });
  });
  return shifts;
}

const BAR_COLORS = ['#3d8bcd','#e8a020','#1a9a5a','#7056a0','#c97b2e','#b52e7e','#2e9fc9','#b54d2e'];

function drawBars(containerId, data, colorFn, unit='h') {
  const cont = document.getElementById(containerId);
  if (!data.length) { cont.innerHTML='<div class="empty-state" style="padding:24px 0"><p>No data for this period.</p></div>'; return; }
  const max = Math.max(...data.map(d=>d.val));
  cont.innerHTML = data.map((d,i) => `
    <div class="bar-row">
      <div class="bar-label" title="${d.label}">${d.label}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${max>0?(d.val/max*100):0}%;background:${colorFn(i)}"></div></div>
      <div class="bar-val">${d.val.toFixed(1)}${unit}</div>
    </div>`).join('');
}

function renderDashboard() {
  const shifts = getDashShifts();

  // KPIs
  const totalHours   = shifts.reduce((a,s)=>a+(s.netHours||0),0);
  const totalShifts  = shifts.length;
  const uniqueStaff  = new Set(shifts.map(s=>s.staffName)).size;
  const violations   = shifts.filter(s=>s.breakWarning).length;
  const avgShift     = totalShifts > 0 ? totalHours/totalShifts : 0;

  document.getElementById('kpiRow').innerHTML = `
    <div class="kpi-card accent"><div class="kpi-label">Total Net Hours</div><div class="kpi-value">${totalHours.toFixed(1)}</div><div class="kpi-sub">across ${totalShifts} shift${totalShifts!==1?'s':''}</div></div>
    <div class="kpi-card green"><div class="kpi-label">Active Staff</div><div class="kpi-value">${uniqueStaff}</div><div class="kpi-sub">in selected period</div></div>
    <div class="kpi-card amber"><div class="kpi-label">Avg Shift Length</div><div class="kpi-value">${avgShift.toFixed(1)}h</div><div class="kpi-sub">net hours</div></div>
    <div class="kpi-card ${violations>0?'red':'green'}"><div class="kpi-label">Break Violations</div><div class="kpi-value">${violations}</div><div class="kpi-sub">${violations>0?'require attention':'all compliant'}</div></div>`;

  // Hours by employee
  const byEmp = {};
  shifts.forEach(s=>{ byEmp[s.staffName]=(byEmp[s.staffName]||0)+(s.netHours||0); });
  const empData = Object.entries(byEmp).sort((a,b)=>b[1]-a[1]).map(([label,val])=>({label,val}));
  drawBars('chartEmployee', empData, i=>AV_COLS[i%AV_COLS.length]);

  // Hours by location
  const byLoc = {};
  shifts.forEach(s=>{ const l=s.location||'Unspecified'; byLoc[l]=(byLoc[l]||0)+(s.netHours||0); });
  const locData = Object.entries(byLoc).sort((a,b)=>b[1]-a[1]).map(([label,val])=>({label,val}));
  drawBars('chartLocation', locData, i=>BAR_COLORS[i%BAR_COLORS.length]);

  // Hours by day of week
  const DOW = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const byDow = {Mon:0,Tue:0,Wed:0,Thu:0,Fri:0,Sat:0,Sun:0};
  shifts.forEach(s=>{ if(!s.date) return; const d=new Date(s.date); const k=DOW[(d.getDay()+6)%7]; byDow[k]=(byDow[k]||0)+(s.netHours||0); });
  drawBars('chartDow', DOW.map(d=>({label:d,val:byDow[d]})), i=>['#3d8bcd','#3d8bcd','#3d8bcd','#3d8bcd','#3d8bcd','#e8a020','#7056a0'][i]);

  // Violations list
  const violationShifts = shifts.filter(s=>s.breakWarning).slice(0,12);
  const vc = document.getElementById('chartViolations');
  if(!violationShifts.length) { vc.innerHTML='<div class="empty-state" style="padding:24px 0"><div class="icon" style="font-size:1.5rem">‚úÖ</div><p>No violations in this period.</p></div>'; }
  else {
    vc.innerHTML = violationShifts.map(s=>`
      <div class="violation-item">
        <div class="violation-dot"></div>
        <div>
          <strong>${s.staffName}</strong> ‚Äî ${s.date} &nbsp;${s.start}‚Äì${s.end}
          ${s.location?`<span style="color:var(--text-light);font-size:0.75rem"> @ ${s.location}</span>`:''}
          <div style="font-size:0.74rem;color:var(--text-light);margin-top:1px">
            Break taken: ${s.breakMins>0?s.breakMins+'m':'none'} &nbsp;|&nbsp; Required: ${s.requiredBreak}m
          </div>
        </div>
      </div>`).join('') + (shifts.filter(s=>s.breakWarning).length>12?`<div style="font-size:0.78rem;color:var(--text-light);padding:8px 0">...and ${shifts.filter(s=>s.breakWarning).length-12} more</div>`:'');
  }

  // Staff summary table
  const staffMap = {};
  shifts.forEach(s=>{
    if(!staffMap[s.staffName]) staffMap[s.staffName]={shifts:0,hours:0,locs:new Set(),violations:0};
    const e=staffMap[s.staffName];
    e.shifts++; e.hours+=(s.netHours||0);
    if(s.location) e.locs.add(s.location);
    if(s.breakWarning) e.violations++;
  });
  const tbody=document.getElementById('staffSummaryBody');
  tbody.innerHTML=Object.entries(staffMap).sort((a,b)=>b[1].hours-a[1].hours).map(([name,d])=>`
    <tr>
      <td><span style="display:inline-flex;align-items:center;gap:8px"><span style="width:24px;height:24px;border-radius:50%;background:${avColor(name)};display:inline-flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:700;color:white">${initials(name)}</span>${name}</span></td>
      <td>${d.shifts}</td>
      <td style="font-weight:600">${d.hours.toFixed(2)}h</td>
      <td>${d.shifts>0?(d.hours/d.shifts).toFixed(2)+'h':'‚Äî'}</td>
      <td style="font-size:0.78rem;color:var(--text-mid)">${[...d.locs].join(', ')||'‚Äî'}</td>
      <td>${d.violations>0?`<span class="break-flag error">‚ö† ${d.violations}</span>`:'<span class="break-flag ok">‚úì 0</span>'}</td>
    </tr>`).join('');
  if(!tbody.innerHTML) tbody.innerHTML='<tr><td colspan="6" style="text-align:center;padding:24px;color:var(--text-light);font-style:italic">No data for this period</td></tr>';
}

// ================================================================
// ADMIN: EXPORT / IMPORT / CLEAR
// ================================================================
function exportCSV() {
  const recs=loadRecords(); if(!recs.length){showToast('No records to export');return;}
  let csv='Name,Location,Date,Start,End,Break Taken (mins),Break Required (mins),Net Hours,Break Violation\n';
  recs.forEach(e=>e.shifts.forEach(s=>{csv+=`"${e.name}","${s.location||''}",${s.date},${s.start},${s.end},${s.breakMins},${s.requiredBreak||0},${s.netHours?s.netHours.toFixed(2):''},${s.breakWarning?'YES':'No'}\n`;}));
  dlFile(csv,`gwoc-timesheets-${today()}.csv`,'text/csv'); showToast('Timesheets CSV downloaded');
}
function exportStaffCSV() {
  const list=loadStaff(); if(!list.length){showToast('No staff to export');return;}
  let csv='name,role\n'; list.forEach(s=>{csv+=`"${s.name}","${s.role||''}"\n`;}); dlFile(csv,`gwoc-staff-${today()}.csv`,'text/csv'); showToast('Staff CSV downloaded');
}
function importStaffCSV(event) {
  const file=event.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const lines=e.target.result.split('\n').map(l=>l.trim()).filter(Boolean); if(!lines.length){showToast('Empty file');return;}
    const header=lines[0].toLowerCase().split(',').map(h=>h.replace(/['"]/g,'').trim());
    const nameIdx=header.indexOf('name'),firstIdx=header.indexOf('first_name'),lastIdx=header.indexOf('last_name'),roleIdx=header.indexOf('role');
    const list=loadStaff(); let added=0,skipped=0;
    const dataLines=(nameIdx>=0||firstIdx>=0)?lines.slice(1):lines;
    dataLines.forEach(line=>{
      if(!line) return;
      const cols=line.split(',').map(c=>c.replace(/^"|"$/g,'').trim());
      let name='';
      if(nameIdx>=0) name=cols[nameIdx]||'';
      else if(firstIdx>=0) name=[cols[firstIdx]||'',lastIdx>=0?cols[lastIdx]:''].filter(Boolean).join(' ');
      else name=cols[0]||'';
      const role=roleIdx>=0?(cols[roleIdx]||''):'';
      if(!name) return;
      if(list.find(s=>s.name.toLowerCase()===name.toLowerCase())){skipped++;return;}
      list.push({id:Date.now()+Math.random(),name,role}); added++;
    });
    list.sort((a,b)=>a.name.localeCompare(b.name)); saveStaffList(list); renderStaffGrid();
    showToast(`Imported ${added} staff${skipped?`, ${skipped} duplicate${skipped>1?'s':''} skipped`:''}`);
    event.target.value='';
  };
  reader.readAsText(file);
}
function clearTimesheets() { showConfirm('Clear All Timesheets','Delete all timesheet records permanently?',()=>{localStorage.removeItem('gwoc_records');renderRecords();showToast('All timesheet data cleared');}); }
function clearEverything() {
  showConfirm('Clear All Data','Delete ALL data ‚Äî timesheets, staff, and locations?',()=>{
    ['gwoc_records','gwoc_staff','gwoc_locations'].forEach(k=>localStorage.removeItem(k));
    initBadges(); renderRecords(); renderStaffGrid(); renderLocGrid(); showToast('All data cleared');
  });
}

// ================================================================
// GOOGLE SHEETS SYNC
// ================================================================
// APPROACH: single POST with Content-Type: text/plain
// - text/plain is a "simple" CORS request ‚Äî no preflight needed
// - Apps Script reads the full JSON body from e.postData.contents
// - We still use a GET for the ping/test (no body needed)
// - This avoids URL-length limits that break the GET approach
//   when there are more than a handful of rows
// ================================================================

const SYNC_URL_KEY    = 'gwoc_sheets_url';
const SYNC_LAST_KEY   = 'gwoc_sheets_last_sync';
const SYNC_STATUS_KEY = 'gwoc_sheets_last_status';

const SYNC_MODE_KEY = 'gwoc_sheets_mode';

function saveSyncUrl() {
  localStorage.setItem(SYNC_URL_KEY, document.getElementById('sheetsWebAppUrl').value.trim());
}

function saveSyncMode() {
  const mode = document.getElementById('syncMode').value;
  localStorage.setItem(SYNC_MODE_KEY, mode);
}

function loadSyncUrl() {
  const url  = localStorage.getItem(SYNC_URL_KEY) || '';
  const mode = localStorage.getItem(SYNC_MODE_KEY) || 'append';
  const el   = document.getElementById('sheetsWebAppUrl');
  const sel  = document.getElementById('syncMode');
  if (el)  el.value  = url;
  if (sel) sel.value = mode;
  restoreSyncStatus();
}

function restoreSyncStatus() {
  const last = localStorage.getItem(SYNC_LAST_KEY);
  const st   = localStorage.getItem(SYNC_STATUS_KEY);
  const meta = document.getElementById('syncMeta');
  if (!last) return;
  if (st === 'success') { setSyncStatus('success', '\u2713 Last sync successful'); if (meta) meta.textContent = 'Synced ' + last; }
  else                  { setSyncStatus('error',   '\u2717 Last sync failed');      if (meta) meta.textContent = 'Attempted ' + last; }
}

function setSyncStatus(type, msg) {
  const el = document.getElementById('syncStatus');
  const tx = document.getElementById('syncStatusText');
  if (el) el.className = 'sync-status ' + type;
  if (tx) tx.textContent = msg;
}

function diagnosisHint(msg) {
  if (msg.includes('login') || msg.includes('accounts.google'))
    return 'Script requires login \u2014 redeploy with "Who has access: Anyone"';
  if (msg.includes('404'))
    return 'URL not found \u2014 check you copied the full /exec URL';
  if (msg.includes('not JSON'))
    return 'Try opening the URL directly in your browser to see the raw error';
  return 'Try the Test Connection button first, then check the URL is correct';
}

// ---- Test connection (GET ping) ----
async function testConnection() {
  const url = document.getElementById('sheetsWebAppUrl').value.trim();
  if (!url) { showToast('Paste the Apps Script URL first'); return; }
  if (!url.startsWith('https://script.google.com')) {
    showToast('URL does not look like an Apps Script Web App URL'); return;
  }

  const btn = document.getElementById('testBtn');
  btn.disabled = true;
  setSyncStatus('syncing', 'Testing connection\u2026');
  document.getElementById('syncMeta').textContent = '';

  try {
    const pingUrl = url + (url.includes('?') ? '&' : '?') + 'action=ping';
    const res = await fetch(pingUrl, { method: 'GET', mode: 'cors', redirect: 'follow' });
    const text = await res.text();

    let r;
    try { r = JSON.parse(text); }
    catch(e) {
      if (text.includes('<html') || text.includes('accounts.google'))
        throw new Error('Got a Google login page \u2014 redeploy with "Who has access: Anyone"');
      throw new Error('Response was not JSON: ' + text.slice(0, 100));
    }

    if (r.ok) {
      setSyncStatus('success', '\u2713 Connection OK \u2014 ' + (r.message || 'script is reachable'));
      document.getElementById('syncMeta').textContent = 'Version: ' + (r.version || 'unknown');
      showToast('Connection successful');
    } else {
      throw new Error(r.error || 'Script returned ok:false');
    }
  } catch(err) {
    setSyncStatus('error', '\u2717 ' + err.message);
    document.getElementById('syncMeta').textContent = diagnosisHint(err.message);
    showToast('Connection failed');
  } finally {
    btn.disabled = false;
  }
}

function openScriptUrl() {
  const url = document.getElementById('sheetsWebAppUrl').value.trim();
  if (!url) { showToast('Paste the URL first'); return; }
  window.open(url + '?action=ping', '_blank');
}

// ---- Main sync (POST with text/plain body) ----
async function syncToSheets() {
  const url = document.getElementById('sheetsWebAppUrl').value.trim();
  if (!url) { showToast('Paste your Apps Script Web App URL first'); return; }
  if (!url.startsWith('https://script.google.com')) {
    showToast('URL does not look like a valid Apps Script URL'); return;
  }

  const recs = loadRecords();
  if (!recs.length) { showToast('No timesheet records to sync'); return; }

  // Build flat rows array
  const header = ['Name','Location','Date','Start','End','Break Taken (mins)','Break Required (mins)','Net Hours','Break Violation','Saved At'];
  const dataRows = [];
  recs.forEach(entry => {
    entry.shifts.forEach(s => {
      dataRows.push([
        entry.name,
        s.location || '',
        s.date,
        s.start,
        s.end,
        s.breakMins || 0,
        s.requiredBreak || 0,
        s.netHours ? parseFloat(s.netHours.toFixed(2)) : '',
        s.breakWarning ? 'YES' : 'No',
        entry.savedAt || ''
      ]);
    });
  });

  const btn = document.getElementById('syncBtn');
  btn.disabled = true;
  setSyncStatus('syncing', 'Syncing ' + dataRows.length + ' rows to Google Sheets\u2026');
  document.getElementById('syncMeta').textContent = '';
  const timestamp = new Date().toLocaleString('en-GB');

  try {
    // Send as text/plain POST ‚Äî simple CORS request, no preflight.
    // Apps Script reads this from e.postData.contents in doPost().
    const mode = (localStorage.getItem(SYNC_MODE_KEY) || 'append');
    const body = JSON.stringify({
      action: 'syncTimesheets',
      mode:   mode,
      header: header,
      rows:   dataRows
    });

    const res = await fetch(url, {
      method:   'POST',
      mode:     'cors',
      redirect: 'follow',
      headers:  { 'Content-Type': 'text/plain' },
      body:     body
    });

    const text = await res.text();
    let r;
    try { r = JSON.parse(text); }
    catch(e) {
      if (text.includes('<html') || text.includes('accounts.google'))
        throw new Error('Got a Google login page \u2014 redeploy with "Who has access: Anyone"');
      throw new Error('Response was not JSON: ' + text.slice(0, 120));
    }

    if (!r.ok) throw new Error(r.error || 'Script returned ok:false');

    const modeLabel = mode === 'append' ? 'appended' : 'replaced';
    setSyncStatus('success', '\u2713 ' + dataRows.length + ' row' + (dataRows.length !== 1 ? 's' : '') + ' ' + modeLabel + ' in Google Sheets');
    document.getElementById('syncMeta').textContent = 'Synced (' + mode + ') ' + timestamp;
    localStorage.setItem(SYNC_LAST_KEY, timestamp);
    localStorage.setItem(SYNC_STATUS_KEY, 'success');
    showToast('Sync complete \u2014 ' + dataRows.length + ' rows written');

  } catch(err) {
    setSyncStatus('error', '\u2717 ' + err.message);
    document.getElementById('syncMeta').textContent = diagnosisHint(err.message) + ' \u2014 ' + timestamp;
    localStorage.setItem(SYNC_LAST_KEY, timestamp);
    localStorage.setItem(SYNC_STATUS_KEY, 'error');
    showToast('Sync failed: ' + err.message);
  } finally {
    btn.disabled = false;
  }
}

// Setup guide modal
function showSetupGuide() { document.getElementById('setupGuideModal').classList.add('open'); }
function closeSetupGuide() { document.getElementById('setupGuideModal').classList.remove('open'); }

function openScriptUrl() {
  const url = document.getElementById('sheetsWebAppUrl').value.trim();
  if (!url) { showToast('Paste the URL first'); return; }
  window.open(url + '?action=ping', '_blank');
}

// ================================================================
// UTILITIES
// ================================================================
function dlFile(content,filename,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=filename;a.click();}
function today(){return new Date().toISOString().split('T')[0];}
function resetForm(){document.getElementById('staffName').value='';document.getElementById('shiftRows').innerHTML='';rowId=0;addShiftRow();}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3200);}

// ================================================================
// INIT
// ================================================================
addShiftRow();
renderRecords();
initBadges();
loadSyncUrl();

// Set dashboard default to current month
(()=>{
  const now=new Date();
  document.getElementById('dashFrom').value=new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0];
  document.getElementById('dashTo').value=now.toISOString().split('T')[0];
})();
</script>
</body>
</html>
